var _split;_split=_split||function(undef){var nativeSplit=String.prototype.split,compliantExecNpcg=/()??/.exec("")[1]===undef,self;self=function(str,separator,limit){if(Object.prototype.toString.call(separator)!=="[object RegExp]"){return nativeSplit.call(str,separator,limit)}var output=[],flags=(separator.ignoreCase?"i":"")+(separator.multiline?"m":"")+(separator.extended?"x":"")+(separator.sticky?"y":""),lastLastIndex=0,separator=new RegExp(separator.source,flags+"g"),separator2,match,lastIndex,lastLength;str+="";if(!compliantExecNpcg){separator2=new RegExp("^"+separator.source+"$(?!\\s)",flags)}limit=limit===undef?-1>>>0:limit>>>0;while(match=separator.exec(str)){lastIndex=match.index+match[0].length;if(lastIndex>lastLastIndex){output.push(str.slice(lastLastIndex,match.index));if(!compliantExecNpcg&&match.length>1){match[0].replace(separator2,function(){for(var i=1;i<arguments.length-2;i++){if(arguments[i]===undef){match[i]=undef}}})}if(match.length>1&&match.index<str.length){Array.prototype.push.apply(output,match.slice(1))}lastLength=match[0].length;lastLastIndex=lastIndex;if(output.length>=limit){break}}if(separator.lastIndex===match.index){separator.lastIndex++}}if(lastLastIndex===str.length){if(lastLength||!separator.test("")){output.push("")}}else{output.push(str.slice(lastLastIndex))}return output.length>limit?output.slice(0,limit):output};String.prototype.split=function(separator,limit){return self(this,separator,limit)};return self}();window.gettext=function(s){return s};window.ngettext=function(singular,plural,num){return num==1?singular:plural};function interpolate(fmt,obj,named){if(named){return fmt.replace(/%\(\w+\)s/g,function(match){return String(obj[match.slice(2,-2)])})}else{return fmt.replace(/%s/g,function(match){return String(obj.shift())})}}(function(e){function S(e){throw RangeError(g[e])}function x(e,t){var n=e.length;while(n--)e[n]=t(e[n]);return e}function T(e,t){return x(e.split(m),t).join(".")}function N(e){var t=[],n=0,r=e.length,i,s;while(n<r)i=e.charCodeAt(n++),i>=55296&&i<=56319&&n<r?(s=e.charCodeAt(n++),(s&64512)==56320?t.push(((i&1023)<<10)+(s&1023)+65536):(t.push(i),n--)):t.push(i);return t}function C(e){return x(e,function(e){var t="";return e>65535&&(e-=65536,t+=w(e>>>10&1023|55296),e=56320|e&1023),t+=w(e),t}).join("")}function k(e){return e-48<10?e-22:e-65<26?e-65:e-97<26?e-97:o}function L(e,t){return e+22+75*(e<26)-((t!=0)<<5)}function A(e,t,n){var r=0;e=n?b(e/l):e>>1,e+=b(e/t);for(;e>y*a>>1;r+=o)e=b(e/y);return b(r+(y+1)*e/(e+f))}function O(e){var t=[],n=e.length,r,i=0,f=h,l=c,d,v,m,g,y,w,E,x,T,N;d=e.lastIndexOf(p),d<0&&(d=0);for(v=0;v<d;++v)e.charCodeAt(v)>=128&&S("not-basic"),t.push(e.charCodeAt(v));for(m=d>0?d+1:0;m<n;){for(g=i,y=1,w=o;;w+=o){m>=n&&S("invalid-input"),E=k(e.charCodeAt(m++)),(E>=o||E>b((s-i)/y))&&S("overflow"),i+=E*y,x=w<=l?u:w>=l+a?a:w-l;if(E<x)break;N=o-x,y>b(s/N)&&S("overflow"),y*=N}r=t.length+1,l=A(i-g,r,g==0),b(i/r)>s-f&&S("overflow"),f+=b(i/r),i%=r,t.splice(i++,0,f)}return C(t)}function M(e){var t,n,r,i,f,l,d,v,m,g,y,E=[],x,T,C,k;e=N(e),x=e.length,t=h,n=0,f=c;for(l=0;l<x;++l)y=e[l],y<128&&E.push(w(y));r=i=E.length,i&&E.push(p);while(r<x){for(d=s,l=0;l<x;++l)y=e[l],y>=t&&y<d&&(d=y);T=r+1,d-t>b((s-n)/T)&&S("overflow"),n+=(d-t)*T,t=d;for(l=0;l<x;++l){y=e[l],y<t&&++n>s&&S("overflow");if(y==t){for(v=n,m=o;;m+=o){g=m<=f?u:m>=f+a?a:m-f;if(v<g)break;k=v-g,C=o-g,E.push(w(L(g+k%C,0))),v=b(k/C)}E.push(w(L(v,0))),f=A(n,T,r==i),n=0,++r}}++n,++t}return E.join("")}function _(e){return T(e,function(e){return d.test(e)?O(e.slice(4).toLowerCase()):e})}function D(e){return T(e,function(e){return v.test(e)?"xn--"+M(e):e})}var t=typeof exports=="object"&&exports,n=typeof module=="object"&&module&&module.exports==t&&module,r=typeof global=="object"&&global;if(r.global===r||r.window===r)e=r;var i,s=2147483647,o=36,u=1,a=26,f=38,l=700,c=72,h=128,p="-",d=/^xn--/,v=/[^ -~]/,m=/\x2E|\u3002|\uFF0E|\uFF61/g,g={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},y=o-u,b=Math.floor,w=String.fromCharCode,E;i={version:"1.2.3",ucs2:{decode:N,encode:C},decode:O,encode:M,toASCII:D,toUnicode:_};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd)define("punycode",[],function(){return i});else if(t&&!t.nodeType)if(n)n.exports=i;else for(E in i)i.hasOwnProperty(E)&&(t[E]=i[E]);else e.punycode=i})(this),function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define("IPv6",t):e.IPv6=t(e)}(this,function(e){function n(e){var t=e.toLowerCase(),n=t.split(":"),r=n.length,i=8;n[0]===""&&n[1]===""&&n[2]===""?(n.shift(),n.shift()):n[0]===""&&n[1]===""?n.shift():n[r-1]===""&&n[r-2]===""&&n.pop(),r=n.length,n[r-1].indexOf(".")!==-1&&(i=7);var s;for(s=0;s<r;s++)if(n[s]==="")break;if(s<i){n.splice(s,1,"0000");while(n.length<i)n.splice(s,0,"0000");r=n.length}var o;for(var u=0;u<i;u++){o=n[u].split("");for(var a=0;a<3;a++){if(!(o[0]==="0"&&o.length>1))break;o.splice(0,1)}n[u]=o.join("")}var f=-1,l=0,c=0,h=-1,p=!1;for(u=0;u<i;u++)p?n[u]==="0"?c+=1:(p=!1,c>l&&(f=h,l=c)):n[u]=="0"&&(p=!0,h=u,c=1);c>l&&(f=h,l=c),l>1&&n.splice(f,l,""),r=n.length;var d="";n[0]===""&&(beststr=":");for(u=0;u<r;u++){d+=n[u];if(u===r-1)break;d+=":"}return n[r-1]===""&&(d+=":"),d}function r(){return e.IPv6===this&&(e.IPv6=t),this}var t=e&&e.IPv6;return{best:n,noConflict:r}}),function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define("SecondLevelDomains",t):e.SecondLevelDomains=t(e)}(this,function(e){var t=e&&e.SecondLevelDomains,n=Object.prototype.hasOwnProperty,r={list:{ac:"com|gov|mil|net|org",ae:"ac|co|gov|mil|name|net|org|pro|sch",af:"com|edu|gov|net|org",al:"com|edu|gov|mil|net|org",ao:"co|ed|gv|it|og|pb",ar:"com|edu|gob|gov|int|mil|net|org|tur",at:"ac|co|gv|or",au:"asn|com|csiro|edu|gov|id|net|org",ba:"co|com|edu|gov|mil|net|org|rs|unbi|unmo|unsa|untz|unze",bb:"biz|co|com|edu|gov|info|net|org|store|tv",bh:"biz|cc|com|edu|gov|info|net|org",bn:"com|edu|gov|net|org",bo:"com|edu|gob|gov|int|mil|net|org|tv",br:"adm|adv|agr|am|arq|art|ato|b|bio|blog|bmd|cim|cng|cnt|com|coop|ecn|edu|eng|esp|etc|eti|far|flog|fm|fnd|fot|fst|g12|ggf|gov|imb|ind|inf|jor|jus|lel|mat|med|mil|mus|net|nom|not|ntr|odo|org|ppg|pro|psc|psi|qsl|rec|slg|srv|tmp|trd|tur|tv|vet|vlog|wiki|zlg",bs:"com|edu|gov|net|org",bz:"du|et|om|ov|rg",ca:"ab|bc|mb|nb|nf|nl|ns|nt|nu|on|pe|qc|sk|yk",ck:"biz|co|edu|gen|gov|info|net|org",cn:"ac|ah|bj|com|cq|edu|fj|gd|gov|gs|gx|gz|ha|hb|he|hi|hl|hn|jl|js|jx|ln|mil|net|nm|nx|org|qh|sc|sd|sh|sn|sx|tj|tw|xj|xz|yn|zj",co:"com|edu|gov|mil|net|nom|org",cr:"ac|c|co|ed|fi|go|or|sa",cy:"ac|biz|com|ekloges|gov|ltd|name|net|org|parliament|press|pro|tm","do":"art|com|edu|gob|gov|mil|net|org|sld|web",dz:"art|asso|com|edu|gov|net|org|pol",ec:"com|edu|fin|gov|info|med|mil|net|org|pro",eg:"com|edu|eun|gov|mil|name|net|org|sci",er:"com|edu|gov|ind|mil|net|org|rochest|w",es:"com|edu|gob|nom|org",et:"biz|com|edu|gov|info|name|net|org",fj:"ac|biz|com|info|mil|name|net|org|pro",fk:"ac|co|gov|net|nom|org",fr:"asso|com|f|gouv|nom|prd|presse|tm",gg:"co|net|org",gh:"com|edu|gov|mil|org",gn:"ac|com|gov|net|org",gr:"com|edu|gov|mil|net|org",gt:"com|edu|gob|ind|mil|net|org",gu:"com|edu|gov|net|org",hk:"com|edu|gov|idv|net|org",id:"ac|co|go|mil|net|or|sch|web",il:"ac|co|gov|idf|k12|muni|net|org","in":"ac|co|edu|ernet|firm|gen|gov|i|ind|mil|net|nic|org|res",iq:"com|edu|gov|i|mil|net|org",ir:"ac|co|dnssec|gov|i|id|net|org|sch",it:"edu|gov",je:"co|net|org",jo:"com|edu|gov|mil|name|net|org|sch",jp:"ac|ad|co|ed|go|gr|lg|ne|or",ke:"ac|co|go|info|me|mobi|ne|or|sc",kh:"com|edu|gov|mil|net|org|per",ki:"biz|com|de|edu|gov|info|mob|net|org|tel",km:"asso|com|coop|edu|gouv|k|medecin|mil|nom|notaires|pharmaciens|presse|tm|veterinaire",kn:"edu|gov|net|org",kr:"ac|busan|chungbuk|chungnam|co|daegu|daejeon|es|gangwon|go|gwangju|gyeongbuk|gyeonggi|gyeongnam|hs|incheon|jeju|jeonbuk|jeonnam|k|kg|mil|ms|ne|or|pe|re|sc|seoul|ulsan",kw:"com|edu|gov|net|org",ky:"com|edu|gov|net|org",kz:"com|edu|gov|mil|net|org",lb:"com|edu|gov|net|org",lk:"assn|com|edu|gov|grp|hotel|int|ltd|net|ngo|org|sch|soc|web",lr:"com|edu|gov|net|org",lv:"asn|com|conf|edu|gov|id|mil|net|org",ly:"com|edu|gov|id|med|net|org|plc|sch",ma:"ac|co|gov|m|net|org|press",mc:"asso|tm",me:"ac|co|edu|gov|its|net|org|priv",mg:"com|edu|gov|mil|nom|org|prd|tm",mk:"com|edu|gov|inf|name|net|org|pro",ml:"com|edu|gov|net|org|presse",mn:"edu|gov|org",mo:"com|edu|gov|net|org",mt:"com|edu|gov|net|org",mv:"aero|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro",mw:"ac|co|com|coop|edu|gov|int|museum|net|org",mx:"com|edu|gob|net|org",my:"com|edu|gov|mil|name|net|org|sch",nf:"arts|com|firm|info|net|other|per|rec|store|web",ng:"biz|com|edu|gov|mil|mobi|name|net|org|sch",ni:"ac|co|com|edu|gob|mil|net|nom|org",np:"com|edu|gov|mil|net|org",nr:"biz|com|edu|gov|info|net|org",om:"ac|biz|co|com|edu|gov|med|mil|museum|net|org|pro|sch",pe:"com|edu|gob|mil|net|nom|org|sld",ph:"com|edu|gov|i|mil|net|ngo|org",pk:"biz|com|edu|fam|gob|gok|gon|gop|gos|gov|net|org|web",pl:"art|bialystok|biz|com|edu|gda|gdansk|gorzow|gov|info|katowice|krakow|lodz|lublin|mil|net|ngo|olsztyn|org|poznan|pwr|radom|slupsk|szczecin|torun|warszawa|waw|wroc|wroclaw|zgora",pr:"ac|biz|com|edu|est|gov|info|isla|name|net|org|pro|prof",ps:"com|edu|gov|net|org|plo|sec",pw:"belau|co|ed|go|ne|or",ro:"arts|com|firm|info|nom|nt|org|rec|store|tm|www",rs:"ac|co|edu|gov|in|org",sb:"com|edu|gov|net|org",sc:"com|edu|gov|net|org",sh:"co|com|edu|gov|net|nom|org",sl:"com|edu|gov|net|org",st:"co|com|consulado|edu|embaixada|gov|mil|net|org|principe|saotome|store",sv:"com|edu|gob|org|red",sz:"ac|co|org",tr:"av|bbs|bel|biz|com|dr|edu|gen|gov|info|k12|name|net|org|pol|tel|tsk|tv|web",tt:"aero|biz|cat|co|com|coop|edu|gov|info|int|jobs|mil|mobi|museum|name|net|org|pro|tel|travel",tw:"club|com|ebiz|edu|game|gov|idv|mil|net|org",mu:"ac|co|com|gov|net|or|org",mz:"ac|co|edu|gov|org",na:"co|com",nz:"ac|co|cri|geek|gen|govt|health|iwi|maori|mil|net|org|parliament|school",pa:"abo|ac|com|edu|gob|ing|med|net|nom|org|sld",pt:"com|edu|gov|int|net|nome|org|publ",py:"com|edu|gov|mil|net|org",qa:"com|edu|gov|mil|net|org",re:"asso|com|nom",ru:"ac|adygeya|altai|amur|arkhangelsk|astrakhan|bashkiria|belgorod|bir|bryansk|buryatia|cbg|chel|chelyabinsk|chita|chukotka|chuvashia|com|dagestan|e-burg|edu|gov|grozny|int|irkutsk|ivanovo|izhevsk|jar|joshkar-ola|kalmykia|kaluga|kamchatka|karelia|kazan|kchr|kemerovo|khabarovsk|khakassia|khv|kirov|koenig|komi|kostroma|kranoyarsk|kuban|kurgan|kursk|lipetsk|magadan|mari|mari-el|marine|mil|mordovia|mosreg|msk|murmansk|nalchik|net|nnov|nov|novosibirsk|nsk|omsk|orenburg|org|oryol|penza|perm|pp|pskov|ptz|rnd|ryazan|sakhalin|samara|saratov|simbirsk|smolensk|spb|stavropol|stv|surgut|tambov|tatarstan|tom|tomsk|tsaritsyn|tsk|tula|tuva|tver|tyumen|udm|udmurtia|ulan-ude|vladikavkaz|vladimir|vladivostok|volgograd|vologda|voronezh|vrn|vyatka|yakutia|yamal|yekaterinburg|yuzhno-sakhalinsk",rw:"ac|co|com|edu|gouv|gov|int|mil|net",sa:"com|edu|gov|med|net|org|pub|sch",sd:"com|edu|gov|info|med|net|org|tv",se:"a|ac|b|bd|c|d|e|f|g|h|i|k|l|m|n|o|org|p|parti|pp|press|r|s|t|tm|u|w|x|y|z",sg:"com|edu|gov|idn|net|org|per",sn:"art|com|edu|gouv|org|perso|univ",sy:"com|edu|gov|mil|net|news|org",th:"ac|co|go|in|mi|net|or",tj:"ac|biz|co|com|edu|go|gov|info|int|mil|name|net|nic|org|test|web",tn:"agrinet|com|defense|edunet|ens|fin|gov|ind|info|intl|mincom|nat|net|org|perso|rnrt|rns|rnu|tourism",tz:"ac|co|go|ne|or",ua:"biz|cherkassy|chernigov|chernovtsy|ck|cn|co|com|crimea|cv|dn|dnepropetrovsk|donetsk|dp|edu|gov|if|in|ivano-frankivsk|kh|kharkov|kherson|khmelnitskiy|kiev|kirovograd|km|kr|ks|kv|lg|lugansk|lutsk|lviv|me|mk|net|nikolaev|od|odessa|org|pl|poltava|pp|rovno|rv|sebastopol|sumy|te|ternopil|uzhgorod|vinnica|vn|zaporizhzhe|zhitomir|zp|zt",ug:"ac|co|go|ne|or|org|sc",uk:"ac|bl|british-library|co|cym|gov|govt|icnet|jet|lea|ltd|me|mil|mod|national-library-scotland|nel|net|nhs|nic|nls|org|orgn|parliament|plc|police|sch|scot|soc",us:"dni|fed|isa|kids|nsn",uy:"com|edu|gub|mil|net|org",ve:"co|com|edu|gob|info|mil|net|org|web",vi:"co|com|k12|net|org",vn:"ac|biz|com|edu|gov|health|info|int|name|net|org|pro",ye:"co|com|gov|ltd|me|net|org|plc",yu:"ac|co|edu|gov|org",za:"ac|agric|alt|bourse|city|co|cybernet|db|edu|gov|grondar|iaccess|imt|inca|landesign|law|mil|net|ngo|nis|nom|olivetti|org|pix|school|tm|web",zm:"ac|co|com|edu|gov|net|org|sch"},has_expression:null,is_expression:null,has:function(e){return!!e.match(r.has_expression)},is:function(e){return!!e.match(r.is_expression)},get:function(e){var t=e.match(r.has_expression);return t&&t[1]||null},noConflict:function(){return e.SecondLevelDomains===this&&(e.SecondLevelDomains=t),this},init:function(){var e="";for(var t in r.list){if(!n.call(r.list,t))continue;var i="("+r.list[t]+")."+t;e+="|("+i+")"}r.has_expression=new RegExp("\\.("+e.substr(1)+")$","i"),r.is_expression=new RegExp("^("+e.substr(1)+")$","i")}};return r.init(),r}),function(e,t){typeof exports=="object"?module.exports=t(require("./punycode"),require("./IPv6"),require("./SecondLevelDomains")):typeof define=="function"&&define.amd?define("URI",["./punycode","./IPv6","./SecondLevelDomains"],t):e.URI=t(e.punycode,e.IPv6,e.SecondLevelDomains,e)}(this,function(e,t,n,r){function s(e,t){return this instanceof s?(e===undefined&&(typeof location!="undefined"?e=location.href+"":e=""),this.href(e),t!==undefined?this.absoluteTo(t):this):new s(e,t)}function a(e){return e.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")}function f(e){return e===undefined?"Undefined":String(Object.prototype.toString.call(e)).slice(8,-1)}function l(e){return f(e)==="Array"}function c(e,t){var n={},r,i;if(l(t))for(r=0,i=t.length;r<i;r++)n[t[r]]=!0;else n[t]=!0;for(r=0,i=e.length;r<i;r++)n[e[r]]!==undefined&&(e.splice(r,1),i--,r--);return e}function h(e,t){var n,r;if(l(t)){for(n=0,r=t.length;n<r;n++)if(!h(e,t[n]))return!1;return!0}var i=f(t);for(n=0,r=e.length;n<r;n++)if(i==="RegExp"){if(typeof e[n]=="string"&&e[n].match(t))return!0}else if(e[n]===t)return!0;return!1}function p(e,t){if(!l(e)||!l(t))return!1;if(e.length!==t.length)return!1;e.sort(),t.sort();for(var n=0,r=e.length;n<r;n++)if(e[n]!==t[n])return!1;return!0}function d(e){return escape(e)}function v(e){return encodeURIComponent(e).replace(/[!'()*]/g,d).replace(/\*/g,"%2A")}var i=r&&r.URI,o=s.prototype,u=Object.prototype.hasOwnProperty;s._parts=function(){return{protocol:null,username:null,password:null,hostname:null,urn:null,port:null,path:null,query:null,fragment:null,duplicateQueryParameters:s.duplicateQueryParameters,escapeQuerySpace:s.escapeQuerySpace}},s.duplicateQueryParameters=!1,s.escapeQuerySpace=!0,s.protocol_expression=/^[a-z][a-z0-9-+-]*$/i,s.idn_expression=/[^a-z0-9\.-]/i,s.punycode_expression=/(xn--)/i,s.ip4_expression=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,s.ip6_expression=/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/,s.find_uri_expression=/\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/gi,s.defaultPorts={http:"80",https:"443",ftp:"21",gopher:"70",ws:"80",wss:"443"},s.invalid_hostname_characters=/[^a-zA-Z0-9\.-]/,s.domAttributes={a:"href",blockquote:"cite",link:"href",base:"href",script:"src",form:"action",img:"src",area:"href",iframe:"src",embed:"src",source:"src",track:"src",input:"src"},s.getDomAttribute=function(e){if(!e||!e.nodeName)return undefined;var t=e.nodeName.toLowerCase();return t==="input"&&e.type!=="image"?undefined:s.domAttributes[t]},s.encode=v,s.decode=decodeURIComponent,s.iso8859=function(){s.encode=escape,s.decode=unescape},s.unicode=function(){s.encode=v,s.decode=decodeURIComponent},s.characters={pathname:{encode:{expression:/%(24|26|2B|2C|3B|3D|3A|40)/gi,map:{"%24":"$","%26":"&","%2B":"+","%2C":",","%3B":";","%3D":"=","%3A":":","%40":"@"}},decode:{expression:/[\/\?#]/g,map:{"/":"%2F","?":"%3F","#":"%23"}}},reserved:{encode:{expression:/%(21|23|24|26|27|28|29|2A|2B|2C|2F|3A|3B|3D|3F|40|5B|5D)/gi,map:{"%3A":":","%2F":"/","%3F":"?","%23":"#","%5B":"[","%5D":"]","%40":"@","%21":"!","%24":"$","%26":"&","%27":"'","%28":"(","%29":")","%2A":"*","%2B":"+","%2C":",","%3B":";","%3D":"="}}}},s.encodeQuery=function(e,t){var n=s.encode(e+"");return t?n.replace(/%20/g,"+"):n},s.decodeQuery=function(e,t){e+="";try{return s.decode(t?e.replace(/\+/g,"%20"):e)}catch(n){return e}},s.recodePath=function(e){var t=(e+"").split("/");for(var n=0,r=t.length;n<r;n++)t[n]=s.encodePathSegment(s.decode(t[n]));return t.join("/")},s.decodePath=function(e){var t=(e+"").split("/");for(var n=0,r=t.length;n<r;n++)t[n]=s.decodePathSegment(t[n]);return t.join("/")};var m={encode:"encode",decode:"decode"},g,y=function(e,t){return function(n){return s[t](n+"").replace(s.characters[e][t].expression,function(n){return s.characters[e][t].map[n]})}};for(g in m)s[g+"PathSegment"]=y("pathname",m[g]);s.encodeReserved=y("reserved","encode"),s.parse=function(e,t){var n;return t||(t={}),n=e.indexOf("#"),n>-1&&(t.fragment=e.substring(n+1)||null,e=e.substring(0,n)),n=e.indexOf("?"),n>-1&&(t.query=e.substring(n+1)||null,e=e.substring(0,n)),e.substring(0,2)==="//"?(t.protocol=null,e=e.substring(2),e=s.parseAuthority(e,t)):(n=e.indexOf(":"),n>-1&&(t.protocol=e.substring(0,n)||null,t.protocol&&!t.protocol.match(s.protocol_expression)?t.protocol=undefined:t.protocol==="file"?e=e.substring(n+3):e.substring(n+1,n+3)==="//"?(e=e.substring(n+3),e=s.parseAuthority(e,t)):(e=e.substring(n+1),t.urn=!0))),t.path=e,t},s.parseHost=function(e,t){var n=e.indexOf("/"),r,i;return n===-1&&(n=e.length),e.charAt(0)==="["?(r=e.indexOf("]"),t.hostname=e.substring(1,r)||null,t.port=e.substring(r+2,n)||null):e.indexOf(":")!==e.lastIndexOf(":")?(t.hostname=e.substring(0,n)||null,t.port=null):(i=e.substring(0,n).split(":"),t.hostname=i[0]||null,t.port=i[1]||null),t.hostname&&e.substring(n).charAt(0)!=="/"&&(n++,e="/"+e),e.substring(n)||"/"},s.parseAuthority=function(e,t){return e=s.parseUserinfo(e,t),s.parseHost(e,t)},s.parseUserinfo=function(e,t){var n=e.indexOf("/"),r=n>-1?e.lastIndexOf("@",n):e.indexOf("@"),i;return r>-1&&(n===-1||r<n)?(i=e.substring(0,r).split(":"),t.username=i[0]?s.decode(i[0]):null,i.shift(),t.password=i[0]?s.decode(i.join(":")):null,e=e.substring(r+1)):(t.username=null,t.password=null),e},s.parseQuery=function(e,t){if(!e)return{};e=e.replace(/&+/g,"&").replace(/^\?*&*|&+$/g,"");if(!e)return{};var n={},r=e.split("&"),i=r.length,o,u,a;for(var f=0;f<i;f++)o=r[f].split("="),u=s.decodeQuery(o.shift(),t),a=o.length?s.decodeQuery(o.join("="),t):null,n[u]?(typeof n[u]=="string"&&(n[u]=[n[u]]),n[u].push(a)):n[u]=a;return n},s.build=function(e){var t="";return e.protocol&&(t+=e.protocol+":"),!e.urn&&(t||e.hostname)&&(t+="//"),t+=s.buildAuthority(e)||"",typeof e.path=="string"&&(e.path.charAt(0)!=="/"&&typeof e.hostname=="string"&&(t+="/"),t+=e.path),typeof e.query=="string"&&e.query&&(t+="?"+e.query),typeof e.fragment=="string"&&e.fragment&&(t+="#"+e.fragment),t},s.buildHost=function(e){var t="";return e.hostname?(s.ip6_expression.test(e.hostname)?e.port?t+="["+e.hostname+"]:"+e.port:t+=e.hostname:(t+=e.hostname,e.port&&(t+=":"+e.port)),t):""},s.buildAuthority=function(e){return s.buildUserinfo(e)+s.buildHost(e)},s.buildUserinfo=function(e){var t="";return e.username&&(t+=s.encode(e.username),e.password&&(t+=":"+s.encode(e.password)),t+="@"),t},s.buildQuery=function(e,t,n){var r="",i,o,a,f;for(o in e)if(u.call(e,o)&&o)if(l(e[o])){i={};for(a=0,f=e[o].length;a<f;a++)e[o][a]!==undefined&&i[e[o][a]+""]===undefined&&(r+="&"+s.buildQueryParameter(o,e[o][a],n),t!==!0&&(i[e[o][a]+""]=!0))}else e[o]!==undefined&&(r+="&"+s.buildQueryParameter(o,e[o],n));return r.substring(1)},s.buildQueryParameter=function(e,t,n){return s.encodeQuery(e,n)+(t!==null?"="+s.encodeQuery(t,n):"")},s.addQuery=function(e,t,n){if(typeof t=="object")for(var r in t)u.call(t,r)&&s.addQuery(e,r,t[r]);else{if(typeof t!="string")throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");if(e[t]===undefined){e[t]=n;return}typeof e[t]=="string"&&(e[t]=[e[t]]),l(n)||(n=[n]),e[t]=e[t].concat(n)}},s.removeQuery=function(e,t,n){var r,i,o;if(l(t))for(r=0,i=t.length;r<i;r++)e[t[r]]=undefined;else if(typeof t=="object")for(o in t)u.call(t,o)&&s.removeQuery(e,o,t[o]);else{if(typeof t!="string")throw new TypeError("URI.addQuery() accepts an object, string as the first parameter");n!==undefined?e[t]===n?e[t]=undefined:l(e[t])&&(e[t]=c(e[t],n)):e[t]=undefined}},s.hasQuery=function(e,t,n,r){if(typeof t=="object"){for(var i in t)if(u.call(t,i)&&!s.hasQuery(e,i,t[i]))return!1;return!0}if(typeof t!="string")throw new TypeError("URI.hasQuery() accepts an object, string as the name parameter");switch(f(n)){case"Undefined":return t in e;case"Boolean":var o=Boolean(l(e[t])?e[t].length:e[t]);return n===o;case"Function":return!!n(e[t],t,e);case"Array":if(!l(e[t]))return!1;var a=r?h:p;return a(e[t],n);case"RegExp":if(!l(e[t]))return Boolean(e[t]&&e[t].match(n));if(!r)return!1;return h(e[t],n);case"Number":n=String(n);case"String":if(!l(e[t]))return e[t]===n;if(!r)return!1;return h(e[t],n);default:throw new TypeError("URI.hasQuery() accepts undefined, boolean, string, number, RegExp, Function as the value parameter")}},s.commonPath=function(e,t){var n=Math.min(e.length,t.length),r;for(r=0;r<n;r++)if(e.charAt(r)!==t.charAt(r)){r--;break}if(r<1)return e.charAt(0)===t.charAt(0)&&e.charAt(0)==="/"?"/":"";if(e.charAt(r)!=="/"||t.charAt(r)!=="/")r=e.substring(0,r).lastIndexOf("/");return e.substring(0,r+1)},s.withinString=function(e,t){return e.replace(s.find_uri_expression,t)},s.ensureValidHostname=function(t){if(t.match(s.invalid_hostname_characters)){if(!e)throw new TypeError("Hostname '"+t+"' contains characters other than [A-Z0-9.-] and Punycode.js is not available");if(e.toASCII(t).match(s.invalid_hostname_characters))throw new TypeError("Hostname '"+t+"' contains characters other than [A-Z0-9.-]")}},s.noConflict=function(e){if(e){var n={URI:this.noConflict()};return URITemplate&&typeof URITemplate.noConflict=="function"&&(n.URITemplate=URITemplate.noConflict()),t&&typeof t.noConflict=="function"&&(n.IPv6=t.noConflict()),SecondLevelDomains&&typeof SecondLevelDomains.noConflict=="function"&&(n.SecondLevelDomains=SecondLevelDomains.noConflict()),n}return r.URI===this&&(r.URI=i),this},o.build=function(e){if(e===!0)this._deferred_build=!0;else if(e===undefined||this._deferred_build)this._string=s.build(this._parts),this._deferred_build=!1;return this},o.clone=function(){return new s(this)},o.valueOf=o.toString=function(){return this.build(!1)._string},m={protocol:"protocol",username:"username",password:"password",hostname:"hostname",port:"port"},y=function(e){return function(t,n){return t===undefined?this._parts[e]||"":(this._parts[e]=t||null,this.build(!n),this)}};for(g in m)o[g]=y(m[g]);m={query:"?",fragment:"#"},y=function(e,t){return function(n,r){return n===undefined?this._parts[e]||"":(n!==null&&(n+="",n.charAt(0)===t&&(n=n.substring(1))),this._parts[e]=n,this.build(!r),this)}};for(g in m)o[g]=y(g,m[g]);m={search:["?","query"],hash:["#","fragment"]},y=function(e,t){return function(n,r){var i=this[e](n,r);return typeof i=="string"&&i.length?t+i:i}};for(g in m)o[g]=y(m[g][1],m[g][0]);o.pathname=function(e,t){if(e===undefined||e===!0){var n=this._parts.path||(this._parts.hostname?"/":"");return e?s.decodePath(n):n}return this._parts.path=e?s.recodePath(e):"/",this.build(!t),this},o.path=o.pathname,o.href=function(e,t){var n;if(e===undefined)return this.toString();this._string="",this._parts=s._parts();var r=e instanceof s,i=typeof e=="object"&&(e.hostname||e.path||e.pathname);if(e.nodeName){var o=s.getDomAttribute(e);e=e[o]||"",i=!1}!r&&i&&e.pathname!==undefined&&(e=e.toString());if(typeof e=="string")this._parts=s.parse(e,this._parts);else{if(!r&&!i)throw new TypeError("invalid input");var a=r?e._parts:e;for(n in a)u.call(this._parts,n)&&(this._parts[n]=a[n])}return this.build(!t),this},o.is=function(e){var t=!1,r=!1,i=!1,o=!1,u=!1,a=!1,f=!1,l=!this._parts.urn;this._parts.hostname&&(l=!1,r=s.ip4_expression.test(this._parts.hostname),i=s.ip6_expression.test(this._parts.hostname),t=r||i,o=!t,u=o&&n&&n.has(this._parts.hostname),a=o&&s.idn_expression.test(this._parts.hostname),f=o&&s.punycode_expression.test(this._parts.hostname));switch(e.toLowerCase()){case"relative":return l;case"absolute":return!l;case"domain":case"name":return o;case"sld":return u;case"ip":return t;case"ip4":case"ipv4":case"inet4":return r;case"ip6":case"ipv6":case"inet6":return i;case"idn":return a;case"url":return!this._parts.urn;case"urn":return!!this._parts.urn;case"punycode":return f}return null};var b=o.protocol,w=o.port,E=o.hostname;o.protocol=function(e,t){if(e!==undefined&&e){e=e.replace(/:(\/\/)?$/,"");if(e.match(/[^a-zA-z0-9\.+-]/))throw new TypeError("Protocol '"+e+"' contains characters other than [A-Z0-9.+-]")}return b.call(this,e,t)},o.scheme=o.protocol,o.port=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e!==undefined){e===0&&(e=null);if(e){e+="",e.charAt(0)===":"&&(e=e.substring(1));if(e.match(/[^0-9]/))throw new TypeError("Port '"+e+"' contains characters other than [0-9]")}}return w.call(this,e,t)},o.hostname=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e!==undefined){var n={};s.parseHost(e,n),e=n.hostname}return E.call(this,e,t)},o.host=function(e,t){return this._parts.urn?e===undefined?"":this:e===undefined?this._parts.hostname?s.buildHost(this._parts):"":(s.parseHost(e,this._parts),this.build(!t),this)},o.authority=function(e,t){return this._parts.urn?e===undefined?"":this:e===undefined?this._parts.hostname?s.buildAuthority(this._parts):"":(s.parseAuthority(e,this._parts),this.build(!t),this)},o.userinfo=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined){if(!this._parts.username)return"";var n=s.buildUserinfo(this._parts);return n.substring(0,n.length-1)}return e[e.length-1]!=="@"&&(e+="@"),s.parseUserinfo(e,this._parts),this.build(!t),this},o.resource=function(e,t){var n;return e===undefined?this.path()+this.search()+this.hash():(n=s.parse(e),this._parts.path=n.path,this._parts.query=n.query,this._parts.fragment=n.fragment,this.build(!t),this)},o.subdomain=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined){if(!this._parts.hostname||this.is("IP"))return"";var n=this._parts.hostname.length-this.domain().length-1;return this._parts.hostname.substring(0,n)||""}var r=this._parts.hostname.length-this.domain().length,i=this._parts.hostname.substring(0,r),o=new RegExp("^"+a(i));return e&&e.charAt(e.length-1)!=="."&&(e+="."),e&&s.ensureValidHostname(e),this._parts.hostname=this._parts.hostname.replace(o,e),this.build(!t),this},o.domain=function(e,t){if(this._parts.urn)return e===undefined?"":this;typeof e=="boolean"&&(t=e,e=undefined);if(e===undefined){if(!this._parts.hostname||this.is("IP"))return"";var n=this._parts.hostname.match(/\./g);if(n&&n.length<2)return this._parts.hostname;var r=this._parts.hostname.length-this.tld(t).length-1;return r=this._parts.hostname.lastIndexOf(".",r-1)+1,this._parts.hostname.substring(r)||""}if(!e)throw new TypeError("cannot set domain empty");s.ensureValidHostname(e);if(!this._parts.hostname||this.is("IP"))this._parts.hostname=e;else{var i=new RegExp(a(this.domain())+"$");this._parts.hostname=this._parts.hostname.replace(i,e)}return this.build(!t),this},o.tld=function(e,t){if(this._parts.urn)return e===undefined?"":this;typeof e=="boolean"&&(t=e,e=undefined);if(e===undefined){if(!this._parts.hostname||this.is("IP"))return"";var r=this._parts.hostname.lastIndexOf("."),i=this._parts.hostname.substring(r+1);return t!==!0&&n&&n.list[i.toLowerCase()]?n.get(this._parts.hostname)||i:i}var s;if(!e)throw new TypeError("cannot set TLD empty");if(e.match(/[^a-zA-Z0-9-]/)){if(!n||!n.is(e))throw new TypeError("TLD '"+e+"' contains characters other than [A-Z0-9]");s=new RegExp(a(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(s,e)}else{if(!this._parts.hostname||this.is("IP"))throw new ReferenceError("cannot set TLD on non-domain host");s=new RegExp(a(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(s,e)}return this.build(!t),this},o.directory=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined||e===!0){if(!this._parts.path&&!this._parts.hostname)return"";if(this._parts.path==="/")return"/";var n=this._parts.path.length-this.filename().length-1,r=this._parts.path.substring(0,n)||(this._parts.hostname?"/":"");return e?s.decodePath(r):r}var i=this._parts.path.length-this.filename().length,o=this._parts.path.substring(0,i),u=new RegExp("^"+a(o));return this.is("relative")||(e||(e="/"),e.charAt(0)!=="/"&&(e="/"+e)),e&&e.charAt(e.length-1)!=="/"&&(e+="/"),e=s.recodePath(e),this._parts.path=this._parts.path.replace(u,e),this.build(!t),this},o.filename=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined||e===!0){if(!this._parts.path||this._parts.path==="/")return"";var n=this._parts.path.lastIndexOf("/"),r=this._parts.path.substring(n+1);return e?s.decodePathSegment(r):r}var i=!1;e.charAt(0)==="/"&&(e=e.substring(1)),e.match(/\.?\//)&&(i=!0);var o=new RegExp(a(this.filename())+"$");return e=s.recodePath(e),this._parts.path=this._parts.path.replace(o,e),i?this.normalizePath(t):this.build(!t),this},o.suffix=function(e,t){if(this._parts.urn)return e===undefined?"":this;if(e===undefined||e===!0){if(!this._parts.path||this._parts.path==="/")return"";var n=this.filename(),r=n.lastIndexOf("."),i,o;return r===-1?"":(i=n.substring(r+1),o=/^[a-z0-9%]+$/i.test(i)?i:"",e?s.decodePathSegment(o):o)}e.charAt(0)==="."&&(e=e.substring(1));var u=this.suffix(),f;if(!u){if(!e)return this;this._parts.path+="."+s.recodePath(e)}else e?f=new RegExp(a(u)+"$"):f=new RegExp(a("."+u)+"$");return f&&(e=s.recodePath(e),this._parts.path=this._parts.path.replace(f,e)),this.build(!t),this},o.segment=function(e,t,n){var r=this._parts.urn?":":"/",i=this.path(),s=i.substring(0,1)==="/",o=i.split(r);e!==undefined&&typeof e!="number"&&(n=t,t=e,e=undefined);if(e!==undefined&&typeof e!="number")throw new Error("Bad segment '"+e+"', must be 0-based integer");s&&o.shift(),e<0&&(e=Math.max(o.length+e,0));if(t===undefined)return e===undefined?o:o[e];if(e===null||o[e]===undefined){if(l(t)){o=[];for(var u=0,a=t.length;u<a;u++){if(!t[u].length&&(!o.length||!o[o.length-1].length))continue;o.length&&!o[o.length-1].length&&o.pop(),o.push(t[u])}}else if(t||typeof t=="string")o[o.length-1]===""?o[o.length-1]=t:o.push(t)}else t||typeof t=="string"&&t.length?o[e]=t:o.splice(e,1);return s&&o.unshift(""),this.path(o.join(r),n)},o.segmentCoded=function(e,t,n){var r,i,o;typeof e!="number"&&(n=t,t=e,e=undefined);if(t===undefined){r=this.segment(e,t,n);if(!l(r))r=r!==undefined?s.decode(r):undefined;else for(i=0,o=r.length;i<o;i++)r[i]=s.decode(r[i]);
return r}if(!l(t))t=typeof t=="string"?s.encode(t):t;else for(i=0,o=t.length;i<o;i++)t[i]=s.decode(t[i]);return this.segment(e,t,n)};var S=o.query;return o.query=function(e,t){if(e===!0)return s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);if(typeof e=="function"){var n=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace),r=e.call(this,n);return this._parts.query=s.buildQuery(r||n,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),this.build(!t),this}return e!==undefined&&typeof e!="string"?(this._parts.query=s.buildQuery(e,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),this.build(!t),this):S.call(this,e,t)},o.setQuery=function(e,t,n){var r=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);if(typeof e=="object")for(var i in e)u.call(e,i)&&(r[i]=e[i]);else{if(typeof e!="string")throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");r[e]=t!==undefined?t:null}return this._parts.query=s.buildQuery(r,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof e!="string"&&(n=t),this.build(!n),this},o.addQuery=function(e,t,n){var r=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return s.addQuery(r,e,t===undefined?null:t),this._parts.query=s.buildQuery(r,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof e!="string"&&(n=t),this.build(!n),this},o.removeQuery=function(e,t,n){var r=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return s.removeQuery(r,e,t),this._parts.query=s.buildQuery(r,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof e!="string"&&(n=t),this.build(!n),this},o.hasQuery=function(e,t,n){var r=s.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return s.hasQuery(r,e,t,n)},o.setSearch=o.setQuery,o.addSearch=o.addQuery,o.removeSearch=o.removeQuery,o.hasSearch=o.hasQuery,o.normalize=function(){return this._parts.urn?this.normalizeProtocol(!1).normalizeQuery(!1).normalizeFragment(!1).build():this.normalizeProtocol(!1).normalizeHostname(!1).normalizePort(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build()},o.normalizeProtocol=function(e){return typeof this._parts.protocol=="string"&&(this._parts.protocol=this._parts.protocol.toLowerCase(),this.build(!e)),this},o.normalizeHostname=function(n){return this._parts.hostname&&(this.is("IDN")&&e?this._parts.hostname=e.toASCII(this._parts.hostname):this.is("IPv6")&&t&&(this._parts.hostname=t.best(this._parts.hostname)),this._parts.hostname=this._parts.hostname.toLowerCase(),this.build(!n)),this},o.normalizePort=function(e){return typeof this._parts.protocol=="string"&&this._parts.port===s.defaultPorts[this._parts.protocol]&&(this._parts.port=null,this.build(!e)),this},o.normalizePath=function(e){if(this._parts.urn)return this;if(!this._parts.path||this._parts.path==="/")return this;var t,n=this._parts.path,r,i;n.charAt(0)!=="/"&&(t=!0,n="/"+n),n=n.replace(/(\/(\.\/)+)|(\/\.$)/g,"/").replace(/\/{2,}/g,"/");for(;;){r=n.indexOf("/../");if(r===-1)break;if(r===0){n=n.substring(3);break}i=n.substring(0,r).lastIndexOf("/"),i===-1&&(i=r),n=n.substring(0,i)+n.substring(r+3)}return t&&this.is("relative")&&(n=n.substring(1)),n=s.recodePath(n),this._parts.path=n,this.build(!e),this},o.normalizePathname=o.normalizePath,o.normalizeQuery=function(e){return typeof this._parts.query=="string"&&(this._parts.query.length?this.query(s.parseQuery(this._parts.query,this._parts.escapeQuerySpace)):this._parts.query=null,this.build(!e)),this},o.normalizeFragment=function(e){return this._parts.fragment||(this._parts.fragment=null,this.build(!e)),this},o.normalizeSearch=o.normalizeQuery,o.normalizeHash=o.normalizeFragment,o.iso8859=function(){var e=s.encode,t=s.decode;return s.encode=escape,s.decode=decodeURIComponent,this.normalize(),s.encode=e,s.decode=t,this},o.unicode=function(){var e=s.encode,t=s.decode;return s.encode=v,s.decode=unescape,this.normalize(),s.encode=e,s.decode=t,this},o.readable=function(){var t=this.clone();t.username("").password("").normalize();var n="";t._parts.protocol&&(n+=t._parts.protocol+"://"),t._parts.hostname&&(t.is("punycode")&&e?(n+=e.toUnicode(t._parts.hostname),t._parts.port&&(n+=":"+t._parts.port)):n+=t.host()),t._parts.hostname&&t._parts.path&&t._parts.path.charAt(0)!=="/"&&(n+="/"),n+=t.path(!0);if(t._parts.query){var r="";for(var i=0,o=t._parts.query.split("&"),u=o.length;i<u;i++){var a=(o[i]||"").split("=");r+="&"+s.decodeQuery(a[0],this._parts.escapeQuerySpace).replace(/&/g,"%26"),a[1]!==undefined&&(r+="="+s.decodeQuery(a[1],this._parts.escapeQuerySpace).replace(/&/g,"%26"))}n+="?"+r.substring(1)}return n+=s.decodeQuery(t.hash(),!0),n},o.absoluteTo=function(e){var t=this.clone(),n=["protocol","username","password","hostname","port"],r,i,o;if(this._parts.urn)throw new Error("URNs do not have any generally defined hierarchical components");e instanceof s||(e=new s(e)),t._parts.protocol||(t._parts.protocol=e._parts.protocol);if(this._parts.hostname)return t;for(i=0;o=n[i];i++)t._parts[o]=e._parts[o];n=["query","path"];for(i=0;o=n[i];i++)!t._parts[o]&&e._parts[o]&&(t._parts[o]=e._parts[o]);return t.path().charAt(0)!=="/"&&(r=e.directory(),t._parts.path=(r?r+"/":"")+t._parts.path,t.normalizePath()),t.build(),t},o.relativeTo=function(e){var t=this.clone().normalize(),n,r,i,o,u;if(t._parts.urn)throw new Error("URNs do not have any generally defined hierarchical components");e=new s(e).normalize(),n=t._parts,r=e._parts,o=t.path(),u=e.path();if(o.charAt(0)!=="/")throw new Error("URI is already relative");if(u.charAt(0)!=="/")throw new Error("Cannot calculate a URI relative to another relative URI");n.protocol===r.protocol&&(n.protocol=null);if(n.username!==r.username||n.password!==r.password)return t.build();if(n.protocol!==null||n.username!==null||n.password!==null)return t.build();if(n.hostname!==r.hostname||n.port!==r.port)return t.build();n.hostname=null,n.port=null;if(o===u)return n.path="",t.build();i=s.commonPath(t.path(),e.path());if(!i)return t.build();var a=r.path.substring(i.length).replace(/[^\/]*$/,"").replace(/.*?\//g,"../");return n.path=a+n.path.substring(i.length),t.build()},o.equals=function(e){var t=this.clone(),n=new s(e),r={},i={},o={},a,f,c;t.normalize(),n.normalize();if(t.toString()===n.toString())return!0;a=t.query(),f=n.query(),t.query(""),n.query("");if(t.toString()!==n.toString())return!1;if(a.length!==f.length)return!1;r=s.parseQuery(a,this._parts.escapeQuerySpace),i=s.parseQuery(f,this._parts.escapeQuerySpace);for(c in r)if(u.call(r,c)){if(!l(r[c])){if(r[c]!==i[c])return!1}else if(!p(r[c],i[c]))return!1;o[c]=!0}for(c in i)if(u.call(i,c)&&!o[c])return!1;return!0},o.duplicateQueryParameters=function(e){return this._parts.duplicateQueryParameters=!!e,this},o.escapeQuerySpace=function(e){return this._parts.escapeQuerySpace=!!e,this},s});(function($){$.fn.extend({leanModal:function(options){var defaults={top:100,overlay:.5,closeButton:null};var overlay=$("<div id='lean_overlay'></div>");$("body").append(overlay);options=$.extend(defaults,options);return this.each(function(){var o=options;$(this).click(function(e){var modal_id=$(this).attr("href");$("#lean_overlay").click(function(){close_modal(modal_id)});$(o.closeButton).click(function(){close_modal(modal_id)});var modal_height=$(modal_id).outerHeight();var modal_width=$(modal_id).outerWidth();$("#lean_overlay").css({display:"block",opacity:0});$("#lean_overlay").fadeTo(200,o.overlay);$(modal_id).css({display:"block",position:"fixed",opacity:0,"z-index":11e3,left:50+"%","margin-left":-(modal_width/2)+"px",top:o.top+"px"});$(modal_id).fadeTo(200,1);e.preventDefault()})});function close_modal(modal_id){$("#lean_overlay").fadeOut(200);$(modal_id).css({display:"none"})}}})})(jQuery);(function($){$.timeago=function(timestamp){if(timestamp instanceof Date){return inWords(timestamp)}else if(typeof timestamp==="string"){return inWords($.timeago.parse(timestamp))}else if(typeof timestamp==="number"){return inWords(new Date(timestamp))}else{return inWords($.timeago.datetime(timestamp))}};var $t=$.timeago;$.extend($.timeago,{settings:{refreshMillis:6e4,allowFuture:false,strings:{formatAgo:"%s ago",formatFromNow:"%s from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years",numbers:[]}},inWords:function(distanceMillis){var $l=this.settings.strings;var format=$l.formatAgo;if(this.settings.allowFuture){if(distanceMillis<0){format=$l.formatFromNow}}var seconds=Math.abs(distanceMillis)/1e3;var minutes=seconds/60;var hours=minutes/60;var days=hours/24;var years=days/365;function substitute(stringOrFunction,number){var string=$.isFunction(stringOrFunction)?stringOrFunction(number,distanceMillis):stringOrFunction;var value=$l.numbers&&$l.numbers[number]||number;return string.replace(/%d/i,value)}var words=seconds<45&&substitute($l.seconds,Math.round(seconds))||seconds<90&&substitute($l.minute,1)||minutes<45&&substitute($l.minutes,Math.round(minutes))||minutes<90&&substitute($l.hour,1)||hours<24&&substitute($l.hours,Math.round(hours))||hours<42&&substitute($l.day,1)||days<30&&substitute($l.days,Math.round(days))||days<45&&substitute($l.month,1)||days<365&&substitute($l.months,Math.round(days/30))||years<1.5&&substitute($l.year,1)||substitute($l.years,Math.round(years));return $.trim(format.replace(/%s/i,words))},parse:function(iso8601){var s=$.trim(iso8601);s=s.replace(/\.\d+/,"");s=s.replace(/-/,"/").replace(/-/,"/");s=s.replace(/T/," ").replace(/Z/," UTC");s=s.replace(/([\+\-]\d\d)\:?(\d\d)/," $1$2");return new Date(s)},datetime:function(elem){var iso8601=$t.isTime(elem)?$(elem).attr("datetime"):$(elem).attr("title");return $t.parse(iso8601)},isTime:function(elem){return $(elem).get(0).tagName.toLowerCase()==="time"}});$.fn.timeago=function(){var self=this;self.each(refresh);var $s=$t.settings;if($s.refreshMillis>0){setInterval(function(){self.each(refresh)},$s.refreshMillis)}return self};function refresh(){var data=prepareData(this);if(!isNaN(data.datetime)){$(this).text(inWords(data.datetime))}return this}function prepareData(element){element=$(element);if(!element.data("timeago")){element.data("timeago",{datetime:$t.datetime(element)});var text=$.trim(element.text());if(text.length>0&&!($t.isTime(element)&&element.attr("title"))){element.attr("title",text)}}return element.data("timeago")}function inWords(date){return $t.inWords(distance(date))}function distance(date){return(new Date).getTime()-date.getTime()}document.createElement("abbr");document.createElement("time")})(jQuery);(function(){var root=this;var previousUnderscore=root._;var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.7.0";var createCallback=function(func,context,argCount){if(context===void 0)return func;switch(argCount==null?3:argCount){case 1:return function(value){return func.call(context,value)};case 2:return function(value,other){return func.call(context,value,other)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}};_.iteratee=function(value,context,argCount){if(value==null)return _.identity;if(_.isFunction(value))return createCallback(value,context,argCount);if(_.isObject(value))return _.matches(value);return _.property(value)};_.each=_.forEach=function(obj,iteratee,context){if(obj==null)return obj;iteratee=createCallback(iteratee,context);var i,length=obj.length;if(length===+length){for(i=0;i<length;i++){iteratee(obj[i],i,obj)}}else{var keys=_.keys(obj);for(i=0,length=keys.length;i<length;i++){iteratee(obj[keys[i]],keys[i],obj)}}return obj};_.map=_.collect=function(obj,iteratee,context){if(obj==null)return[];iteratee=_.iteratee(iteratee,context);var keys=obj.length!==+obj.length&&_.keys(obj),length=(keys||obj).length,results=Array(length),currentKey;for(var index=0;index<length;index++){currentKey=keys?keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iteratee,memo,context){if(obj==null)obj=[];iteratee=createCallback(iteratee,context,4);var keys=obj.length!==+obj.length&&_.keys(obj),length=(keys||obj).length,index=0,currentKey;if(arguments.length<3){if(!length)throw new TypeError(reduceError);memo=obj[keys?keys[index++]:index++]}for(;index<length;index++){currentKey=keys?keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo};_.reduceRight=_.foldr=function(obj,iteratee,memo,context){if(obj==null)obj=[];iteratee=createCallback(iteratee,context,4);var keys=obj.length!==+obj.length&&_.keys(obj),index=(keys||obj).length,currentKey;if(arguments.length<3){if(!index)throw new TypeError(reduceError);memo=obj[keys?keys[--index]:--index]}while(index--){currentKey=keys?keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo};_.find=_.detect=function(obj,predicate,context){var result;predicate=_.iteratee(predicate,context);_.some(obj,function(value,index,list){if(predicate(value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,predicate,context){var results=[];if(obj==null)return results;predicate=_.iteratee(predicate,context);_.each(obj,function(value,index,list){if(predicate(value,index,list))results.push(value)});return results};_.reject=function(obj,predicate,context){return _.filter(obj,_.negate(_.iteratee(predicate)),context)};_.every=_.all=function(obj,predicate,context){if(obj==null)return true;predicate=_.iteratee(predicate,context);var keys=obj.length!==+obj.length&&_.keys(obj),length=(keys||obj).length,index,currentKey;for(index=0;index<length;index++){currentKey=keys?keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return false}return true};_.some=_.any=function(obj,predicate,context){if(obj==null)return false;predicate=_.iteratee(predicate,context);var keys=obj.length!==+obj.length&&_.keys(obj),length=(keys||obj).length,index,currentKey;for(index=0;index<length;index++){currentKey=keys?keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return true}return false};_.contains=_.include=function(obj,target){if(obj==null)return false;if(obj.length!==+obj.length)obj=_.values(obj);return _.indexOf(obj,target)>=0};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,_.property(key))};_.where=function(obj,attrs){return _.filter(obj,_.matches(attrs))};_.findWhere=function(obj,attrs){return _.find(obj,_.matches(attrs))};_.max=function(obj,iteratee,context){var result=-Infinity,lastComputed=-Infinity,value,computed;if(iteratee==null&&obj!=null){obj=obj.length===+obj.length?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value>result){result=value}}}else{iteratee=_.iteratee(iteratee,context);_.each(obj,function(value,index,list){computed=iteratee(value,index,list);if(computed>lastComputed||computed===-Infinity&&result===-Infinity){result=value;lastComputed=computed}})}return result};_.min=function(obj,iteratee,context){var result=Infinity,lastComputed=Infinity,value,computed;if(iteratee==null&&obj!=null){obj=obj.length===+obj.length?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value<result){result=value}}}else{iteratee=_.iteratee(iteratee,context);_.each(obj,function(value,index,list){computed=iteratee(value,index,list);if(computed<lastComputed||computed===Infinity&&result===Infinity){result=value;lastComputed=computed}})}return result};_.shuffle=function(obj){var set=obj&&obj.length===+obj.length?obj:_.values(obj);var length=set.length;var shuffled=Array(length);for(var index=0,rand;index<length;index++){rand=_.random(0,index);if(rand!==index)shuffled[index]=shuffled[rand];shuffled[rand]=set[index]}return shuffled};_.sample=function(obj,n,guard){if(n==null||guard){if(obj.length!==+obj.length)obj=_.values(obj);return obj[_.random(obj.length-1)]}return _.shuffle(obj).slice(0,Math.max(0,n))};_.sortBy=function(obj,iteratee,context){iteratee=_.iteratee(iteratee,context);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iteratee(value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iteratee,context){var result={};iteratee=_.iteratee(iteratee,context);_.each(obj,function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)});return result}};_.groupBy=group(function(result,value,key){if(_.has(result,key))result[key].push(value);else result[key]=[value]});_.indexBy=group(function(result,value,key){result[key]=value});_.countBy=group(function(result,value,key){if(_.has(result,key))result[key]++;else result[key]=1});_.sortedIndex=function(array,obj,iteratee,context){iteratee=_.iteratee(iteratee,context,1);var value=iteratee(obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;if(iteratee(array[mid])<value)low=mid+1;else high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return obj.length===+obj.length?obj.length:_.keys(obj).length};_.partition=function(obj,predicate,context){predicate=_.iteratee(predicate,context);var pass=[],fail=[];_.each(obj,function(value,key,obj){(predicate(value,key,obj)?pass:fail).push(value)});return[pass,fail]};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[0];if(n<0)return[];return slice.call(array,0,n)};_.initial=function(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(n==null||guard?1:n)))};_.last=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[array.length-1];return slice.call(array,Math.max(array.length-n,0))};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,strict,output){if(shallow&&_.every(input,_.isArray)){return concat.apply(output,input)}for(var i=0,length=input.length;i<length;i++){var value=input[i];if(!_.isArray(value)&&!_.isArguments(value)){if(!strict)output.push(value)}else if(shallow){push.apply(output,value)}else{flatten(value,shallow,strict,output)}}return output};_.flatten=function(array,shallow){return flatten(array,shallow,false,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iteratee,context){if(array==null)return[];if(!_.isBoolean(isSorted)){context=iteratee;iteratee=isSorted;isSorted=false}if(iteratee!=null)iteratee=_.iteratee(iteratee,context);var result=[];var seen=[];for(var i=0,length=array.length;i<length;i++){var value=array[i];if(isSorted){if(!i||seen!==value)result.push(value);seen=value}else if(iteratee){var computed=iteratee(value,i,array);if(_.indexOf(seen,computed)<0){seen.push(computed);result.push(value)}}else if(_.indexOf(result,value)<0){result.push(value)}}return result};_.union=function(){return _.uniq(flatten(arguments,true,true,[]))};_.intersection=function(array){if(array==null)return[];var result=[];var argsLength=arguments.length;for(var i=0,length=array.length;i<length;i++){var item=array[i];if(_.contains(result,item))continue;for(var j=1;j<argsLength;j++){if(!_.contains(arguments[j],item))break}if(j===argsLength)result.push(item)}return result};_.difference=function(array){var rest=flatten(slice.call(arguments,1),true,true,[]);return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(array){if(array==null)return[];var length=_.max(arguments,"length").length;var results=Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(arguments,i)}return results};_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,length=list.length;i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,length=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,length+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}for(;i<length;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var idx=array.length;if(typeof from=="number"){idx=from<0?idx+from+1:Math.min(idx,from+1)}while(--idx>=0)if(array[idx]===item)return idx;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=step||1;var length=Math.max(Math.ceil((stop-start)/step),0);var range=Array(length);for(var idx=0;idx<length;idx++,start+=step){range[idx]=start}return range};var Ctor=function(){};_.bind=function(func,context){var args,bound;if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError("Bind must be called on a function");args=slice.call(arguments,2);bound=function(){if(!(this instanceof bound))return func.apply(context,args.concat(slice.call(arguments)));Ctor.prototype=func.prototype;var self=new Ctor;Ctor.prototype=null;var result=func.apply(self,args.concat(slice.call(arguments)));if(_.isObject(result))return result;return self};return bound};_.partial=function(func){var boundArgs=slice.call(arguments,1);return function(){var position=0;var args=boundArgs.slice();for(var i=0,length=args.length;i<length;i++){if(args[i]===_)args[i]=arguments[position++]}while(position<arguments.length)args.push(arguments[position++]);return func.apply(this,args)}};_.bindAll=function(obj){var i,length=arguments.length,key;if(length<=1)throw new Error("bindAll must be passed function names");for(i=1;i<length;i++){key=arguments[i];obj[key]=_.bind(obj[key],obj)}return obj};_.memoize=function(func,hasher){var memoize=function(key){var cache=memoize.cache;var address=hasher?hasher.apply(this,arguments):key;if(!_.has(cache,address))cache[address]=func.apply(this,arguments);return cache[address]};memoize.cache={};return memoize};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait,options){var context,args,result;var timeout=null;var previous=0;if(!options)options={};var later=function(){previous=options.leading===false?0:_.now();timeout=null;result=func.apply(context,args);if(!timeout)context=args=null};return function(){var now=_.now();if(!previous&&options.leading===false)previous=now;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0||remaining>wait){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args);if(!timeout)context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result;var later=function(){var last=_.now()-timestamp;if(last<wait&&last>0){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate){result=func.apply(context,args);if(!timeout)context=args=null}}};return function(){context=this;args=arguments;timestamp=_.now();var callNow=immediate&&!timeout;if(!timeout)timeout=setTimeout(later,wait);if(callNow){result=func.apply(context,args);context=args=null}return result}};_.wrap=function(func,wrapper){return _.partial(wrapper,func)};_.negate=function(predicate){return function(){return!predicate.apply(this,arguments)}};_.compose=function(){var args=arguments;var start=args.length-1;return function(){var i=start;var result=args[start].apply(this,arguments);while(i--)result=args[i].call(this,result);return result}};_.after=function(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}};_.before=function(times,func){var memo;return function(){if(--times>0){memo=func.apply(this,arguments)}else{func=null}return memo}};_.once=_.partial(_.before,2);_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)if(_.has(obj,key))keys.push(key);return keys};_.values=function(obj){var keys=_.keys(obj);var length=keys.length;var values=Array(length);for(var i=0;i<length;i++){values[i]=obj[keys[i]]}return values};_.pairs=function(obj){var keys=_.keys(obj);var length=keys.length;var pairs=Array(length);for(var i=0;i<length;i++){pairs[i]=[keys[i],obj[keys[i]]]}return pairs};_.invert=function(obj){var result={};var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i]}return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){if(!_.isObject(obj))return obj;var source,prop;for(var i=1,length=arguments.length;i<length;i++){source=arguments[i];for(prop in source){if(hasOwnProperty.call(source,prop)){obj[prop]=source[prop]}}}return obj};_.pick=function(obj,iteratee,context){var result={},key;if(obj==null)return result;if(_.isFunction(iteratee)){iteratee=createCallback(iteratee,context);for(key in obj){var value=obj[key];if(iteratee(value,key,obj))result[key]=value}}else{var keys=concat.apply([],slice.call(arguments,1));obj=new Object(obj);for(var i=0,length=keys.length;i<length;i++){key=keys[i];if(key in obj)result[key]=obj[key]}}return result};_.omit=function(obj,iteratee,context){if(_.isFunction(iteratee)){iteratee=_.negate(iteratee)}else{var keys=_.map(concat.apply([],slice.call(arguments,1)),String);iteratee=function(value,key){return!_.contains(keys,key)}}return _.pick(obj,iteratee,context)};_.defaults=function(obj){if(!_.isObject(obj))return obj;for(var i=1,length=arguments.length;i<length;i++){var source=arguments[i];for(var prop in source){if(obj[prop]===void 0)obj[prop]=source[prop]}}return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a===1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!==toString.call(b))return false;switch(className){case"[object RegExp]":case"[object String]":return""+a===""+b;case"[object Number]":if(+a!==+a)return+b!==+b;return+a===0?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]===a)return bStack[length]===b}var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&"constructor"in a&&"constructor"in b&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)){return false}aStack.push(a);bStack.push(b);var size,result;if(className==="[object Array]"){size=a.length;result=size===b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{var keys=_.keys(a),key;size=keys.length;result=_.keys(b).length===size;if(result){while(size--){key=keys[size];if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj)||_.isArguments(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)==="[object Array]"};_.isObject=function(obj){var type=typeof obj;return type==="function"||type==="object"&&!!obj};_.each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)==="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return _.has(obj,"callee")}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj=="function"||false}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!==+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)==="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return obj!=null&&hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.constant=function(value){return function(){return value}};_.noop=function(){};_.property=function(key){return function(obj){return obj[key]}};_.matches=function(attrs){var pairs=_.pairs(attrs),length=pairs.length;return function(obj){if(obj==null)return!length;obj=new Object(obj);for(var i=0;i<length;i++){var pair=pairs[i],key=pair[0];if(pair[1]!==obj[key]||!(key in obj))return false}return true}};_.times=function(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=createCallback(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};_.now=Date.now||function(){return(new Date).getTime()};var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};var unescapeMap=_.invert(escapeMap);var createEscaper=function(map){var escaper=function(match){return map[match]};var source="(?:"+_.keys(map).join("|")+")";var testRegexp=RegExp(source);var replaceRegexp=RegExp(source,"g");return function(string){string=string==null?"":""+string;return testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}};_.escape=createEscaper(escapeMap);_.unescape=createEscaper(unescapeMap);_.result=function(object,property){if(object==null)return void 0;var value=object[property];return _.isFunction(value)?object[property]():value};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\u2028|\u2029/g;var escapeChar=function(match){return"\\"+escapes[match]};_.template=function(text,settings,oldSettings){if(!settings&&oldSettings)settings=oldSettings;settings=_.defaults({},settings,_.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,escapeChar);index=offset+match.length;
if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}else if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}else if(evaluate){source+="';\n"+evaluate+"\n__p+='"}return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{var render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}var template=function(data){return render.call(this,data,_)};var argument=settings.variable||"obj";template.source="function("+argument+"){\n"+source+"}";return template};_.chain=function(obj){var instance=_(obj);instance._chain=true;return instance};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin=function(obj){_.each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};_.mixin(_);_.each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name==="shift"||name==="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});_.each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.prototype.value=function(){return this._wrapped};if(typeof define==="function"&&define.amd){define("underscore",[],function(){return _})}}).call(this);(function(root,factory){if(typeof define==="function"&&define.amd){define(["underscore","jquery","exports"],function(_,$,exports){root.Backbone=factory(root,exports,_,$)})}else if(typeof exports!=="undefined"){var _=require("underscore");factory(root,exports,_)}else{root.Backbone=factory(root,{},root._,root.jQuery||root.Zepto||root.ender||root.$)}})(this,function(root,Backbone,_,$){var previousBackbone=root.Backbone;var array=[];var push=array.push;var slice=array.slice;var splice=array.splice;Backbone.VERSION="1.1.2";Backbone.$=$;Backbone.noConflict=function(){root.Backbone=previousBackbone;return this};Backbone.emulateHTTP=false;Backbone.emulateJSON=false;var Events=Backbone.Events={on:function(name,callback,context){if(!eventsApi(this,"on",name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this},once:function(name,callback,context){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this;var once=_.once(function(){self.off(name,once);callback.apply(this,arguments)});once._callback=callback;return this.on(name,once,context)},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!name&&!callback&&!context){this._events=void 0;return this}names=name?[name]:_.keys(this._events);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._events[name]){this._events[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context){retain.push(ev)}}}if(!retain.length)delete this._events[name]}}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name];var allEvents=this._events.all;if(events)triggerEvents(events,args);if(allEvents)triggerEvents(allEvents,arguments);return this},stopListening:function(obj,name,callback){var listeningTo=this._listeningTo;if(!listeningTo)return this;var remove=!name&&!callback;if(!callback&&typeof name==="object")callback=this;if(obj)(listeningTo={})[obj._listenId]=obj;for(var id in listeningTo){obj=listeningTo[id];obj.off(name,callback,this);if(remove||_.isEmpty(obj._events))delete this._listeningTo[id]}return this}};var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==="object"){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest))}return false}if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest))}return false}return true};var triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:while(++i<l)(ev=events[i]).callback.call(ev.ctx);return;case 1:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:while(++i<l)(ev=events[i]).callback.apply(ev.ctx,args);return}};var listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeningTo=this._listeningTo||(this._listeningTo={});var id=obj._listenId||(obj._listenId=_.uniqueId("l"));listeningTo[id]=obj;if(!callback&&typeof name==="object")callback=this;obj[implementation](name,callback,this);return this}});Events.bind=Events.on;Events.unbind=Events.off;_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var attrs=attributes||{};options||(options={});this.cid=_.uniqueId("c");this.attributes={};if(options.collection)this.collection=options.collection;if(options.parse)attrs=this.parse(attrs,options)||{};attrs=_.defaults({},attrs,_.result(this,"defaults"));this.set(attrs,options);this.changed={};this.initialize.apply(this,arguments)};_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(options){return _.clone(this.attributes)},sync:function(){return Backbone.sync.apply(this,arguments)},get:function(attr){return this.attributes[attr]},escape:function(attr){return _.escape(this.get(attr))},has:function(attr){return this.get(attr)!=null},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(key==null)return this;if(typeof key==="object"){attrs=key;options=val}else{(attrs={})[key]=val}options||(options={});if(!this._validate(attrs,options))return false;unset=options.unset;silent=options.silent;changes=[];changing=this._changing;this._changing=true;if(!changing){this._previousAttributes=_.clone(this.attributes);this.changed={}}current=this.attributes,prev=this._previousAttributes;if(this.idAttribute in attrs)this.id=attrs[this.idAttribute];for(attr in attrs){val=attrs[attr];if(!_.isEqual(current[attr],val))changes.push(attr);if(!_.isEqual(prev[attr],val)){this.changed[attr]=val}else{delete this.changed[attr]}unset?delete current[attr]:current[attr]=val}if(!silent){if(changes.length)this._pending=options;for(var i=0,l=changes.length;i<l;i++){this.trigger("change:"+changes[i],this,current[changes[i]],options)}}if(changing)return this;if(!silent){while(this._pending){options=this._pending;this._pending=false;this.trigger("change",this,options)}}this._pending=false;this._changing=false;return this},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:true}))},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:true}))},hasChanged:function(attr){if(attr==null)return!_.isEmpty(this.changed);return _.has(this.changed,attr)},changedAttributes:function(diff){if(!diff)return this.hasChanged()?_.clone(this.changed):false;var val,changed=false;var old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff){if(_.isEqual(old[attr],val=diff[attr]))continue;(changed||(changed={}))[attr]=val}return changed},previous:function(attr){if(attr==null||!this._previousAttributes)return null;return this._previousAttributes[attr]},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){if(!model.set(model.parse(resp,options),options))return false;if(success)success(model,resp,options);model.trigger("sync",model,resp,options)};wrapError(this,options);return this.sync("read",this,options)},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(key==null||typeof key==="object"){attrs=key;options=val}else{(attrs={})[key]=val}options=_.extend({validate:true},options);if(attrs&&!options.wait){if(!this.set(attrs,options))return false}else{if(!this._validate(attrs,options))return false}if(attrs&&options.wait){this.attributes=_.extend({},attributes,attrs)}if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);if(options.wait)serverAttrs=_.extend(attrs||{},serverAttrs);if(_.isObject(serverAttrs)&&!model.set(serverAttrs,options)){return false}if(success)success(model,resp,options);model.trigger("sync",model,resp,options)};wrapError(this,options);method=this.isNew()?"create":options.patch?"patch":"update";if(method==="patch")options.attrs=attrs;xhr=this.sync(method,this,options);if(attrs&&options.wait)this.attributes=attributes;return xhr},destroy:function(options){options=options?_.clone(options):{};var model=this;var success=options.success;var destroy=function(){model.trigger("destroy",model,model.collection,options)};options.success=function(resp){if(options.wait||model.isNew())destroy();if(success)success(model,resp,options);if(!model.isNew())model.trigger("sync",model,resp,options)};if(this.isNew()){options.success();return false}wrapError(this,options);var xhr=this.sync("delete",this,options);if(!options.wait)destroy();return xhr},url:function(){var base=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();if(this.isNew())return base;return base.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(options){return this._validate({},_.extend(options||{},{validate:true}))},_validate:function(attrs,options){if(!options.validate||!this.validate)return true;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;if(!error)return true;this.trigger("invalid",this,error,_.extend(options,{validationError:error}));return false}});var modelMethods=["keys","values","pairs","invert","pick","omit"];_.each(modelMethods,function(method){Model.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.attributes);return _[method].apply(_,args)}});var Collection=Backbone.Collection=function(models,options){options||(options={});if(options.model)this.model=options.model;if(options.comparator!==void 0)this.comparator=options.comparator;this._reset();this.initialize.apply(this,arguments);if(models)this.reset(models,_.extend({silent:true},options))};var setOptions={add:true,remove:true,merge:true};var addOptions={add:true,remove:false};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options)})},sync:function(){return Backbone.sync.apply(this,arguments)},add:function(models,options){return this.set(models,_.extend({merge:false},options,addOptions))},remove:function(models,options){var singular=!_.isArray(models);models=singular?[models]:_.clone(models);options||(options={});var i,l,index,model;for(i=0,l=models.length;i<l;i++){model=models[i]=this.get(models[i]);if(!model)continue;delete this._byId[model.id];delete this._byId[model.cid];index=this.indexOf(model);this.models.splice(index,1);this.length--;if(!options.silent){options.index=index;model.trigger("remove",model,this,options)}this._removeReference(model,options)}return singular?models[0]:models},set:function(models,options){options=_.defaults({},options,setOptions);if(options.parse)models=this.parse(models,options);var singular=!_.isArray(models);models=singular?models?[models]:[]:_.clone(models);var i,l,id,model,attrs,existing,sort;var at=options.at;var targetModel=this.model;var sortable=this.comparator&&at==null&&options.sort!==false;var sortAttr=_.isString(this.comparator)?this.comparator:null;var toAdd=[],toRemove=[],modelMap={};var add=options.add,merge=options.merge,remove=options.remove;var order=!sortable&&add&&remove?[]:false;for(i=0,l=models.length;i<l;i++){attrs=models[i]||{};if(attrs instanceof Model){id=model=attrs}else{id=attrs[targetModel.prototype.idAttribute||"id"]}if(existing=this.get(id)){if(remove)modelMap[existing.cid]=true;if(merge){attrs=attrs===model?model.attributes:attrs;if(options.parse)attrs=existing.parse(attrs,options);existing.set(attrs,options);if(sortable&&!sort&&existing.hasChanged(sortAttr))sort=true}models[i]=existing}else if(add){model=models[i]=this._prepareModel(attrs,options);if(!model)continue;toAdd.push(model);this._addReference(model,options)}model=existing||model;if(order&&(model.isNew()||!modelMap[model.id]))order.push(model);modelMap[model.id]=true}if(remove){for(i=0,l=this.length;i<l;++i){if(!modelMap[(model=this.models[i]).cid])toRemove.push(model)}if(toRemove.length)this.remove(toRemove,options)}if(toAdd.length||order&&order.length){if(sortable)sort=true;this.length+=toAdd.length;if(at!=null){for(i=0,l=toAdd.length;i<l;i++){this.models.splice(at+i,0,toAdd[i])}}else{if(order)this.models.length=0;var orderedModels=order||toAdd;for(i=0,l=orderedModels.length;i<l;i++){this.models.push(orderedModels[i])}}}if(sort)this.sort({silent:true});if(!options.silent){for(i=0,l=toAdd.length;i<l;i++){(model=toAdd[i]).trigger("add",model,this,options)}if(sort||order&&order.length)this.trigger("sort",this,options)}return singular?models[0]:models},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;i<l;i++){this._removeReference(this.models[i],options)}options.previousModels=this.models;this._reset();models=this.add(models,_.extend({silent:true},options));if(!options.silent)this.trigger("reset",this,options);return models},push:function(model,options){return this.add(model,_.extend({at:this.length},options))},pop:function(options){var model=this.at(this.length-1);this.remove(model,options);return model},unshift:function(model,options){return this.add(model,_.extend({at:0},options))},shift:function(options){var model=this.at(0);this.remove(model,options);return model},slice:function(){return slice.apply(this.models,arguments)},get:function(obj){if(obj==null)return void 0;return this._byId[obj]||this._byId[obj.id]||this._byId[obj.cid]},at:function(index){return this.models[index]},where:function(attrs,first){if(_.isEmpty(attrs))return first?void 0:[];return this[first?"find":"filter"](function(model){for(var key in attrs){if(attrs[key]!==model.get(key))return false}return true})},findWhere:function(attrs){return this.where(attrs,true)},sort:function(options){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");options||(options={});if(_.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(_.bind(this.comparator,this))}if(!options.silent)this.trigger("sort",this,options);return this},pluck:function(attr){return _.invoke(this.models,"get",attr)},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var success=options.success;var collection=this;options.success=function(resp){var method=options.reset?"reset":"set";collection[method](resp,options);if(success)success(collection,resp,options);collection.trigger("sync",collection,resp,options)};wrapError(this,options);return this.sync("read",this,options)},create:function(model,options){options=options?_.clone(options):{};if(!(model=this._prepareModel(model,options)))return false;if(!options.wait)this.add(model,options);var collection=this;var success=options.success;options.success=function(model,resp){if(options.wait)collection.add(model,options);if(success)success(model,resp,options)};model.save(null,options);return model},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(attrs,options){if(attrs instanceof Model)return attrs;options=options?_.clone(options):{};options.collection=this;var model=new this.model(attrs,options);if(!model.validationError)return model;this.trigger("invalid",this,model.validationError,options);return false},_addReference:function(model,options){this._byId[model.cid]=model;if(model.id!=null)this._byId[model.id]=model;if(!model.collection)model.collection=this;model.on("all",this._onModelEvent,this)},_removeReference:function(model,options){if(this===model.collection)delete model.collection;model.off("all",this._onModelEvent,this)},_onModelEvent:function(event,model,collection,options){if((event==="add"||event==="remove")&&collection!==this)return;if(event==="destroy")this.remove(model,options);if(model&&event==="change:"+model.idAttribute){delete this._byId[model.previous(model.idAttribute)];if(model.id!=null)this._byId[model.id]=model}this.trigger.apply(this,arguments)}});var methods=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];_.each(methods,function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.models);return _[method].apply(_,args)}});var attributeMethods=["groupBy","countBy","sortBy","indexBy"];_.each(attributeMethods,function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _[method](this.models,iterator,context)}});var View=Backbone.View=function(options){this.cid=_.uniqueId("view");options||(options={});_.extend(this,_.pick(options,viewOptions));this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var delegateEventSplitter=/^(\S+)\s*(.*)$/;var viewOptions=["model","collection","el","id","attributes","className","tagName","events"];_.extend(View.prototype,Events,{tagName:"div",$:function(selector){return this.$el.find(selector)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(element,delegate){if(this.$el)this.undelegateEvents();this.$el=element instanceof Backbone.$?element:Backbone.$(element);this.el=this.$el[0];if(delegate!==false)this.delegateEvents();return this},delegateEvents:function(events){if(!(events||(events=_.result(this,"events"))))return this;this.undelegateEvents();for(var key in events){var method=events[key];if(!_.isFunction(method))method=this[events[key]];if(!method)continue;var match=key.match(delegateEventSplitter);var eventName=match[1],selector=match[2];method=_.bind(method,this);eventName+=".delegateEvents"+this.cid;if(selector===""){this.$el.on(eventName,method)}else{this.$el.on(eventName,selector,method)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_ensureElement:function(){if(!this.el){var attrs=_.extend({},_.result(this,"attributes"));if(this.id)attrs.id=_.result(this,"id");if(this.className)attrs["class"]=_.result(this,"className");var $el=Backbone.$("<"+_.result(this,"tagName")+">").attr(attrs);this.setElement($el,false)}else{this.setElement(_.result(this,"el"),false)}}});Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:"json"};if(!options.url){params.url=_.result(model,"url")||urlError()}if(options.data==null&&model&&(method==="create"||method==="update"||method==="patch")){params.contentType="application/json";params.data=JSON.stringify(options.attrs||model.toJSON(options))}if(options.emulateJSON){params.contentType="application/x-www-form-urlencoded";params.data=params.data?{model:params.data}:{}}if(options.emulateHTTP&&(type==="PUT"||type==="DELETE"||type==="PATCH")){params.type="POST";if(options.emulateJSON)params.data._method=type;var beforeSend=options.beforeSend;options.beforeSend=function(xhr){xhr.setRequestHeader("X-HTTP-Method-Override",type);if(beforeSend)return beforeSend.apply(this,arguments)}}if(params.type!=="GET"&&!options.emulateJSON){params.processData=false}if(params.type==="PATCH"&&noXhrPatch){params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var xhr=options.xhr=Backbone.ajax(_.extend(params,options));model.trigger("request",model,xhr,options);return xhr};var noXhrPatch=typeof window!=="undefined"&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent);var methodMap={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)};var Router=Backbone.Router=function(options){options||(options={});if(options.routes)this.routes=options.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var optionalParam=/\((.*?)\)/g;var namedParam=/(\(\?)?:\w+/g;var splatParam=/\*\w+/g;var escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){if(!_.isRegExp(route))route=this._routeToRegExp(route);if(_.isFunction(name)){callback=name;name=""}if(!callback)callback=this[name];var router=this;Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);router.execute(callback,args);router.trigger.apply(router,["route:"+name].concat(args));router.trigger("route",name,args);Backbone.history.trigger("route",router,name,args)});return this},execute:function(callback,args){if(callback)callback.apply(this,args)},navigate:function(fragment,options){Backbone.history.navigate(fragment,options);return this},_bindRoutes:function(){if(!this.routes)return;this.routes=_.result(this,"routes");var route,routes=_.keys(this.routes);while((route=routes.pop())!=null){this.route(route,this.routes[route])}},_routeToRegExp:function(route){route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/?]+)"}).replace(splatParam,"([^?]*?)");return new RegExp("^"+route+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param,i){if(i===params.length-1)return param||null;return param?decodeURIComponent(param):null})}});var History=Backbone.History=function(){this.handlers=[];_.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var routeStripper=/^[#\/]|\s+$/g;var rootStripper=/^\/+|\/+$/g;var isExplorer=/msie [\w.]+/;var trailingSlash=/\/$/;var pathStripper=/#.*$/;History.started=false;_.extend(History.prototype,Events,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:""},getFragment:function(fragment,forcePushState){if(fragment==null){if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=decodeURI(this.location.pathname+this.location.search);var root=this.root.replace(trailingSlash,"");if(!fragment.indexOf(root))fragment=fragment.slice(root.length)}else{fragment=this.getHash()}}return fragment.replace(routeStripper,"")},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=true;this.options=_.extend({root:"/"},this.options,options);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment();var docMode=document.documentMode;var oldIE=isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7);this.root=("/"+this.root+"/").replace(rootStripper,"/");if(oldIE&&this._wantsHashChange){var frame=Backbone.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=frame.hide().appendTo("body")[0].contentWindow;this.navigate(fragment)}if(this._hasPushState){Backbone.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!oldIE){Backbone.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=fragment;var loc=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){this.fragment=this.getFragment(null,true);this.location.replace(this.root+"#"+this.fragment);return true}else if(this._hasPushState&&this.atRoot()&&loc.hash){this.fragment=this.getHash().replace(routeStripper,"");this.history.replaceState({},document.title,this.root+this.fragment)}}if(!this.options.silent)return this.loadUrl()},stop:function(){Backbone.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);if(this._checkUrlInterval)clearInterval(this._checkUrlInterval);History.started=false},route:function(route,callback){this.handlers.unshift({route:route,callback:callback})},checkUrl:function(e){var current=this.getFragment();if(current===this.fragment&&this.iframe){current=this.getFragment(this.getHash(this.iframe))}if(current===this.fragment)return false;if(this.iframe)this.navigate(current);this.loadUrl()},loadUrl:function(fragment){fragment=this.fragment=this.getFragment(fragment);return _.any(this.handlers,function(handler){if(handler.route.test(fragment)){handler.callback(fragment);return true}})},navigate:function(fragment,options){if(!History.started)return false;if(!options||options===true)options={trigger:!!options};var url=this.root+(fragment=this.getFragment(fragment||""));fragment=fragment.replace(pathStripper,"");if(this.fragment===fragment)return;this.fragment=fragment;if(fragment===""&&url!=="/")url=url.slice(0,-1);if(this._hasPushState){this.history[options.replace?"replaceState":"pushState"]({},document.title,url)}else if(this._wantsHashChange){this._updateHash(this.location,fragment,options.replace);if(this.iframe&&fragment!==this.getFragment(this.getHash(this.iframe))){if(!options.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,fragment,options.replace)}}else{return this.location.assign(url)}if(options.trigger)return this.loadUrl(fragment)},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,"");location.replace(href+"#"+fragment)}else{location.hash="#"+fragment}}});Backbone.history=new History;var extend=function(protoProps,staticProps){var parent=this;var child;if(protoProps&&_.has(protoProps,"constructor")){child=protoProps.constructor}else{child=function(){return parent.apply(this,arguments)}}_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate;if(protoProps)_.extend(child.prototype,protoProps);child.__super__=parent.prototype;return child};Model.extend=Collection.extend=Router.extend=View.extend=History.extend=extend;var urlError=function(){throw new Error('A "url" property or function must be specified')};var wrapError=function(model,options){var error=options.error;options.error=function(resp){if(error)error(model,resp,options);model.trigger("error",model,resp,options)}};return Backbone});(function(global,factory){if(typeof exports==="object"&&exports){factory(exports)}else if(typeof define==="function"&&define.amd){define(["exports"],factory)}else{factory(global.Mustache={})}})(this,function(mustache){var Object_toString=Object.prototype.toString;var isArray=Array.isArray||function(object){return Object_toString.call(object)==="[object Array]"};function isFunction(object){return typeof object==="function"}function escapeRegExp(string){return string.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var RegExp_test=RegExp.prototype.test;function testRegExp(re,string){return RegExp_test.call(re,string)}var nonSpaceRe=/\S/;function isWhitespace(string){return!testRegExp(nonSpaceRe,string)}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function escapeHtml(string){return String(string).replace(/[&<>"'\/]/g,function(s){return entityMap[s]})}var whiteRe=/\s*/;var spaceRe=/\s+/;var equalsRe=/\s*=/;var curlyRe=/\s*\}/;var tagRe=/#|\^|\/|>|\{|&|=|!/;function parseTemplate(template,tags){if(!template)return[];var sections=[];var tokens=[];var spaces=[];var hasTag=false;var nonSpace=false;function stripSpace(){if(hasTag&&!nonSpace){while(spaces.length)delete tokens[spaces.pop()]}else{spaces=[]}hasTag=false;nonSpace=false}var openingTagRe,closingTagRe,closingCurlyRe;function compileTags(tags){if(typeof tags==="string")tags=tags.split(spaceRe,2);if(!isArray(tags)||tags.length!==2)throw new Error("Invalid tags: "+tags);openingTagRe=new RegExp(escapeRegExp(tags[0])+"\\s*");closingTagRe=new RegExp("\\s*"+escapeRegExp(tags[1]));closingCurlyRe=new RegExp("\\s*"+escapeRegExp("}"+tags[1]))}compileTags(tags||mustache.tags);var scanner=new Scanner(template);var start,type,value,chr,token,openSection;while(!scanner.eos()){start=scanner.pos;value=scanner.scanUntil(openingTagRe);if(value){for(var i=0,valueLength=value.length;i<valueLength;++i){chr=value.charAt(i);if(isWhitespace(chr)){spaces.push(tokens.length)}else{nonSpace=true}tokens.push(["text",chr,start,start+1]);start+=1;if(chr==="\n")stripSpace()}}if(!scanner.scan(openingTagRe))break;hasTag=true;type=scanner.scan(tagRe)||"name";scanner.scan(whiteRe);if(type==="="){value=scanner.scanUntil(equalsRe);scanner.scan(equalsRe);scanner.scanUntil(closingTagRe)}else if(type==="{"){value=scanner.scanUntil(closingCurlyRe);scanner.scan(curlyRe);scanner.scanUntil(closingTagRe);type="&"}else{value=scanner.scanUntil(closingTagRe)}if(!scanner.scan(closingTagRe))throw new Error("Unclosed tag at "+scanner.pos);token=[type,value,start,scanner.pos];tokens.push(token);if(type==="#"||type==="^"){sections.push(token)}else if(type==="/"){openSection=sections.pop();if(!openSection)throw new Error('Unopened section "'+value+'" at '+start);if(openSection[1]!==value)throw new Error('Unclosed section "'+openSection[1]+'" at '+start)}else if(type==="name"||type==="{"||type==="&"){nonSpace=true}else if(type==="="){compileTags(value)}}openSection=sections.pop();if(openSection)throw new Error('Unclosed section "'+openSection[1]+'" at '+scanner.pos);return nestTokens(squashTokens(tokens))}function squashTokens(tokens){var squashedTokens=[];var token,lastToken;for(var i=0,numTokens=tokens.length;i<numTokens;++i){token=tokens[i];if(token){if(token[0]==="text"&&lastToken&&lastToken[0]==="text"){lastToken[1]+=token[1];lastToken[3]=token[3]}else{squashedTokens.push(token);lastToken=token}}}return squashedTokens}function nestTokens(tokens){var nestedTokens=[];var collector=nestedTokens;var sections=[];var token,section;for(var i=0,numTokens=tokens.length;i<numTokens;++i){token=tokens[i];switch(token[0]){case"#":case"^":collector.push(token);
sections.push(token);collector=token[4]=[];break;case"/":section=sections.pop();section[5]=token[2];collector=sections.length>0?sections[sections.length-1][4]:nestedTokens;break;default:collector.push(token)}}return nestedTokens}function Scanner(string){this.string=string;this.tail=string;this.pos=0}Scanner.prototype.eos=function(){return this.tail===""};Scanner.prototype.scan=function(re){var match=this.tail.match(re);if(!match||match.index!==0)return"";var string=match[0];this.tail=this.tail.substring(string.length);this.pos+=string.length;return string};Scanner.prototype.scanUntil=function(re){var index=this.tail.search(re),match;switch(index){case-1:match=this.tail;this.tail="";break;case 0:match="";break;default:match=this.tail.substring(0,index);this.tail=this.tail.substring(index)}this.pos+=match.length;return match};function Context(view,parentContext){this.view=view==null?{}:view;this.cache={".":this.view};this.parent=parentContext}Context.prototype.push=function(view){return new Context(view,this)};Context.prototype.lookup=function(name){var cache=this.cache;var value;if(name in cache){value=cache[name]}else{var context=this,names,index;while(context){if(name.indexOf(".")>0){value=context.view;names=name.split(".");index=0;while(value!=null&&index<names.length)value=value[names[index++]]}else{value=context.view[name]}if(value!=null)break;context=context.parent}cache[name]=value}if(isFunction(value))value=value.call(this.view);return value};function Writer(){this.cache={}}Writer.prototype.clearCache=function(){this.cache={}};Writer.prototype.parse=function(template,tags){var cache=this.cache;var tokens=cache[template];if(tokens==null)tokens=cache[template]=parseTemplate(template,tags);return tokens};Writer.prototype.render=function(template,view,partials){var tokens=this.parse(template);var context=view instanceof Context?view:new Context(view);return this.renderTokens(tokens,context,partials,template)};Writer.prototype.renderTokens=function(tokens,context,partials,originalTemplate){var buffer="";var self=this;function subRender(template){return self.render(template,context,partials)}var token,value;for(var i=0,numTokens=tokens.length;i<numTokens;++i){token=tokens[i];switch(token[0]){case"#":value=context.lookup(token[1]);if(!value)continue;if(isArray(value)){for(var j=0,valueLength=value.length;j<valueLength;++j){buffer+=this.renderTokens(token[4],context.push(value[j]),partials,originalTemplate)}}else if(typeof value==="object"||typeof value==="string"){buffer+=this.renderTokens(token[4],context.push(value),partials,originalTemplate)}else if(isFunction(value)){if(typeof originalTemplate!=="string")throw new Error("Cannot use higher-order sections without the original template");value=value.call(context.view,originalTemplate.slice(token[3],token[5]),subRender);if(value!=null)buffer+=value}else{buffer+=this.renderTokens(token[4],context,partials,originalTemplate)}break;case"^":value=context.lookup(token[1]);if(!value||isArray(value)&&value.length===0)buffer+=this.renderTokens(token[4],context,partials,originalTemplate);break;case">":if(!partials)continue;value=isFunction(partials)?partials(token[1]):partials[token[1]];if(value!=null)buffer+=this.renderTokens(this.parse(value),context,partials,value);break;case"&":value=context.lookup(token[1]);if(value!=null)buffer+=value;break;case"name":value=context.lookup(token[1]);if(value!=null)buffer+=mustache.escape(value);break;case"text":buffer+=token[1];break}}return buffer};mustache.name="mustache.js";mustache.version="0.8.1";mustache.tags=["{{","}}"];var defaultWriter=new Writer;mustache.clearCache=function(){return defaultWriter.clearCache()};mustache.parse=function(template,tags){return defaultWriter.parse(template,tags)};mustache.render=function(template,view,partials){return defaultWriter.render(template,view,partials)};mustache.to_html=function(template,view,partials,send){var result=mustache.render(template,view,partials);if(isFunction(send)){send(result)}else{return result}};mustache.escape=escapeHtml;mustache.Scanner=Scanner;mustache.Context=Context;mustache.Writer=Writer});var Markdown;if(typeof exports==="object"&&typeof require==="function")Markdown=exports;else Markdown={};(function(){function identity(x){return x}function returnFalse(x){return false}function HookCollection(){}HookCollection.prototype={chain:function(hookname,func){var original=this[hookname];if(!original)throw new Error("unknown hook "+hookname);if(original===identity)this[hookname]=func;else this[hookname]=function(x){return func(original(x))}},set:function(hookname,func){if(!this[hookname])throw new Error("unknown hook "+hookname);this[hookname]=func},addNoop:function(hookname){this[hookname]=identity},addFalse:function(hookname){this[hookname]=returnFalse}};Markdown.HookCollection=HookCollection;function SaveHash(){}SaveHash.prototype={set:function(key,value){this["s_"+key]=value},get:function(key){return this["s_"+key]}};Markdown.Converter=function(){var pluginHooks=this.hooks=new HookCollection;pluginHooks.addNoop("plainLinkText");pluginHooks.addNoop("preConversion");pluginHooks.addNoop("postConversion");var g_urls;var g_titles;var g_html_blocks;var g_list_level;this.makeHtml=function(text){if(g_urls)throw new Error("Recursive call to converter.makeHtml");g_urls=new SaveHash;g_titles=new SaveHash;g_html_blocks=[];g_list_level=0;text=pluginHooks.preConversion(text);text=text.replace(/~/g,"~T");text=text.replace(/\$/g,"~D");text=text.replace(/\r\n/g,"\n");text=text.replace(/\r/g,"\n");text="\n\n"+text+"\n\n";text=_Detab(text);text=text.replace(/^[ \t]+$/gm,"");text=_HashHTMLBlocks(text);text=_StripLinkDefinitions(text);text=_RunBlockGamut(text);text=_UnescapeSpecialChars(text);text=text.replace(/~D/g,"$$");text=text.replace(/~T/g,"~");text=pluginHooks.postConversion(text);g_html_blocks=g_titles=g_urls=null;return text};function _StripLinkDefinitions(text){text=text.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?(?=\s|$)[ \t]*\n?[ \t]*((\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm,function(wholeMatch,m1,m2,m3,m4,m5){m1=m1.toLowerCase();g_urls.set(m1,_EncodeAmpsAndAngles(m2));if(m4){return m3}else if(m5){g_titles.set(m1,m5.replace(/"/g,"&quot;"))}return""});return text}function _HashHTMLBlocks(text){var block_tags_a="p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del";var block_tags_b="p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math";text=text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,hashElement);text=text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,hashElement);text=text.replace(/\n[ ]{0,3}((<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,hashElement);text=text.replace(/\n\n[ ]{0,3}(<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>[ \t]*(?=\n{2,}))/g,hashElement);text=text.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,hashElement);return text}function hashElement(wholeMatch,m1){var blockText=m1;blockText=blockText.replace(/^\n+/,"");blockText=blockText.replace(/\n+$/g,"");blockText="\n\n~K"+(g_html_blocks.push(blockText)-1)+"K\n\n";return blockText}function _RunBlockGamut(text,doNotUnhash){text=_DoHeaders(text);var replacement="<hr />\n";text=text.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,replacement);text=text.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm,replacement);text=text.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm,replacement);text=_DoLists(text);text=_DoCodeBlocks(text);text=_DoBlockQuotes(text);text=_HashHTMLBlocks(text);text=_FormParagraphs(text,doNotUnhash);return text}function _RunSpanGamut(text){text=_DoCodeSpans(text);text=_EscapeSpecialCharsWithinTagAttributes(text);text=_EncodeBackslashEscapes(text);text=_DoImages(text);text=_DoAnchors(text);text=_DoAutoLinks(text);text=text.replace(/~P/g,"://");text=_EncodeAmpsAndAngles(text);text=_DoItalicsAndBold(text);text=text.replace(/  +\n/g," <br>\n");return text}function _EscapeSpecialCharsWithinTagAttributes(text){var regex=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--(?:|(?:[^>-]|-[^>])(?:[^-]|-[^-])*)--)>)/gi;text=text.replace(regex,function(wholeMatch){var tag=wholeMatch.replace(/(.)<\/?code>(?=.)/g,"$1`");tag=escapeCharacters(tag,wholeMatch.charAt(1)=="!"?"\\`*_/":"\\`*_");return tag});return text}function _DoAnchors(text){text=text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,writeAnchorTag);text=text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?((?:\([^)]*\)|[^()\s])*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,writeAnchorTag);text=text.replace(/(\[([^\[\]]+)\])()()()()()/g,writeAnchorTag);return text}function writeAnchorTag(wholeMatch,m1,m2,m3,m4,m5,m6,m7){if(m7==undefined)m7="";var whole_match=m1;var link_text=m2.replace(/:\/\//g,"~P");var link_id=m3.toLowerCase();var url=m4;var title=m7;if(url==""){if(link_id==""){link_id=link_text.toLowerCase().replace(/ ?\n/g," ")}url="#"+link_id;if(g_urls.get(link_id)!=undefined){url=g_urls.get(link_id);if(g_titles.get(link_id)!=undefined){title=g_titles.get(link_id)}}else{if(whole_match.search(/\(\s*\)$/m)>-1){url=""}else{return whole_match}}}url=encodeProblemUrlChars(url);url=escapeCharacters(url,"*_");var result='<a href="'+url+'"';if(title!=""){title=attributeEncode(title);title=escapeCharacters(title,"*_");result+=' title="'+title+'"'}result+=">"+link_text+"</a>";return result}function _DoImages(text){text=text.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,writeImageTag);text=text.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,writeImageTag);return text}function attributeEncode(text){return text.replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function writeImageTag(wholeMatch,m1,m2,m3,m4,m5,m6,m7){var whole_match=m1;var alt_text=m2;var link_id=m3.toLowerCase();var url=m4;var title=m7;if(!title)title="";if(url==""){if(link_id==""){link_id=alt_text.toLowerCase().replace(/ ?\n/g," ")}url="#"+link_id;if(g_urls.get(link_id)!=undefined){url=g_urls.get(link_id);if(g_titles.get(link_id)!=undefined){title=g_titles.get(link_id)}}else{return whole_match}}alt_text=escapeCharacters(attributeEncode(alt_text),"*_[]()");url=escapeCharacters(url,"*_");var result='<img src="'+url+'" alt="'+alt_text+'"';title=attributeEncode(title);title=escapeCharacters(title,"*_");result+=' title="'+title+'"';result+=" />";return result}function _DoHeaders(text){text=text.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(wholeMatch,m1){return"<h1>"+_RunSpanGamut(m1)+"</h1>\n\n"});text=text.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(matchFound,m1){return"<h2>"+_RunSpanGamut(m1)+"</h2>\n\n"});text=text.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(wholeMatch,m1,m2){var h_level=m1.length;return"<h"+h_level+">"+_RunSpanGamut(m2)+"</h"+h_level+">\n\n"});return text}function _DoLists(text){text+="~0";var whole_list=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;if(g_list_level){text=text.replace(whole_list,function(wholeMatch,m1,m2){var list=m1;var list_type=m2.search(/[*+-]/g)>-1?"ul":"ol";var result=_ProcessListItems(list,list_type);result=result.replace(/\s+$/,"");result="<"+list_type+">"+result+"</"+list_type+">\n";return result})}else{whole_list=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g;text=text.replace(whole_list,function(wholeMatch,m1,m2,m3){var runup=m1;var list=m2;var list_type=m3.search(/[*+-]/g)>-1?"ul":"ol";var result=_ProcessListItems(list,list_type);result=runup+"<"+list_type+">\n"+result+"</"+list_type+">\n";return result})}text=text.replace(/~0/,"");return text}var _listItemMarkers={ol:"\\d+[.]",ul:"[*+-]"};function _ProcessListItems(list_str,list_type){g_list_level++;list_str=list_str.replace(/\n{2,}$/,"\n");list_str+="~0";var marker=_listItemMarkers[list_type];var re=new RegExp("(^[ \\t]*)("+marker+")[ \\t]+([^\\r]+?(\\n+))(?=(~0|\\1("+marker+")[ \\t]+))","gm");var last_item_had_a_double_newline=false;list_str=list_str.replace(re,function(wholeMatch,m1,m2,m3){var item=m3;var leading_space=m1;var ends_with_double_newline=/\n\n$/.test(item);var contains_double_newline=ends_with_double_newline||item.search(/\n{2,}/)>-1;if(contains_double_newline||last_item_had_a_double_newline){item=_RunBlockGamut(_Outdent(item),true)}else{item=_DoLists(_Outdent(item));item=item.replace(/\n$/,"");item=_RunSpanGamut(item)}last_item_had_a_double_newline=ends_with_double_newline;return"<li>"+item+"</li>\n"});list_str=list_str.replace(/~0/g,"");g_list_level--;return list_str}function _DoCodeBlocks(text){text+="~0";text=text.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(wholeMatch,m1,m2){var codeblock=m1;var nextChar=m2;codeblock=_EncodeCode(_Outdent(codeblock));codeblock=_Detab(codeblock);codeblock=codeblock.replace(/^\n+/g,"");codeblock=codeblock.replace(/\n+$/g,"");codeblock="<pre><code>"+codeblock+"\n</code></pre>";return"\n\n"+codeblock+"\n\n"+nextChar});text=text.replace(/~0/,"");return text}function hashBlock(text){text=text.replace(/(^\n+|\n+$)/g,"");return"\n\n~K"+(g_html_blocks.push(text)-1)+"K\n\n"}function _DoCodeSpans(text){text=text.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(wholeMatch,m1,m2,m3,m4){var c=m3;c=c.replace(/^([ \t]*)/g,"");c=c.replace(/[ \t]*$/g,"");c=_EncodeCode(c);c=c.replace(/:\/\//g,"~P");return m1+"<code>"+c+"</code>"});return text}function _EncodeCode(text){text=text.replace(/&/g,"&amp;");text=text.replace(/</g,"&lt;");text=text.replace(/>/g,"&gt;");text=escapeCharacters(text,"*_{}[]\\",false);return text}function _DoItalicsAndBold(text){text=text.replace(/([\W_]|^)(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\2([\W_]|$)/g,"$1<strong>$3</strong>$4");text=text.replace(/([\W_]|^)(\*|_)(?=\S)([^\r\*_]*?\S)\2([\W_]|$)/g,"$1<em>$3</em>$4");return text}function _DoBlockQuotes(text){text=text.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(wholeMatch,m1){var bq=m1;bq=bq.replace(/^[ \t]*>[ \t]?/gm,"~0");bq=bq.replace(/~0/g,"");bq=bq.replace(/^[ \t]+$/gm,"");bq=_RunBlockGamut(bq);bq=bq.replace(/(^|\n)/g,"$1  ");bq=bq.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(wholeMatch,m1){var pre=m1;pre=pre.replace(/^  /gm,"~0");pre=pre.replace(/~0/g,"");return pre});return hashBlock("<blockquote>\n"+bq+"\n</blockquote>")});return text}function _FormParagraphs(text,doNotUnhash){text=text.replace(/^\n+/g,"");text=text.replace(/\n+$/g,"");var grafs=text.split(/\n{2,}/g);var grafsOut=[];var markerRe=/~K(\d+)K/;var end=grafs.length;for(var i=0;i<end;i++){var str=grafs[i];if(markerRe.test(str)){grafsOut.push(str)}else if(/\S/.test(str)){str=_RunSpanGamut(str);str=str.replace(/^([ \t]*)/g,"<p>");str+="</p>";grafsOut.push(str)}}if(!doNotUnhash){end=grafsOut.length;for(var i=0;i<end;i++){var foundAny=true;while(foundAny){foundAny=false;grafsOut[i]=grafsOut[i].replace(/~K(\d+)K/g,function(wholeMatch,id){foundAny=true;return g_html_blocks[id]})}}}return grafsOut.join("\n\n")}function _EncodeAmpsAndAngles(text){text=text.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;");text=text.replace(/<(?![a-z\/?\$!])/gi,"&lt;");return text}function _EncodeBackslashEscapes(text){text=text.replace(/\\(\\)/g,escapeCharacters_callback);text=text.replace(/\\([`*_{}\[\]()>#+-.!])/g,escapeCharacters_callback);return text}function _DoAutoLinks(text){text=text.replace(/(^|\s)(https?|ftp)(:\/\/[-A-Z0-9+&@#\/%?=~_|\[\]\(\)!:,\.;]*[-A-Z0-9+&@#\/%=~_|\[\]])($|\W)/gi,"$1<$2$3>$4");var replacer=function(wholematch,m1){return'<a href="'+m1+'">'+pluginHooks.plainLinkText(m1)+"</a>"};text=text.replace(/<((https?|ftp):[^'">\s]+)>/gi,replacer);return text}function _UnescapeSpecialChars(text){text=text.replace(/~E(\d+)E/g,function(wholeMatch,m1){var charCodeToReplace=parseInt(m1);return String.fromCharCode(charCodeToReplace)});return text}function _Outdent(text){text=text.replace(/^(\t|[ ]{1,4})/gm,"~0");text=text.replace(/~0/g,"");return text}function _Detab(text){if(!/\t/.test(text))return text;var spaces=["    ","   ","  "," "],skew=0,v;return text.replace(/[\n\t]/g,function(match,offset){if(match==="\n"){skew=offset+1;return match}v=(offset-skew)%4;skew=offset+1;return spaces[v]})}var _problemUrlChars=/(?:["'*()[\]:]|~D)/g;function encodeProblemUrlChars(url){if(!url)return"";var len=url.length;return url.replace(_problemUrlChars,function(match,offset){if(match=="~D")return"%24";if(match==":"){if(offset==len-1||/[0-9\/]/.test(url.charAt(offset+1)))return":"}return"%"+match.charCodeAt(0).toString(16)})}function escapeCharacters(text,charsToEscape,afterBackslash){var regexString="(["+charsToEscape.replace(/([\[\]\\])/g,"\\$1")+"])";if(afterBackslash){regexString="\\\\"+regexString}var regex=new RegExp(regexString,"g");text=text.replace(regex,escapeCharacters_callback);return text}function escapeCharacters_callback(wholeMatch,m1){var charCodeToEscape=m1.charCodeAt(0);return"~E"+charCodeToEscape+"E"}}})();(function(){var output,Converter;if(typeof exports==="object"&&typeof require==="function"){output=exports;Converter=require("./Markdown.Converter").Converter}else{output=window.Markdown;Converter=output.Converter}output.getSanitizingConverter=function(){var converter=new Converter;converter.hooks.chain("postConversion",sanitizeHtml);converter.hooks.chain("postConversion",balanceTags);return converter};function sanitizeHtml(html){return html.replace(/<[^>]*>?/gi,sanitizeTag)}var basic_tag_whitelist=/^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$/i;var a_white=/^(<a\shref="((https?|ftp):\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\stitle="[^"<>]+")?\s?>|<\/a>)$/i;var img_white=/^(<img\ssrc="(https?:\/\/|\/)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$/i;function sanitizeTag(tag){if(tag.match(basic_tag_whitelist)||tag.match(a_white)||tag.match(img_white))return tag;else return""}function balanceTags(html){if(html=="")return"";var re=/<\/?\w+[^>]*(\s|$|>)/g;var tags=html.toLowerCase().match(re);var tagcount=(tags||[]).length;if(tagcount==0)return html;var tagname,tag;var ignoredtags="<p><img><br><li><hr>";var match;var tagpaired=[];var tagremove=[];var needsRemoval=false;for(var ctag=0;ctag<tagcount;ctag++){tagname=tags[ctag].replace(/<\/?(\w+).*/,"$1");if(tagpaired[ctag]||ignoredtags.search("<"+tagname+">")>-1)continue;tag=tags[ctag];match=-1;if(!/^<\//.test(tag)){for(var ntag=ctag+1;ntag<tagcount;ntag++){if(!tagpaired[ntag]&&tags[ntag]=="</"+tagname+">"){match=ntag;break}}}if(match==-1)needsRemoval=tagremove[ctag]=true;else tagpaired[match]=true}if(!needsRemoval)return html;var ctag=0;html=html.replace(re,function(match){var res=tagremove[ctag]?"":match;ctag++;return res});return html}})();(function(){var util={},position={},ui={},doc=window.document,re=window.RegExp,nav=window.navigator,SETTINGS={lineLength:72},uaSniffed={isIE:/msie/.test(nav.userAgent.toLowerCase()),isIE_5or6:/msie 6/.test(nav.userAgent.toLowerCase())||/msie 5/.test(nav.userAgent.toLowerCase()),isOpera:/opera/.test(nav.userAgent.toLowerCase())};var linkDialogText="<p><b>"+gettext("Insert Hyperlink")+"</b></p><p>http://example.com/ "+gettext('"optional title"')+"</p>";var imageDialogText="<p><b>"+gettext("Insert Image (upload file or type url)")+"</b></p><p>http://example.com/images/diagram.jpg "+gettext('"optional title"')+"<br><br></p>";var imageDefaultText="http://";var linkDefaultText="http://";var defaultHelpHoverTitle=gettext("Markdown Editing Help");Markdown.Editor=function(markdownConverter,idPostfix,help,imageUploadHandler){idPostfix=idPostfix||"";var hooks=this.hooks=new Markdown.HookCollection;hooks.addNoop("onPreviewPush");hooks.addNoop("postBlockquoteCreation");hooks.addFalse("insertImageDialog");this.getConverter=function(){return markdownConverter};var that=this,panels;this.run=function(){if(panels)return;panels=new PanelCollection(idPostfix);var commandManager=new CommandManager(hooks);var previewManager=new PreviewManager(markdownConverter,panels,function(text,previewSet){hooks.onPreviewPush(text,previewSet)});var undoManager,uiManager;if(!/\?noundo/.test(doc.location.href)){undoManager=new UndoManager(function(){previewManager.refresh();if(uiManager)uiManager.setUndoRedoButtonStates()},panels);this.textOperation=function(f){undoManager.setCommandMode();f();that.refreshPreview()}}uiManager=new UIManager(idPostfix,panels,undoManager,previewManager,commandManager,help,imageUploadHandler);uiManager.setUndoRedoButtonStates();var forceRefresh=that.refreshPreview=function(){previewManager.refresh(true)};forceRefresh()}};function Chunks(){}Chunks.prototype.findTags=function(startRegex,endRegex){var chunkObj=this;var regex;if(startRegex){regex=util.extendRegExp(startRegex,"","$");this.before=this.before.replace(regex,function(match){chunkObj.startTag=chunkObj.startTag+match;return""});regex=util.extendRegExp(startRegex,"^","");this.selection=this.selection.replace(regex,function(match){chunkObj.startTag=chunkObj.startTag+match;return""})}if(endRegex){regex=util.extendRegExp(endRegex,"","$");this.selection=this.selection.replace(regex,function(match){chunkObj.endTag=match+chunkObj.endTag;return""});regex=util.extendRegExp(endRegex,"^","");this.after=this.after.replace(regex,function(match){chunkObj.endTag=match+chunkObj.endTag;return""})}};Chunks.prototype.trimWhitespace=function(remove){var beforeReplacer,afterReplacer,that=this;if(remove){beforeReplacer=afterReplacer=""}else{beforeReplacer=function(s){that.before+=s;return""};afterReplacer=function(s){that.after=s+that.after;return""}}this.selection=this.selection.replace(/^(\s*)/,beforeReplacer).replace(/(\s*)$/,afterReplacer)};Chunks.prototype.skipLines=function(nLinesBefore,nLinesAfter,findExtraNewlines){if(nLinesBefore===undefined){nLinesBefore=1}if(nLinesAfter===undefined){nLinesAfter=1}nLinesBefore++;nLinesAfter++;var regexText;var replacementText;if(navigator.userAgent.match(/Chrome/)){"X".match(/()./)}this.selection=this.selection.replace(/(^\n*)/,"");this.startTag=this.startTag+re.$1;this.selection=this.selection.replace(/(\n*$)/,"");this.endTag=this.endTag+re.$1;this.startTag=this.startTag.replace(/(^\n*)/,"");this.before=this.before+re.$1;this.endTag=this.endTag.replace(/(\n*$)/,"");this.after=this.after+re.$1;if(this.before){regexText=replacementText="";while(nLinesBefore--){regexText+="\\n?";replacementText+="\n"}if(findExtraNewlines){regexText="\\n*"}this.before=this.before.replace(new re(regexText+"$",""),replacementText)}if(this.after){regexText=replacementText="";while(nLinesAfter--){regexText+="\\n?";replacementText+="\n"}if(findExtraNewlines){regexText="\\n*"}this.after=this.after.replace(new re(regexText,""),replacementText)}};function PanelCollection(postfix){this.buttonBar=doc.getElementById("wmd-button-bar"+postfix);this.preview=doc.getElementById("wmd-preview"+postfix);this.input=doc.getElementById("wmd-input"+postfix)}util.isVisible=function(elem){if(window.getComputedStyle){return window.getComputedStyle(elem,null).getPropertyValue("display")!=="none"}else if(elem.currentStyle){return elem.currentStyle["display"]!=="none"}};util.addEvent=function(elem,event,listener){if(elem.attachEvent){elem.attachEvent("on"+event,listener)}else{elem.addEventListener(event,listener,false)}};util.removeEvent=function(elem,event,listener){if(elem.detachEvent){elem.detachEvent("on"+event,listener)}else{elem.removeEventListener(event,listener,false)}};util.fixEolChars=function(text){text=text.replace(/\r\n/g,"\n");text=text.replace(/\r/g,"\n");return text};util.extendRegExp=function(regex,pre,post){if(pre===null||pre===undefined){pre=""}if(post===null||post===undefined){post=""}var pattern=regex.toString();var flags;pattern=pattern.replace(/\/([gim]*)$/,function(wholeMatch,flagsPart){flags=flagsPart;return""});pattern=pattern.replace(/(^\/|\/$)/g,"");pattern=pre+pattern+post;return new re(pattern,flags)};position.getTop=function(elem,isInner){var result=elem.offsetTop;if(!isInner){while(elem=elem.offsetParent){result+=elem.offsetTop}}return result};position.getHeight=function(elem){return elem.offsetHeight||elem.scrollHeight};position.getWidth=function(elem){return elem.offsetWidth||elem.scrollWidth};position.getPageSize=function(){var scrollWidth,scrollHeight;var innerWidth,innerHeight;if(self.innerHeight&&self.scrollMaxY){scrollWidth=doc.body.scrollWidth;scrollHeight=self.innerHeight+self.scrollMaxY}else if(doc.body.scrollHeight>doc.body.offsetHeight){scrollWidth=doc.body.scrollWidth;scrollHeight=doc.body.scrollHeight}else{scrollWidth=doc.body.offsetWidth;scrollHeight=doc.body.offsetHeight}if(self.innerHeight){innerWidth=self.innerWidth;innerHeight=self.innerHeight}else if(doc.documentElement&&doc.documentElement.clientHeight){innerWidth=doc.documentElement.clientWidth;innerHeight=doc.documentElement.clientHeight}else if(doc.body){innerWidth=doc.body.clientWidth;innerHeight=doc.body.clientHeight}var maxWidth=Math.max(scrollWidth,innerWidth);var maxHeight=Math.max(scrollHeight,innerHeight);return[maxWidth,maxHeight,innerWidth,innerHeight]};function UndoManager(callback,panels){var undoObj=this;var undoStack=[];var stackPtr=0;var mode="none";var lastState;var timer;var inputStateObj;var setMode=function(newMode,noSave){if(mode!=newMode){mode=newMode;if(!noSave){saveState()}}if(!uaSniffed.isIE||mode!="moving"){timer=setTimeout(refreshState,1)}else{inputStateObj=null}};var refreshState=function(isInitialState){inputStateObj=new TextareaState(panels,isInitialState);timer=undefined};this.setCommandMode=function(){mode="command";saveState();timer=setTimeout(refreshState,0)};this.canUndo=function(){return stackPtr>1};this.canRedo=function(){if(undoStack[stackPtr+1]){return true}return false};this.undo=function(){if(undoObj.canUndo()){if(lastState){lastState.restore();lastState=null}else{undoStack[stackPtr]=new TextareaState(panels);undoStack[--stackPtr].restore();if(callback){callback()}}}mode="none";panels.input.focus();refreshState()};this.redo=function(){if(undoObj.canRedo()){undoStack[++stackPtr].restore();if(callback){callback()}}mode="none";panels.input.focus();refreshState()};var saveState=function(){var currState=inputStateObj||new TextareaState(panels);if(!currState){return false}if(mode=="moving"){if(!lastState){lastState=currState}return}if(lastState){if(undoStack[stackPtr-1].text!=lastState.text){undoStack[stackPtr++]=lastState}lastState=null}undoStack[stackPtr++]=currState;undoStack[stackPtr+1]=null;if(callback){callback()}};var handleCtrlYZ=function(event){var handled=false;if(event.ctrlKey||event.metaKey){var keyCode=event.charCode||event.keyCode;var keyCodeChar=String.fromCharCode(keyCode);switch(keyCodeChar){case"y":undoObj.redo();handled=true;break;case"z":if(!event.shiftKey){undoObj.undo()}else{undoObj.redo()}handled=true;break}}if(handled){if(event.preventDefault){event.preventDefault()}if(window.event){window.event.returnValue=false}return}};var handleModeChange=function(event){if(!event.ctrlKey&&!event.metaKey){var keyCode=event.keyCode;if(keyCode>=33&&keyCode<=40||keyCode>=63232&&keyCode<=63235){setMode("moving")}else if(keyCode==8||keyCode==46||keyCode==127){setMode("deleting")}else if(keyCode==13){setMode("newlines")}else if(keyCode==27){setMode("escape")}else if((keyCode<16||keyCode>20)&&keyCode!=91){setMode("typing")}}};var setEventHandlers=function(){util.addEvent(panels.input,"keypress",function(event){if((event.ctrlKey||event.metaKey)&&(event.keyCode==89||event.keyCode==90)){event.preventDefault()}});var handlePaste=function(){if(uaSniffed.isIE||inputStateObj&&inputStateObj.text!=panels.input.value){if(timer==undefined){mode="paste";saveState();refreshState()}}};util.addEvent(panels.input,"keydown",handleCtrlYZ);util.addEvent(panels.input,"keydown",handleModeChange);util.addEvent(panels.input,"mousedown",function(){setMode("moving")});panels.input.onpaste=handlePaste;panels.input.ondrop=handlePaste};var init=function(){setEventHandlers();refreshState(true);saveState()};init()}function TextareaState(panels,isInitialState){var stateObj=this;var inputArea=panels.input;this.init=function(){if(!util.isVisible(inputArea)){return}if(!isInitialState&&doc.activeElement&&doc.activeElement!==inputArea){return}this.setInputAreaSelectionStartEnd();this.scrollTop=inputArea.scrollTop;if(!this.text&&inputArea.selectionStart||inputArea.selectionStart===0){this.text=inputArea.value}};this.setInputAreaSelection=function(){if(!util.isVisible(inputArea)){return}if(inputArea.selectionStart!==undefined&&!uaSniffed.isOpera){inputArea.focus();inputArea.selectionStart=stateObj.start;inputArea.selectionEnd=stateObj.end;inputArea.scrollTop=stateObj.scrollTop}else if(doc.selection){if(doc.activeElement&&doc.activeElement!==inputArea){return}inputArea.focus();var range=inputArea.createTextRange();range.moveStart("character",-inputArea.value.length);range.moveEnd("character",-inputArea.value.length);range.moveEnd("character",stateObj.end);range.moveStart("character",stateObj.start);range.select()}};this.setInputAreaSelectionStartEnd=function(){if(!panels.ieCachedRange&&(inputArea.selectionStart||inputArea.selectionStart===0)){stateObj.start=inputArea.selectionStart;stateObj.end=inputArea.selectionEnd}else if(doc.selection){stateObj.text=util.fixEolChars(inputArea.value);var range=panels.ieCachedRange||doc.selection.createRange();var fixedRange=util.fixEolChars(range.text);var marker="";var markedRange=marker+fixedRange+marker;range.text=markedRange;var inputText=util.fixEolChars(inputArea.value);range.moveStart("character",-markedRange.length);range.text=fixedRange;stateObj.start=inputText.indexOf(marker);stateObj.end=inputText.lastIndexOf(marker)-marker.length;var len=stateObj.text.length-util.fixEolChars(inputArea.value).length;if(len){range.moveStart("character",-fixedRange.length);while(len--){fixedRange+="\n";stateObj.end+=1}range.text=fixedRange}if(panels.ieCachedRange)stateObj.scrollTop=panels.ieCachedScrollTop;panels.ieCachedRange=null;this.setInputAreaSelection()}};this.restore=function(){if(stateObj.text!=undefined&&stateObj.text!=inputArea.value){inputArea.value=stateObj.text}this.setInputAreaSelection();inputArea.scrollTop=stateObj.scrollTop};this.getChunks=function(){var chunk=new Chunks;chunk.before=util.fixEolChars(stateObj.text.substring(0,stateObj.start));chunk.startTag="";chunk.selection=util.fixEolChars(stateObj.text.substring(stateObj.start,stateObj.end));chunk.endTag="";chunk.after=util.fixEolChars(stateObj.text.substring(stateObj.end));chunk.scrollTop=stateObj.scrollTop;return chunk};this.setChunks=function(chunk){chunk.before=chunk.before+chunk.startTag;chunk.after=chunk.endTag+chunk.after;this.start=chunk.before.length;this.end=chunk.before.length+chunk.selection.length;this.text=chunk.before+chunk.selection+chunk.after;this.scrollTop=chunk.scrollTop};this.init()}function PreviewManager(converter,panels,previewPushCallback){var managerObj=this;var timeout;var elapsedTime;var oldInputText;var maxDelay=3e3;var startType="delayed";var setupEvents=function(inputElem,listener){util.addEvent(inputElem,"input",listener);inputElem.onpaste=listener;inputElem.ondrop=listener;util.addEvent(inputElem,"keypress",listener);util.addEvent(inputElem,"keydown",listener)};var getDocScrollTop=function(){var result=0;if(window.innerHeight){result=window.pageYOffset}else if(doc.documentElement&&doc.documentElement.scrollTop){result=doc.documentElement.scrollTop}else if(doc.body){result=doc.body.scrollTop}return result};var makePreviewHtml=function(){if(!panels.preview)return;var text=panels.input.value;if(text&&text==oldInputText){return}else{oldInputText=text}var prevTime=(new Date).getTime();text=converter.makeHtml(text);var currTime=(new Date).getTime();elapsedTime=currTime-prevTime;pushPreviewHtml(text)};var applyTimeout=function(){if(timeout){clearTimeout(timeout);timeout=undefined}if(startType!=="manual"){var delay=0;
if(startType==="delayed"){delay=elapsedTime}if(delay>maxDelay){delay=maxDelay}timeout=setTimeout(makePreviewHtml,delay)}};var getScaleFactor=function(panel){if(panel.scrollHeight<=panel.clientHeight){return 1}return panel.scrollTop/(panel.scrollHeight-panel.clientHeight)};var setPanelScrollTops=function(){if(panels.preview){panels.preview.scrollTop=(panels.preview.scrollHeight-panels.preview.clientHeight)*getScaleFactor(panels.preview)}};this.refresh=function(requiresRefresh){if(requiresRefresh){oldInputText="";makePreviewHtml()}else{applyTimeout()}};this.processingTime=function(){return elapsedTime};var isFirstTimeFilled=true;var ieSafePreviewSet=function(text){var preview=panels.preview;var parent=preview.parentNode;var sibling=preview.nextSibling;parent.removeChild(preview);preview.innerHTML=text;if(!sibling)parent.appendChild(preview);else parent.insertBefore(preview,sibling)};var nonSuckyBrowserPreviewSet=function(text){panels.preview.innerHTML=text};var previewSetter;var previewSet=function(text){if(previewSetter)return previewSetter(text);try{nonSuckyBrowserPreviewSet(text);previewSetter=nonSuckyBrowserPreviewSet}catch(e){previewSetter=ieSafePreviewSet;previewSetter(text)}};var pushPreviewHtml=function(text){var emptyTop=position.getTop(panels.input)-getDocScrollTop();if(panels.preview){previewPushCallback(text,previewSet)}setPanelScrollTops();if(isFirstTimeFilled){isFirstTimeFilled=false;return}var fullTop=position.getTop(panels.input)-getDocScrollTop();if(uaSniffed.isIE){setTimeout(function(){window.scrollBy(0,fullTop-emptyTop)},0)}else{window.scrollBy(0,fullTop-emptyTop)}};var init=function(){setupEvents(panels.input,applyTimeout);makePreviewHtml();if(panels.preview){panels.preview.scrollTop=0}};init()}ui.createBackground=function(){var background=doc.createElement("div"),style=background.style;background.className="wmd-prompt-background";style.position="absolute";style.top="0";style.zIndex="1000";if(uaSniffed.isIE){style.filter="alpha(opacity=50)"}else{style.opacity="0.5"}var pageSize=position.getPageSize();style.height=pageSize[1]+"px";if(uaSniffed.isIE){style.left=doc.documentElement.scrollLeft;style.width=doc.documentElement.clientWidth}else{style.left="0";style.width="100%"}doc.body.appendChild(background);return background};ui.prompt=function(text,defaultInputText,callback,imageUploadHandler){var dialog;var input;if(defaultInputText===undefined){defaultInputText=""}var checkEscape=function(key){var code=key.charCode||key.keyCode;if(code===27){close(true)}};var close=function(isCancel){util.removeEvent(doc.body,"keydown",checkEscape);var text=input.value;if(isCancel){text=null}else{text=text.replace(/^http:\/\/(https?|ftp):\/\//,"$1://");if(!/^(?:https?|ftp):\/\//.test(text)&&text.charAt(0)!="/"){text="http://"+text}}dialog.parentNode.removeChild(dialog);callback(text);return false};var createDialog=function(){dialog=doc.createElement("div");dialog.setAttribute("role","dialog");dialog.className="wmd-prompt-dialog";dialog.style.padding="10px;";dialog.style.position="fixed";dialog.style.width="400px";dialog.style.zIndex="1001";var question=doc.createElement("div");question.innerHTML=text;question.style.padding="5px";dialog.appendChild(question);var form=doc.createElement("form"),style=form.style;form.onsubmit=function(){return close(false)};style.padding="0";style.margin="0";style.cssFloat="left";style.width="100%";style.textAlign="center";style.position="relative";dialog.appendChild(form);input=doc.createElement("input");input.type="text";input.value=defaultInputText;style=input.style;style.display="block";style.width="80%";style.marginLeft=style.marginRight="auto";form.appendChild(input);if(imageUploadHandler){var chooseFile=doc.createElement("input");chooseFile.type="file";chooseFile.name="file-upload";chooseFile.id="file-upload";chooseFile.onchange=function(){imageUploadHandler(this,input)};form.appendChild(doc.createElement("br"));form.appendChild(chooseFile)}var okButton=doc.createElement("input");okButton.type="button";okButton.onclick=function(){return close(false)};okButton.value="OK";style=okButton.style;style.margin="10px";style.display="inline";style.width="7em";var cancelButton=doc.createElement("input");cancelButton.type="button";cancelButton.onclick=function(){return close(true)};cancelButton.value="Cancel";style=cancelButton.style;style.margin="10px";style.display="inline";style.width="7em";form.appendChild(okButton);form.appendChild(cancelButton);util.addEvent(doc.body,"keydown",checkEscape);dialog.style.top="50%";dialog.style.left="50%";dialog.style.display="block";if(uaSniffed.isIE_5or6){dialog.style.position="absolute";dialog.style.top=doc.documentElement.scrollTop+200+"px";dialog.style.left="50%"}doc.body.appendChild(dialog);dialog.style.marginTop=-(position.getHeight(dialog)/2)+"px";dialog.style.marginLeft=-(position.getWidth(dialog)/2)+"px"};setTimeout(function(){createDialog();var defTextLen=defaultInputText.length;if(input.selectionStart!==undefined){input.selectionStart=0;input.selectionEnd=defTextLen}else if(input.createTextRange){var range=input.createTextRange();range.collapse(false);range.moveStart("character",-defTextLen);range.moveEnd("character",defTextLen);range.select()}input.focus()},0)};function UIManager(postfix,panels,undoManager,previewManager,commandManager,helpOptions,imageUploadHandler){var inputBox=panels.input,buttons={};makeSpritedButtonRow();var keyEvent="keydown";if(uaSniffed.isOpera){keyEvent="keypress"}util.addEvent(inputBox,keyEvent,function(key){if((key.ctrlKey||key.metaKey)&&!key.altKey&&!key.shiftKey){var keyCode=key.charCode||key.keyCode;var keyCodeStr=String.fromCharCode(keyCode).toLowerCase();switch(keyCodeStr){case"b":doClick(buttons.bold);break;case"i":doClick(buttons.italic);break;case"l":doClick(buttons.link);break;case"q":doClick(buttons.quote);break;case"k":doClick(buttons.code);break;case"g":doClick(buttons.image);break;case"o":doClick(buttons.olist);break;case"u":doClick(buttons.ulist);break;case"h":doClick(buttons.heading);break;case"r":doClick(buttons.hr);break;case"y":doClick(buttons.redo);break;case"z":if(key.shiftKey){doClick(buttons.redo)}else{doClick(buttons.undo)}break;default:return}if(key.preventDefault){key.preventDefault()}if(window.event){window.event.returnValue=false}}});util.addEvent(inputBox,"keyup",function(key){if(key.shiftKey&&!key.ctrlKey&&!key.metaKey){var keyCode=key.charCode||key.keyCode;if(keyCode===13){var fakeButton={};fakeButton.textOp=bindCommand("doAutoindent");doClick(fakeButton)}}});if(uaSniffed.isIE){util.addEvent(inputBox,"keydown",function(key){var code=key.keyCode;if(code===27){return false}})}function doClick(button){inputBox.focus();if(button.textOp){if(undoManager){undoManager.setCommandMode()}var state=new TextareaState(panels);if(!state){return}var chunks=state.getChunks();var fixupInputArea=function(){inputBox.focus();if(chunks){state.setChunks(chunks)}state.restore();previewManager.refresh()};var noCleanup=button.textOp(chunks,fixupInputArea);if(!noCleanup){fixupInputArea()}}if(button.execute){button.execute(undoManager)}}function setupButton(button,isEnabled){var normalYShift="0px";var disabledYShift="-20px";var highlightYShift="-40px";var image=button.getElementsByTagName("span")[0];if(isEnabled){image.style.backgroundPosition=button.XShift+" "+normalYShift;button.onmouseover=function(){image.style.backgroundPosition=this.XShift+" "+highlightYShift};button.onmouseout=function(){image.style.backgroundPosition=this.XShift+" "+normalYShift};if(uaSniffed.isIE){button.onmousedown=function(){if(doc.activeElement&&doc.activeElement!==panels.input){return}panels.ieCachedRange=document.selection.createRange();panels.ieCachedScrollTop=panels.input.scrollTop}}if(!button.isHelp){button.onclick=function(){if(this.onmouseout){this.onmouseout()}doClick(this);return false};util.addEvent(button,"keydown",function(event){var keyCode=event.charCode||event.keyCode;if(keyCode==32||keyCode==13){if(event.preventDefault){event.preventDefault()}if(window.event){window.event.returnValue=false}doClick(button)}})}}else{image.style.backgroundPosition=button.XShift+" "+disabledYShift;button.onmouseover=button.onmouseout=button.onclick=function(){}}}function bindCommand(method){if(typeof method==="string")method=commandManager[method];return function(){method.apply(commandManager,arguments)}}function makeSpritedButtonRow(){var buttonBar=panels.buttonBar;var normalYShift="0px";var disabledYShift="-20px";var highlightYShift="-40px";var buttonRow=document.createElement("div");buttonRow.setAttribute("role","toolbar");buttonRow.id="wmd-button-row"+postfix;buttonRow.className="wmd-button-row";buttonRow=buttonBar.appendChild(buttonRow);var xPosition=0;var makeButton=function(id,title,XShift,textOp){var button=document.createElement("span");button.setAttribute("role","button");button.tabIndex=0;button.className="wmd-button";button.style.left=xPosition+"px";xPosition+=25;var buttonImage=document.createElement("span");button.id=id+postfix;button.appendChild(buttonImage);button.title=title;button.XShift=XShift;if(textOp)button.textOp=textOp;setupButton(button,true);buttonRow.appendChild(button);return button};var makeSpacer=function(num){var spacer=document.createElement("span");spacer.setAttribute("role","separator");spacer.className="wmd-spacer wmd-spacer"+num;spacer.id="wmd-spacer"+num+postfix;buttonRow.appendChild(spacer);xPosition+=25};buttons.bold=makeButton("wmd-bold-button",gettext("Bold (Ctrl+B)"),"0px",bindCommand("doBold"));buttons.italic=makeButton("wmd-italic-button",gettext("Italic (Ctrl+I)"),"-20px",bindCommand("doItalic"));makeSpacer(1);buttons.link=makeButton("wmd-link-button",gettext("Hyperlink (Ctrl+L)"),"-40px",bindCommand(function(chunk,postProcessing){return this.doLinkOrImage(chunk,postProcessing,false)}));buttons.quote=makeButton("wmd-quote-button",gettext("Blockquote (Ctrl+Q)"),"-60px",bindCommand("doBlockquote"));buttons.code=makeButton("wmd-code-button",gettext("Code Sample (Ctrl+K)"),"-80px",bindCommand("doCode"));buttons.image=makeButton("wmd-image-button",gettext("Image (Ctrl+G)"),"-100px",bindCommand(function(chunk,postProcessing){return this.doLinkOrImage(chunk,postProcessing,true,imageUploadHandler)}));makeSpacer(2);buttons.olist=makeButton("wmd-olist-button",gettext("Numbered List (Ctrl+O)"),"-120px",bindCommand(function(chunk,postProcessing){this.doList(chunk,postProcessing,true)}));buttons.ulist=makeButton("wmd-ulist-button",gettext("Bulleted List (Ctrl+U)"),"-140px",bindCommand(function(chunk,postProcessing){this.doList(chunk,postProcessing,false)}));buttons.heading=makeButton("wmd-heading-button",gettext("Heading (Ctrl+H)"),"-160px",bindCommand("doHeading"));buttons.hr=makeButton("wmd-hr-button",gettext("Horizontal Rule (Ctrl+R)"),"-180px",bindCommand("doHorizontalRule"));makeSpacer(3);buttons.undo=makeButton("wmd-undo-button",gettext("Undo (Ctrl+Z)"),"-200px",null);buttons.undo.execute=function(manager){if(manager)manager.undo()};var redoTitle=/win/.test(nav.platform.toLowerCase())?gettext("Redo (Ctrl+Y)"):gettext("Redo (Ctrl+Shift+Z)");buttons.redo=makeButton("wmd-redo-button",redoTitle,"-220px",null);buttons.redo.execute=function(manager){if(manager)manager.redo()};if(helpOptions){var helpButton=document.createElement("span");var helpButtonImage=document.createElement("span");helpButton.appendChild(helpButtonImage);helpButton.className="wmd-button wmd-help-button";helpButton.id="wmd-help-button"+postfix;helpButton.XShift="-240px";helpButton.isHelp=true;helpButton.style.right="0px";helpButton.title=helpOptions.title||defaultHelpHoverTitle;helpButton.onclick=helpOptions.handler;setupButton(helpButton,true);buttonRow.appendChild(helpButton);buttons.help=helpButton}setUndoRedoButtonStates()}function setUndoRedoButtonStates(){if(undoManager){setupButton(buttons.undo,undoManager.canUndo());setupButton(buttons.redo,undoManager.canRedo())}}this.setUndoRedoButtonStates=setUndoRedoButtonStates}function CommandManager(pluginHooks){this.hooks=pluginHooks}var commandProto=CommandManager.prototype;commandProto.prefixes="(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)";commandProto.unwrap=function(chunk){var txt=new re("([^\\n])\\n(?!(\\n|"+this.prefixes+"))","g");chunk.selection=chunk.selection.replace(txt,"$1 $2")};commandProto.wrap=function(chunk,len){this.unwrap(chunk);var regex=new re("(.{1,"+len+"})( +|$\\n?)","gm"),that=this;chunk.selection=chunk.selection.replace(regex,function(line,marked){if(new re("^"+that.prefixes,"").test(line)){return line}return marked+"\n"});chunk.selection=chunk.selection.replace(/\s+$/,"")};commandProto.doBold=function(chunk,postProcessing){return this.doBorI(chunk,postProcessing,2,gettext("strong text"))};commandProto.doItalic=function(chunk,postProcessing){return this.doBorI(chunk,postProcessing,1,gettext("emphasized text"))};commandProto.doBorI=function(chunk,postProcessing,nStars,insertText){chunk.trimWhitespace();chunk.selection=chunk.selection.replace(/\n{2,}/g,"\n");var starsBefore=/(\**$)/.exec(chunk.before)[0];var starsAfter=/(^\**)/.exec(chunk.after)[0];var prevStars=Math.min(starsBefore.length,starsAfter.length);if(prevStars>=nStars&&(prevStars!=2||nStars!=1)){chunk.before=chunk.before.replace(re("[*]{"+nStars+"}$",""),"");chunk.after=chunk.after.replace(re("^[*]{"+nStars+"}",""),"")}else if(!chunk.selection&&starsAfter){chunk.after=chunk.after.replace(/^([*_]*)/,"");chunk.before=chunk.before.replace(/(\s?)$/,"");var whitespace=re.$1;chunk.before=chunk.before+starsAfter+whitespace}else{if(!chunk.selection&&!starsAfter){chunk.selection=insertText}var markup=nStars<=1?"*":"**";chunk.before=chunk.before+markup;chunk.after=markup+chunk.after}return};commandProto.stripLinkDefs=function(text,defsToAdd){text=text.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,function(totalMatch,id,link,newlines,title){defsToAdd[id]=totalMatch.replace(/\s*$/,"");if(newlines){defsToAdd[id]=totalMatch.replace(/["(](.+?)[")]$/,"");return newlines+title}return""});return text};commandProto.addLinkDef=function(chunk,linkDef){var refNumber=0;var defsToAdd={};chunk.before=this.stripLinkDefs(chunk.before,defsToAdd);chunk.selection=this.stripLinkDefs(chunk.selection,defsToAdd);chunk.after=this.stripLinkDefs(chunk.after,defsToAdd);var defs="";var regex=/(\[)((?:\[[^\]]*\]|[^\[\]])*)(\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g;var addDefNumber=function(def){refNumber++;def=def.replace(/^[ ]{0,3}\[(\d+)\]:/,"  ["+refNumber+"]:");defs+="\n"+def};var getLink=function(wholeMatch,before,inner,afterInner,id,end){inner=inner.replace(regex,getLink);if(defsToAdd[id]){addDefNumber(defsToAdd[id]);return before+inner+afterInner+refNumber+end}return wholeMatch};chunk.before=chunk.before.replace(regex,getLink);if(linkDef){addDefNumber(linkDef)}else{chunk.selection=chunk.selection.replace(regex,getLink)}var refOut=refNumber;chunk.after=chunk.after.replace(regex,getLink);if(chunk.after){chunk.after=chunk.after.replace(/\n*$/,"")}if(!chunk.after){chunk.selection=chunk.selection.replace(/\n*$/,"")}chunk.after+="\n\n"+defs;return refOut};function properlyEncoded(linkdef){return linkdef.replace(/^\s*(.*?)(?:\s+"(.+)")?\s*$/,function(wholematch,link,title){link=link.replace(/\?.*$/,function(querypart){return querypart.replace(/\+/g," ")});link=decodeURIComponent(link);link=encodeURI(link).replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29");link=link.replace(/\?.*$/,function(querypart){return querypart.replace(/\+/g,"%2b")});if(title){title=title.trim?title.trim():title.replace(/^\s*/,"").replace(/\s*$/,"");title=$.trim(title).replace(/"/g,"quot;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}return title?link+' "'+title+'"':link})}commandProto.doLinkOrImage=function(chunk,postProcessing,isImage,imageUploadHandler){chunk.trimWhitespace();chunk.findTags(/\s*!?\[/,/\][ ]?(?:\n[ ]*)?(\[.*?\])?/);var background;if(chunk.endTag.length>1&&chunk.startTag.length>0){chunk.startTag=chunk.startTag.replace(/!?\[/,"");chunk.endTag="";this.addLinkDef(chunk,null)}else{chunk.selection=chunk.startTag+chunk.selection+chunk.endTag;chunk.startTag=chunk.endTag="";if(/\n\n/.test(chunk.selection)){this.addLinkDef(chunk,null);return}var that=this;var linkEnteredCallback=function(link){background.parentNode.removeChild(background);if(link!==null){chunk.selection=(" "+chunk.selection).replace(/([^\\](?:\\\\)*)(?=[[\]])/g,"$1\\").substr(1);var linkDef=" [999]: "+properlyEncoded(link);var num=that.addLinkDef(chunk,linkDef);chunk.startTag=isImage?"![":"[";chunk.endTag="]["+num+"]";if(!chunk.selection){if(isImage){chunk.selection=gettext("enter image description here")}else{chunk.selection=gettext("enter link description here")}}}postProcessing()};background=ui.createBackground();if(isImage){if(!this.hooks.insertImageDialog(linkEnteredCallback))ui.prompt(imageDialogText,imageDefaultText,linkEnteredCallback,imageUploadHandler)}else{ui.prompt(linkDialogText,linkDefaultText,linkEnteredCallback)}return true}};commandProto.doAutoindent=function(chunk,postProcessing){var commandMgr=this,fakeSelection=false;chunk.before=chunk.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/,"\n\n");chunk.before=chunk.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/,"\n\n");chunk.before=chunk.before.replace(/(\n|^)[ \t]+\n$/,"\n\n");if(!chunk.selection&&!/^[ \t]*(?:\n|$)/.test(chunk.after)){chunk.after=chunk.after.replace(/^[^\n]*/,function(wholeMatch){chunk.selection=wholeMatch;return""});fakeSelection=true}if(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]+.*\n$/.test(chunk.before)){if(commandMgr.doList){commandMgr.doList(chunk)}}if(/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(chunk.before)){if(commandMgr.doBlockquote){commandMgr.doBlockquote(chunk)}}if(/(\n|^)(\t|[ ]{4,}).*\n$/.test(chunk.before)){if(commandMgr.doCode){commandMgr.doCode(chunk)}}if(fakeSelection){chunk.after=chunk.selection+chunk.after;chunk.selection=""}};commandProto.doBlockquote=function(chunk,postProcessing){chunk.selection=chunk.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,function(totalMatch,newlinesBefore,text,newlinesAfter){chunk.before+=newlinesBefore;chunk.after=newlinesAfter+chunk.after;return text});chunk.before=chunk.before.replace(/(>[ \t]*)$/,function(totalMatch,blankLine){chunk.selection=blankLine+chunk.selection;return""});chunk.selection=chunk.selection.replace(/^(\s|>)+$/,"");chunk.selection=chunk.selection||gettext("Blockquote");var match="",leftOver="",line;if(chunk.before){var lines=chunk.before.replace(/\n$/,"").split("\n");var inChain=false;for(var i=0;i<lines.length;i++){var good=false;line=lines[i];inChain=inChain&&line.length>0;if(/^>/.test(line)){good=true;if(!inChain&&line.length>1)inChain=true}else if(/^[ \t]*$/.test(line)){good=true}else{good=inChain}if(good){match+=line+"\n"}else{leftOver+=match+line;match="\n"}}if(!/(^|\n)>/.test(match)){leftOver+=match;match=""}}chunk.startTag=match;chunk.before=leftOver;if(chunk.after){chunk.after=chunk.after.replace(/^\n?/,"\n")}chunk.after=chunk.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,function(totalMatch){chunk.endTag=totalMatch;return""});var replaceBlanksInTags=function(useBracket){var replacement=useBracket?"> ":"";if(chunk.startTag){chunk.startTag=chunk.startTag.replace(/\n((>|\s)*)\n$/,function(totalMatch,markdown){return"\n"+markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm,replacement)+"\n"})}if(chunk.endTag){chunk.endTag=chunk.endTag.replace(/^\n((>|\s)*)\n/,function(totalMatch,markdown){return"\n"+markdown.replace(/^[ ]{0,3}>?[ \t]*$/gm,replacement)+"\n"})}};if(/^(?![ ]{0,3}>)/m.test(chunk.selection)){this.wrap(chunk,SETTINGS.lineLength-2);chunk.selection=chunk.selection.replace(/^/gm,"> ");replaceBlanksInTags(true);chunk.skipLines()}else{chunk.selection=chunk.selection.replace(/^[ ]{0,3}> ?/gm,"");this.unwrap(chunk);replaceBlanksInTags(false);if(!/^(\n|^)[ ]{0,3}>/.test(chunk.selection)&&chunk.startTag){chunk.startTag=chunk.startTag.replace(/\n{0,2}$/,"\n\n")}if(!/(\n|^)[ ]{0,3}>.*$/.test(chunk.selection)&&chunk.endTag){chunk.endTag=chunk.endTag.replace(/^\n{0,2}/,"\n\n")}}chunk.selection=this.hooks.postBlockquoteCreation(chunk.selection);if(!/\n/.test(chunk.selection)){chunk.selection=chunk.selection.replace(/^(> *)/,function(wholeMatch,blanks){chunk.startTag+=blanks;return""})}};commandProto.doCode=function(chunk,postProcessing){var hasTextBefore=/\S[ ]*$/.test(chunk.before);var hasTextAfter=/^[ ]*\S/.test(chunk.after);if(!hasTextAfter&&!hasTextBefore||/\n/.test(chunk.selection)){chunk.before=chunk.before.replace(/[ ]{4}$/,function(totalMatch){chunk.selection=totalMatch+chunk.selection;return""});var nLinesBack=1;var nLinesForward=1;if(/(\n|^)(\t|[ ]{4,}).*\n$/.test(chunk.before)){nLinesBack=0}if(/^\n(\t|[ ]{4,})/.test(chunk.after)){nLinesForward=0}chunk.skipLines(nLinesBack,nLinesForward);if(!chunk.selection){chunk.startTag="    ";chunk.selection=gettext("enter code here")}else{if(/^[ ]{0,3}\S/m.test(chunk.selection)){if(/\n/.test(chunk.selection))chunk.selection=chunk.selection.replace(/^/gm,"    ");else chunk.before+="    "}else{chunk.selection=chunk.selection.replace(/^[ ]{4}/gm,"")}}}else{chunk.trimWhitespace();chunk.findTags(/`/,/`/);if(!chunk.startTag&&!chunk.endTag){chunk.startTag=chunk.endTag="`";if(!chunk.selection){chunk.selection=gettext("enter code here")}}else if(chunk.endTag&&!chunk.startTag){chunk.before+=chunk.endTag;chunk.endTag=""}else{chunk.startTag=chunk.endTag=""}}};commandProto.doList=function(chunk,postProcessing,isNumberedList){var previousItemsRegex=/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/;var nextItemsRegex=/^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/;var bullet="-";var num=1;var getItemPrefix=function(){var prefix;if(isNumberedList){prefix=" "+num+". ";num++}else{prefix=" "+bullet+" "}return prefix};var getPrefixedItem=function(itemText){if(isNumberedList===undefined){isNumberedList=/^\s*\d/.test(itemText)}itemText=itemText.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,function(_){return getItemPrefix()});return itemText};chunk.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/,null);if(chunk.before&&!/\n$/.test(chunk.before)&&!/^\n/.test(chunk.startTag)){chunk.before+=chunk.startTag;chunk.startTag=""}if(chunk.startTag){var hasDigits=/\d+[.]/.test(chunk.startTag);chunk.startTag="";chunk.selection=chunk.selection.replace(/\n[ ]{4}/g,"\n");this.unwrap(chunk);chunk.skipLines();if(hasDigits){chunk.after=chunk.after.replace(nextItemsRegex,getPrefixedItem)}if(isNumberedList==hasDigits){return}}var nLinesUp=1;chunk.before=chunk.before.replace(previousItemsRegex,function(itemText){if(/^\s*([*+-])/.test(itemText)){bullet=re.$1}nLinesUp=/[^\n]\n\n[^\n]/.test(itemText)?1:0;return getPrefixedItem(itemText)});if(!chunk.selection){chunk.selection=gettext("List item")}var prefix=getItemPrefix();var nLinesDown=1;chunk.after=chunk.after.replace(nextItemsRegex,function(itemText){nLinesDown=/[^\n]\n\n[^\n]/.test(itemText)?1:0;return getPrefixedItem(itemText)});chunk.trimWhitespace(true);chunk.skipLines(nLinesUp,nLinesDown,true);chunk.startTag=prefix;var spaces=prefix.replace(/./g," ");this.wrap(chunk,SETTINGS.lineLength-spaces.length);chunk.selection=chunk.selection.replace(/\n/g,"\n"+spaces)};commandProto.doHeading=function(chunk,postProcessing){chunk.selection=chunk.selection.replace(/\s+/g," ");chunk.selection=chunk.selection.replace(/(^\s+|\s+$)/g,"");if(!chunk.selection){chunk.startTag="## ";chunk.selection=gettext("Heading");chunk.endTag=" ##";return}var headerLevel=0;chunk.findTags(/#+[ ]*/,/[ ]*#+/);if(/#+/.test(chunk.startTag)){headerLevel=re.lastMatch.length}chunk.startTag=chunk.endTag="";chunk.findTags(null,/\s?(-+|=+)/);if(/=+/.test(chunk.endTag)){headerLevel=1}if(/-+/.test(chunk.endTag)){headerLevel=2}chunk.startTag=chunk.endTag="";chunk.skipLines(1,1);var headerLevelToCreate=headerLevel==0?2:headerLevel-1;if(headerLevelToCreate>0){var headerChar=headerLevelToCreate>=2?"-":"=";var len=chunk.selection.length;if(len>SETTINGS.lineLength){len=SETTINGS.lineLength}chunk.endTag="\n";while(len--){chunk.endTag+=headerChar}}};commandProto.doHorizontalRule=function(chunk,postProcessing){chunk.startTag="----------\n";chunk.selection="";chunk.skipLines(2,1,true)}})();(function(){var getTime;getTime=function(){return(new Date).getTime()};this.MathJaxDelayRenderer=function(){var bufferId,numBuffers;MathJaxDelayRenderer.prototype.maxDelay=3e3;MathJaxDelayRenderer.prototype.mathjaxRunning=false;MathJaxDelayRenderer.prototype.elapsedTime=0;MathJaxDelayRenderer.prototype.mathjaxDelay=0;MathJaxDelayRenderer.prototype.mathjaxTimeout=void 0;bufferId="mathjax_delay_buffer";numBuffers=0;function MathJaxDelayRenderer(params){params=params||{};this.maxDelay=params["maxDelay"]||this.maxDelay;this.bufferId=params["bufferId"]||bufferId+numBuffers;numBuffers+=1;this.$buffer=$("<div>").attr("id",this.bufferId).css("display","none").appendTo($("body"))}MathJaxDelayRenderer.prototype.render=function(params){var delay,elem,preprocessor,previewSetter,renderer,text,_this=this;elem=params["element"];previewSetter=params["previewSetter"];text=params["text"];if(text==null){text=$(elem).html()}preprocessor=params["preprocessor"];if(params["delay"]===false){if(preprocessor!=null){text=preprocessor(text)}$(elem).html(text);return MathJax.Hub.Queue(["Typeset",MathJax.Hub,$(elem).attr("id")])}else{if(this.mathjaxTimeout){window.clearTimeout(this.mathjaxTimeout);this.mathjaxTimeout=void 0}delay=Math.min(this.elapsedTime+this.mathjaxDelay,this.maxDelay);renderer=function(){var curTime,prevTime;if(_this.mathjaxRunning){return}prevTime=getTime();if(preprocessor!=null){text=preprocessor(text)}_this.$buffer.html(text);curTime=getTime();_this.elapsedTime=curTime-prevTime;if(MathJax){prevTime=getTime();_this.mathjaxRunning=true;return MathJax.Hub.Queue(["Typeset",MathJax.Hub,_this.$buffer.attr("id")],function(){_this.mathjaxRunning=false;curTime=getTime();_this.mathjaxDelay=curTime-prevTime;if(previewSetter){return previewSetter($(_this.$buffer).html())}else{return $(elem).html($(_this.$buffer).html())}})}else{return _this.mathjaxDelay=0}};return this.mathjaxTimeout=window.setTimeout(renderer,delay)}};return MathJaxDelayRenderer}()}).call(this);(function(){$(function(){var HUB,MathJaxProcessor;if(typeof MathJax==="undefined"||MathJax===null){return}HUB=MathJax.Hub;MathJaxProcessor=function(){var CODESPAN,MATHSPLIT;MATHSPLIT=/(\$\$?|\\(?:begin|end)\{[a-z]*\*?\}|\\[\\{}$]|[{}]|(?:\n\s*)+|@@\d+@@)/i;CODESPAN=/(^|[^\\])(`+)([^\n]*?[^`\n])\2(?!`)/gm;function MathJaxProcessor(inlineMark,displayMark){this.inlineMark=inlineMark||"$";this.displayMark=displayMark||"$$";this.math=null;this.blocks=null}MathJaxProcessor.prototype.processMath=function(start,last,preProcess){var block,i,_i,_ref;block=this.blocks.slice(start,last+1).join("").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");if(HUB.Browser.isMSIE){block=block.replace(/(%[^\n]*)\n/g,"$1<br/>\n")}for(i=_i=_ref=start+1;_ref<=last?_i<=last:_i>=last;i=_ref<=last?++_i:--_i){this.blocks[i]=""}this.blocks[start]="@@"+this.math.length+"@@";if(preProcess){block=preProcess(block)}return this.math.push(block)};MathJaxProcessor.prototype.removeMath=function(text){var block,braces,current,deTilde,end,hasCodeSpans,last,start,_i,_ref;text=text||"";this.math=[];start=end=last=null;braces=0;hasCodeSpans=/`/.test(text);if(hasCodeSpans){text=text.replace(/~/g,"~T").replace(CODESPAN,function($0){return $0.replace(/\$/g,"~D")});deTilde=function(text){return text.replace(/~([TD])/g,function($0,$1){return{T:"~",D:"$"}[$1]})}}else{deTilde=function(text){return text}}this.blocks=_split(text.replace(/\r\n?/g,"\n"),MATHSPLIT);for(current=_i=1,_ref=this.blocks.length;_i<_ref;current=_i+=2){block=this.blocks[current];if(block.charAt(0)==="@"){this.blocks[current]="@@"+this.math.length+"@@";this.math.push(block)}else if(start){if(block===end){if(braces){last=current}else{this.processMath(start,current,deTilde);start=end=last=null}}else if(block.match(/\n.*\n/)){if(last){current=last;this.processMath(start,current,deTilde)}start=end=last=null;braces=0}else if(block==="{"){++braces}else if(block==="}"&&braces){--braces}}else{if(block===this.inlineMark||block===this.displayMark){start=current;end=block;braces=0}else if(block.substr(1,5)==="begin"){start=current;end="\\end"+block.substr(6);braces=0}}}if(last){this.processMath(start,last,deTilde);start=end=last=null}return deTilde(this.blocks.join(""))};MathJaxProcessor.removeMathWrapper=function(_this){return function(text){return _this.removeMath(text)}};MathJaxProcessor.prototype.replaceMath=function(text){var _this=this;text=text.replace(/@@(\d+)@@/g,function($0,$1){return _this.math[$1]});this.math=null;return text};MathJaxProcessor.replaceMathWrapper=function(_this){return function(text){return _this.replaceMath(text)}};return MathJaxProcessor}();if(typeof Markdown!=="undefined"&&Markdown!==null){Markdown.getMathCompatibleConverter=function(postProcessor){var converter,processor;postProcessor||(postProcessor=function(text){return text});converter=Markdown.getSanitizingConverter();processor=new MathJaxProcessor;converter.hooks.chain("preConversion",MathJaxProcessor.removeMathWrapper(processor));converter.hooks.chain("postConversion",function(text){return postProcessor(MathJaxProcessor.replaceMathWrapper(processor)(text))});return converter};return Markdown.makeWmdEditor=function(elem,appended_id,imageUploadUrl,postProcessor){var $elem,$wmdPanel,$wmdPreviewContainer,ajaxFileUpload,converter,delayRenderer,editor,imageUploadHandler,initialText,wmdInputId,_append;$elem=$(elem);if(!$elem.length){console.log("warning: elem for makeWmdEditor doesn't exist");return}if(!$elem.find(".wmd-panel").length){initialText=$elem.html();$elem.empty();_append=appended_id||"";wmdInputId="wmd-input"+_append;$wmdPreviewContainer=$("<div>").addClass("wmd-preview-container").append($("<div>").addClass("wmd-preview-label").text(gettext("Preview"))).append($("<div>").attr("id","wmd-preview"+_append).addClass("wmd-panel wmd-preview"));$wmdPanel=$("<div>").addClass("wmd-panel").append($("<div>").attr("id","wmd-button-bar"+_append)).append($("<label>").addClass("sr").attr("for",wmdInputId).text(gettext("Post body"))).append($("<textarea>").addClass("wmd-input").attr("id",wmdInputId).html(initialText)).append($wmdPreviewContainer);$elem.append($wmdPanel)}converter=Markdown.getMathCompatibleConverter(postProcessor);ajaxFileUpload=function(imageUploadUrl,input,startUploadHandler){$("#loading").ajaxStart(function(){return $(this).show()}).ajaxComplete(function(){return $(this).hide()});$("#upload").ajaxStart(function(){return $(this).hide()}).ajaxComplete(function(){return $(this).show()});return $.ajaxFileUpload({url:imageUploadUrl,secureuri:false,fileElementId:"file-upload",dataType:"json",success:function(data,status){var error,fileURL;fileURL=data["result"]["file_url"];error=data["result"]["error"];if(error!==""){alert(error);if(startUploadHandler){$("#file-upload").unbind("change").change(startUploadHandler)}return console.log(error)}else{return $(input).attr("value",fileURL)}},error:function(data,status,e){alert(e);if(startUploadHandler){return $("#file-upload").unbind("change").change(startUploadHandler)}}})};imageUploadHandler=function(elem,input){return ajaxFileUpload(imageUploadUrl,input,imageUploadHandler)};editor=new Markdown.Editor(converter,appended_id,null,imageUploadHandler);delayRenderer=new MathJaxDelayRenderer;editor.hooks.chain("onPreviewPush",function(text,previewSet){return delayRenderer.render({text:text,previewSetter:previewSet})});editor.run();return editor}}})}).call(this);(function(){var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}};this.TooltipManager=function(){function TooltipManager(){this.hideTooltip=__bind(this.hideTooltip,this);this.moveTooltip=__bind(this.moveTooltip,this);this.showTooltip=__bind(this.showTooltip,this);this.$body=$("body");this.$tooltip=$('<div class="tooltip"></div>');this.$body.delegate("[data-tooltip]",{mouseover:this.showTooltip,mousemove:this.moveTooltip,mouseout:this.hideTooltip,click:this.hideTooltip})
}TooltipManager.prototype.showTooltip=function(e){var $target,tooltipCoords,tooltipText,_this=this;$target=$(e.target).closest("[data-tooltip]");tooltipText=$target.attr("data-tooltip");this.$tooltip.html(tooltipText);this.$body.append(this.$tooltip);tooltipCoords={x:e.pageX-this.$tooltip.outerWidth()/2,y:e.pageY-(this.$tooltip.outerHeight()+15)};this.$tooltip.css;({left:tooltipCoords.x,top:tooltipCoords.y});return this.tooltipTimer=setTimeout(function(){_this.$tooltip.show().css("opacity",1);return _this.tooltipTimer=setTimeout(function(){return _this.hideTooltip()},3e3)},500)};TooltipManager.prototype.moveTooltip=function(e){var tooltipCoords;tooltipCoords={x:e.pageX-this.$tooltip.outerWidth()/2,y:e.pageY-(this.$tooltip.outerHeight()+15)};return this.$tooltip.css({left:tooltipCoords.x,top:tooltipCoords.y})};TooltipManager.prototype.hideTooltip=function(e){this.$tooltip.hide().css("opacity",0);return clearTimeout(this.tooltipTimer)};return TooltipManager}();$(function(){return new TooltipManager})}).call(this);(function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionUser=function(_super){__extends(DiscussionUser,_super);function DiscussionUser(){_ref=DiscussionUser.__super__.constructor.apply(this,arguments);return _ref}DiscussionUser.prototype.following=function(thread){return _.include(this.get("subscribed_thread_ids"),thread.id)};DiscussionUser.prototype.voted=function(thread){return _.include(this.get("upvoted_ids"),thread.id)};DiscussionUser.prototype.vote=function(thread){this.get("upvoted_ids").push(thread.id);return thread.vote()};DiscussionUser.prototype.unvote=function(thread){this.set("upvoted_ids",_.without(this.get("upvoted_ids"),thread.id));return thread.unvote()};return DiscussionUser}(Backbone.Model)}}).call(this);(function(){var _ref,_ref1,_ref2,_ref3,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.Content=function(_super){__extends(Content,_super);function Content(){_ref=Content.__super__.constructor.apply(this,arguments);return _ref}Content.contents={};Content.contentInfos={};Content.prototype.template=function(){return DiscussionUtil.getTemplate("_content")};Content.prototype.actions={editable:".admin-edit",can_reply:".discussion-reply",can_endorse:".admin-endorse",can_delete:".admin-delete",can_openclose:".admin-openclose"};Content.prototype.urlMappers={};Content.prototype.urlFor=function(name){return this.urlMappers[name].apply(this)};Content.prototype.can=function(action){return(this.get("ability")||{})[action]};Content.prototype.updateInfo=function(info){if(info){this.set("ability",info.ability);this.set("voted",info.voted);return this.set("subscribed",info.subscribed)}};Content.prototype.addComment=function(comment,options){var comments_count,model,thread;options||(options={});if(!options.silent){thread=this.get("thread");comments_count=parseInt(thread.get("comments_count"));thread.set("comments_count",comments_count+1)}this.get("children").push(comment);model=new Comment($.extend({},comment,{thread:this.get("thread")}));this.get("comments").add(model);this.trigger("comment:add");return model};Content.prototype.removeComment=function(comment){var comments_count,thread;thread=this.get("thread");comments_count=parseInt(thread.get("comments_count"));thread.set("comments_count",comments_count-1-comment.getCommentsCount());return this.trigger("comment:remove")};Content.prototype.resetComments=function(children){var comment,_i,_len,_ref1,_results;this.set("children",[]);this.set("comments",new Comments);_ref1=children||[];_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){comment=_ref1[_i];_results.push(this.addComment(comment,{silent:true}))}return _results};Content.prototype.initialize=function(){Content.addContent(this.id,this);if(Content.getInfo(this.id)){this.updateInfo(Content.getInfo(this.id))}this.set("user_url",DiscussionUtil.urlFor("user_profile",this.get("user_id")));return this.resetComments(this.get("children"))};Content.prototype.remove=function(){if(this.get("type")==="comment"){this.get("thread").removeComment(this);return this.get("thread").trigger("comment:remove",this)}else{return this.trigger("thread:remove",this)}};Content.addContent=function(id,content){return this.contents[id]=content};Content.getContent=function(id){return this.contents[id]};Content.getInfo=function(id){return this.contentInfos[id]};Content.loadContentInfos=function(infos){var id,info;for(id in infos){info=infos[id];if(this.getContent(id)){this.getContent(id).updateInfo(info)}}return $.extend(this.contentInfos,infos)};Content.prototype.pinThread=function(){var pinned;pinned=this.get("pinned");this.set("pinned",pinned);return this.trigger("change",this)};Content.prototype.unPinThread=function(){var pinned;pinned=this.get("pinned");this.set("pinned",pinned);return this.trigger("change",this)};Content.prototype.flagAbuse=function(){var temp_array;temp_array=this.get("abuse_flaggers");temp_array.push(window.user.get("id"));this.set("abuse_flaggers",temp_array);return this.trigger("change",this)};Content.prototype.unflagAbuse=function(){this.get("abuse_flaggers").pop(window.user.get("id"));return this.trigger("change",this)};Content.prototype.vote=function(){this.get("votes")["up_count"]=parseInt(this.get("votes")["up_count"])+1;return this.trigger("change",this)};Content.prototype.unvote=function(){this.get("votes")["up_count"]=parseInt(this.get("votes")["up_count"])-1;return this.trigger("change",this)};return Content}(Backbone.Model);this.Thread=function(_super){__extends(Thread,_super);function Thread(){_ref1=Thread.__super__.constructor.apply(this,arguments);return _ref1}Thread.prototype.urlMappers={retrieve:function(){return DiscussionUtil.urlFor("retrieve_single_thread",this.discussion.id,this.id)},reply:function(){return DiscussionUtil.urlFor("create_comment",this.id)},unvote:function(){return DiscussionUtil.urlFor("undo_vote_for_"+this.get("type"),this.id)},upvote:function(){return DiscussionUtil.urlFor("upvote_"+this.get("type"),this.id)},downvote:function(){return DiscussionUtil.urlFor("downvote_"+this.get("type"),this.id)},close:function(){return DiscussionUtil.urlFor("openclose_thread",this.id)},update:function(){return DiscussionUtil.urlFor("update_thread",this.id)},_delete:function(){return DiscussionUtil.urlFor("delete_thread",this.id)},follow:function(){return DiscussionUtil.urlFor("follow_thread",this.id)},unfollow:function(){return DiscussionUtil.urlFor("unfollow_thread",this.id)},flagAbuse:function(){return DiscussionUtil.urlFor("flagAbuse_"+this.get("type"),this.id)},unFlagAbuse:function(){return DiscussionUtil.urlFor("unFlagAbuse_"+this.get("type"),this.id)},pinThread:function(){return DiscussionUtil.urlFor("pin_thread",this.id)},unPinThread:function(){return DiscussionUtil.urlFor("un_pin_thread",this.id)}};Thread.prototype.initialize=function(){this.set("thread",this);return Thread.__super__.initialize.call(this)};Thread.prototype.comment=function(){return this.set("comments_count",parseInt(this.get("comments_count"))+1)};Thread.prototype.follow=function(){return this.set("subscribed",true)};Thread.prototype.unfollow=function(){return this.set("subscribed",false)};Thread.prototype.display_body=function(){if(this.has("highlighted_body")){return String(this.get("highlighted_body")).replace(/<highlight>/g,"<mark>").replace(/<\/highlight>/g,"</mark>")}else{return this.get("body")}};Thread.prototype.display_title=function(){if(this.has("highlighted_title")){return String(this.get("highlighted_title")).replace(/<highlight>/g,"<mark>").replace(/<\/highlight>/g,"</mark>")}else{return this.get("title")}};Thread.prototype.toJSON=function(){var json_attributes;json_attributes=_.clone(this.attributes);return _.extend(json_attributes,{title:this.display_title(),body:this.display_body()})};Thread.prototype.created_at_date=function(){return new Date(this.get("created_at"))};Thread.prototype.created_at_time=function(){return new Date(this.get("created_at")).getTime()};Thread.prototype.hasResponses=function(){return this.get("comments_count")>0};return Thread}(this.Content);this.Comment=function(_super){__extends(Comment,_super);function Comment(){_ref2=Comment.__super__.constructor.apply(this,arguments);return _ref2}Comment.prototype.urlMappers={reply:function(){return DiscussionUtil.urlFor("create_sub_comment",this.id)},unvote:function(){return DiscussionUtil.urlFor("undo_vote_for_"+this.get("type"),this.id)},upvote:function(){return DiscussionUtil.urlFor("upvote_"+this.get("type"),this.id)},downvote:function(){return DiscussionUtil.urlFor("downvote_"+this.get("type"),this.id)},endorse:function(){return DiscussionUtil.urlFor("endorse_comment",this.id)},update:function(){return DiscussionUtil.urlFor("update_comment",this.id)},_delete:function(){return DiscussionUtil.urlFor("delete_comment",this.id)},flagAbuse:function(){return DiscussionUtil.urlFor("flagAbuse_"+this.get("type"),this.id)},unFlagAbuse:function(){return DiscussionUtil.urlFor("unFlagAbuse_"+this.get("type"),this.id)}};Comment.prototype.getCommentsCount=function(){var count;count=0;this.get("comments").each(function(comment){return count+=comment.getCommentsCount()+1});return count};return Comment}(this.Content);this.Comments=function(_super){__extends(Comments,_super);function Comments(){_ref3=Comments.__super__.constructor.apply(this,arguments);return _ref3}Comments.prototype.model=Comment;Comments.prototype.initialize=function(){var _this=this;return this.bind("add",function(item){return item.collection=_this})};Comments.prototype.find=function(id){return _.first(this.where({id:id}))};return Comments}(Backbone.Collection)}}).call(this);(function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.Discussion=function(_super){__extends(Discussion,_super);function Discussion(){_ref=Discussion.__super__.constructor.apply(this,arguments);return _ref}Discussion.prototype.model=Thread;Discussion.prototype.initialize=function(models,options){var _this=this;if(options==null){options={}}this.pages=options["pages"]||1;this.current_page=1;this.bind("add",function(item){return item.discussion=_this});this.comparator=this.sortByDateRecentFirst;return this.on("thread:remove",function(thread){return _this.remove(thread)})};Discussion.prototype.find=function(id){return _.first(this.where({id:id}))};Discussion.prototype.hasMorePages=function(){return this.current_page<this.pages};Discussion.prototype.addThread=function(thread,options){var model;if(!this.find(thread.id)){options||(options={});model=new Thread(thread);this.add(model);return model}};Discussion.prototype.retrieveAnotherPage=function(mode,options,sort_options,error){var data,url,_this=this;if(options==null){options={}}if(sort_options==null){sort_options={}}if(error==null){error=null}data={page:this.current_page+1};switch(mode){case"search":url=DiscussionUtil.urlFor("search");data["text"]=options.search_text;break;case"commentables":url=DiscussionUtil.urlFor("search");data["commentable_ids"]=options.commentable_ids;break;case"all":url=DiscussionUtil.urlFor("threads");break;case"flagged":data["flagged"]=true;url=DiscussionUtil.urlFor("search");break;case"followed":url=DiscussionUtil.urlFor("followed_threads",options.user_id)}if(options["group_id"]){data["group_id"]=options["group_id"]}data["sort_key"]=sort_options.sort_key||"date";data["sort_order"]=sort_options.sort_order||"desc";return DiscussionUtil.safeAjax({$elem:this.$el,url:url,data:data,dataType:"json",success:function(response,textStatus){var models,new_collection,new_threads;models=_this.models;new_threads=[function(){var _i,_len,_ref1,_results;_ref1=response.discussion_data;_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){data=_ref1[_i];_results.push(new Thread(data))}return _results}()][0];new_collection=_.union(models,new_threads);Content.loadContentInfos(response.annotated_content_info);_this.reset(new_collection);_this.pages=response.num_pages;return _this.current_page=response.page},error:error})};Discussion.prototype.sortByDate=function(thread){var today;if(thread.get("pinned")){today=new Date;return new Date(today.getTime()+24*60*60*1e3)}else{return thread.get("created_at")}};Discussion.prototype.sortByDateRecentFirst=function(thread){var today;if(thread.get("pinned")){today=new Date;return-new Date(today.getTime()+24*60*60*1e3)}else{return-new Date(thread.get("created_at")).getTime()}};Discussion.prototype.sortByVotes=function(thread1,thread2){var thread1_count,thread2_count;thread1_count=parseInt(thread1.get("votes")["up_count"]);thread2_count=parseInt(thread2.get("votes")["up_count"]);if(thread2_count!==thread1_count){return thread2_count-thread1_count}else{return thread2.created_at_time()-thread1.created_at_time()}};Discussion.prototype.sortByComments=function(thread1,thread2){var thread1_count,thread2_count;thread1_count=parseInt(thread1.get("comments_count"));thread2_count=parseInt(thread2.get("comments_count"));if(thread2_count!==thread1_count){return thread2_count-thread1_count}else{return thread2.created_at_time()-thread1.created_at_time()}};return Discussion}(Backbone.Collection)}}).call(this);(function(){if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionApp=function(){function DiscussionApp(){}DiscussionApp.start=function(elem,pushState){var content_info,discussion,element,thread_pages,threads,user_info;if(pushState==null){pushState=true}DiscussionUtil.loadRolesFromContainer();element=$(elem);window.$$course_id=element.data("course-id");user_info=element.data("user-info");threads=element.data("threads");thread_pages=element.data("thread-pages");content_info=element.data("content-info");window.user=new DiscussionUser(user_info);Content.loadContentInfos(content_info);discussion=new Discussion(threads,{pages:thread_pages});new DiscussionRouter({discussion:discussion});return Backbone.history.start({pushState:pushState,root:"/courses/"+$$course_id+"/discussion/forum/"})};return DiscussionApp}();this.DiscussionProfileApp=function(){function DiscussionProfileApp(){}DiscussionProfileApp.start=function(elem){var element,numPages,page,threads,user_info;element=$(elem);window.$$course_id=element.data("course-id");threads=element.data("threads");user_info=element.data("user-info");window.user=new DiscussionUser(user_info);page=element.data("page");numPages=element.data("num-pages");return new DiscussionUserProfileView({el:element,collection:threads,page:page,numPages:numPages})};return DiscussionProfileApp}();$(function(){$("body.discussion section.discussion").each(function(index,elem){return DiscussionApp.start(elem)});return $("body.discussion section.discussion-user-threads").each(function(index,elem){return DiscussionProfileApp.start(elem)})})}}).call(this);(function(){this.DiscussionFilter=function(){function DiscussionFilter(){}DiscussionFilter.filterDrop=function(e){var $drop,$items,query;$drop=$(e.target).parents(".topic_menu_wrapper, .browse-topic-drop-menu-wrapper");query=$(e.target).val();$items=$drop.find("a");if(query.length===0){$items.removeClass("hidden");return}$items.addClass("hidden");return $items.each(function(i){var terms,test,thisText;thisText=$(this).not(".unread").text();$(this).parents("ul").siblings("a").not(".unread").each(function(i){return thisText=thisText+" "+$(this).text()});test=true;terms=thisText.split(" ");if(thisText.toLowerCase().search(query.toLowerCase())===-1){test=false}if(test){$(this).removeClass("hidden");$(this).parent().find("a").removeClass("hidden");return $(this).parents("ul").siblings("a").removeClass("hidden")}})};return DiscussionFilter}()}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionContentView=function(_super){__extends(DiscussionContentView,_super);function DiscussionContentView(){this.unvote=__bind(this.unvote,this);this.vote=__bind(this.vote,this);this.toggleVote=__bind(this.toggleVote,this);this.renderVote=__bind(this.renderVote,this);this.unFlagAbuse=__bind(this.unFlagAbuse,this);this.flagAbuse=__bind(this.flagAbuse,this);this.toggleFlagAbuse=__bind(this.toggleFlagAbuse,this);this.toggleFollowing=__bind(this.toggleFollowing,this);this.setWmdContent=__bind(this.setWmdContent,this);this.getWmdContent=__bind(this.getWmdContent,this);this.getWmdEditor=__bind(this.getWmdEditor,this);this.makeWmdEditor=__bind(this.makeWmdEditor,this);_ref=DiscussionContentView.__super__.constructor.apply(this,arguments);return _ref}DiscussionContentView.prototype.events={"click .discussion-flag-abuse":"toggleFlagAbuse","keydown .discussion-flag-abuse":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleFlagAbuse)}};DiscussionContentView.prototype.attrRenderer={endorsed:function(endorsed){var _ref1;if(endorsed){return this.$(".action-endorse").show().addClass("is-endorsed")}else{if((_ref1=this.model.get("ability"))!=null?_ref1.can_endorse:void 0){this.$(".action-endorse").show()}else{this.$(".action-endorse").hide()}return this.$(".action-endorse").removeClass("is-endorsed")}},closed:function(closed){if(!this.$(".action-openclose").length){return}if(!this.$(".post-status-closed").length){return}if(closed){this.$(".post-status-closed").show();this.$(".action-openclose").html(this.$(".action-openclose").html().replace(gettext("Close"),gettext("Open")));return this.$(".discussion-reply-new").hide()}else{this.$(".post-status-closed").hide();this.$(".action-openclose").html(this.$(".action-openclose").html().replace(gettext("Open"),gettext("Close")));return this.$(".discussion-reply-new").show()}},voted:function(voted){},votes_point:function(votes_point){},comments_count:function(comments_count){},subscribed:function(subscribed){if(subscribed){return this.$(".dogear").addClass("is-followed").attr("aria-checked","true")}else{return this.$(".dogear").removeClass("is-followed").attr("aria-checked","false")}},ability:function(ability){var action,selector,_ref1,_results;_ref1=this.abilityRenderer;_results=[];for(action in _ref1){selector=_ref1[action];if(!ability[action]){_results.push(selector.disable.apply(this))}else{_results.push(selector.enable.apply(this))}}return _results}};DiscussionContentView.prototype.abilityRenderer={editable:{enable:function(){return this.$(".action-edit").closest("li").show()},disable:function(){return this.$(".action-edit").closest("li").hide()}},can_delete:{enable:function(){return this.$(".action-delete").closest("li").show()},disable:function(){return this.$(".action-delete").closest("li").hide()}},can_endorse:{enable:function(){return this.$(".action-endorse").show().css("cursor","auto")},disable:function(){this.$(".action-endorse").css("cursor","default");if(!this.model.get("endorsed")){return this.$(".action-endorse").hide()}else{return this.$(".action-endorse").show()}}},can_openclose:{enable:function(){return this.$(".action-openclose").closest("li").show()},disable:function(){return this.$(".action-openclose").closest("li").hide()}}};DiscussionContentView.prototype.renderPartialAttrs=function(){var attr,value,_ref1,_results;_ref1=this.model.changedAttributes();_results=[];for(attr in _ref1){value=_ref1[attr];if(this.attrRenderer[attr]){_results.push(this.attrRenderer[attr].apply(this,[value]))}else{_results.push(void 0)}}return _results};DiscussionContentView.prototype.renderAttrs=function(){var attr,value,_ref1,_results;_ref1=this.model.attributes;_results=[];for(attr in _ref1){value=_ref1[attr];if(this.attrRenderer[attr]){_results.push(this.attrRenderer[attr].apply(this,[value]))}else{_results.push(void 0)}}return _results};DiscussionContentView.prototype.$=function(selector){return this.$local.find(selector)};DiscussionContentView.prototype.initLocal=function(){this.$local=this.$el.children(".local");if(!this.$local.length){this.$local=this.$el}return this.$delegateElement=this.$local};DiscussionContentView.prototype.makeWmdEditor=function(cls_identifier){if(!this.$el.find(".wmd-panel").length){return DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),cls_identifier)}};DiscussionContentView.prototype.getWmdEditor=function(cls_identifier){return DiscussionUtil.getWmdEditor(this.$el,$.proxy(this.$,this),cls_identifier)};DiscussionContentView.prototype.getWmdContent=function(cls_identifier){return DiscussionUtil.getWmdContent(this.$el,$.proxy(this.$,this),cls_identifier)};DiscussionContentView.prototype.setWmdContent=function(cls_identifier,text){return DiscussionUtil.setWmdContent(this.$el,$.proxy(this.$,this),cls_identifier,text)};DiscussionContentView.prototype.initialize=function(){this.initLocal();return this.model.bind("change",this.renderPartialAttrs,this)};DiscussionContentView.prototype.toggleFollowing=function(event){var $elem,url;event.preventDefault();$elem=$(event.target);url=null;if(!this.model.get("subscribed")){this.model.follow();url=this.model.urlFor("follow")}else{this.model.unfollow();url=this.model.urlFor("unfollow")}return DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST"})};DiscussionContentView.prototype.toggleFlagAbuse=function(event){var _ref1;event.preventDefault();if((_ref1=window.user.id,__indexOf.call(this.model.get("abuse_flaggers"),_ref1)>=0)||DiscussionUtil.isFlagModerator&&this.model.get("abuse_flaggers").length>0){return this.unFlagAbuse()}else{return this.flagAbuse()}};DiscussionContentView.prototype.flagAbuse=function(){var url,_this=this;url=this.model.urlFor("flagAbuse");return DiscussionUtil.safeAjax({$elem:this.$(".discussion-flag-abuse"),url:url,type:"POST",success:function(response,textStatus){var temp_array;if(textStatus==="success"){temp_array=_.clone(_this.model.get("abuse_flaggers"));temp_array.push(window.user.id);return _this.model.set("abuse_flaggers",temp_array)}}})};DiscussionContentView.prototype.unFlagAbuse=function(){var url,_this=this;url=this.model.urlFor("unFlagAbuse");return DiscussionUtil.safeAjax({$elem:this.$(".discussion-flag-abuse"),url:url,type:"POST",success:function(response,textStatus){var temp_array;if(textStatus==="success"){temp_array=_.clone(_this.model.get("abuse_flaggers"));temp_array.pop(window.user.id);if(DiscussionUtil.isFlagModerator){temp_array=[]}return _this.model.set("abuse_flaggers",temp_array)}}})};DiscussionContentView.prototype.renderVote=function(){var button,buttonText,buttonTextFmt,voteNum,voted;button=this.$el.find(".vote-btn");voted=window.user.voted(this.model);voteNum=this.model.get("votes")["up_count"];button.toggleClass("is-cast",voted);button.attr("aria-pressed",voted);button.attr("data-tooltip",voted?gettext("remove vote"):gettext("vote"));buttonTextFmt=voted?ngettext("vote (click to remove your vote)","votes (click to remove your vote)",voteNum):ngettext("vote (click to vote)","votes (click to vote)",voteNum);buttonTextFmt="%(voteNum)s%(startSrSpan)s "+buttonTextFmt+"%(endSrSpan)s";buttonText=interpolate(buttonTextFmt,{voteNum:voteNum,startSrSpan:"<span class='sr'>",endSrSpan:"</span>"},true);return button.html("<span class='plus-icon'/>"+buttonText)};DiscussionContentView.prototype.toggleVote=function(event){event.preventDefault();if(window.user.voted(this.model)){return this.unvote()}else{return this.vote()}};DiscussionContentView.prototype.vote=function(){var url,_this=this;window.user.vote(this.model);url=this.model.urlFor("upvote");return DiscussionUtil.safeAjax({$elem:this.$el.find(".vote-btn"),url:url,type:"POST",success:function(response,textStatus){if(textStatus==="success"){return _this.model.set(response)}}})};DiscussionContentView.prototype.unvote=function(){var url,_this=this;window.user.unvote(this.model);url=this.model.urlFor("unvote");return DiscussionUtil.safeAjax({$elem:this.$el.find(".vote-btn"),url:url,type:"POST",success:function(response,textStatus){if(textStatus==="success"){return _this.model.set(response)}}})};return DiscussionContentView}(Backbone.View)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ResponseCommentView=function(_super){__extends(ResponseCommentView,_super);function ResponseCommentView(){this.update=__bind(this.update,this);this.edit=__bind(this.edit,this);this.cancelEdit=__bind(this.cancelEdit,this);this._delete=__bind(this._delete,this);_ref=ResponseCommentView.__super__.constructor.apply(this,arguments);return _ref}ResponseCommentView.prototype.tagName="li";ResponseCommentView.prototype.$=function(selector){return this.$el.find(selector)};ResponseCommentView.prototype.initialize=function(){return ResponseCommentView.__super__.initialize.call(this)};ResponseCommentView.prototype.render=function(){this.renderShowView();return this};ResponseCommentView.prototype.renderSubView=function(view){view.setElement(this.$el);view.render();return view.delegateEvents()};ResponseCommentView.prototype.renderShowView=function(){if(this.showView==null){if(this.editView!=null){this.editView.undelegateEvents();this.editView.$el.empty();this.editView=null}this.showView=new ResponseCommentShowView({model:this.model});this.showView.bind("comment:_delete",this._delete);this.showView.bind("comment:edit",this.edit);return this.renderSubView(this.showView)}};ResponseCommentView.prototype.renderEditView=function(){if(this.editView==null){if(this.showView!=null){this.showView.undelegateEvents();this.showView.$el.empty();this.showView=null}this.editView=new ResponseCommentEditView({model:this.model});this.editView.bind("comment:update",this.update);this.editView.bind("comment:cancel_edit",this.cancelEdit);return this.renderSubView(this.editView)}};ResponseCommentView.prototype._delete=function(event){var $elem,url,_this=this;event.preventDefault();if(!this.model.can("can_delete")){return}if(!confirm(gettext("Are you sure you want to delete this comment?"))){return}url=this.model.urlFor("_delete");$elem=$(event.target);return DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(response,textStatus){_this.model.remove();return _this.$el.remove()},error:function(){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble deleting this comment. Please try again."))}})};ResponseCommentView.prototype.cancelEdit=function(event){this.trigger("comment:cancel_edit",event);return this.renderShowView()};ResponseCommentView.prototype.edit=function(event){this.trigger("comment:edit",event);return this.renderEditView()};ResponseCommentView.prototype.update=function(event){var newBody,url,_this=this;newBody=this.editView.$(".edit-comment-body textarea").val();url=DiscussionUtil.urlFor("update_comment",this.model.id);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:$(event.target),url:url,type:"POST",dataType:"json",data:{body:newBody},error:DiscussionUtil.formErrorHandler(this.$(".edit-comment-form-errors")),success:function(response,textStatus){_this.model.set("body",newBody);return _this.cancelEdit()}})};return ResponseCommentView}(DiscussionContentView)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ThreadResponseShowView=function(_super){__extends(ThreadResponseShowView,_super);function ThreadResponseShowView(){this.updateModelDetails=__bind(this.updateModelDetails,this);this.renderFlagged=__bind(this.renderFlagged,this);_ref=ThreadResponseShowView.__super__.constructor.apply(this,arguments);return _ref}ThreadResponseShowView.prototype.events={"click .vote-btn":function(event){return this.toggleVote(event)},"keydown .vote-btn":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleVote)},"click .action-endorse":"toggleEndorse","click .action-delete":"_delete","click .action-edit":"edit","click .discussion-flag-abuse":"toggleFlagAbuse","keydown .discussion-flag-abuse":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleFlagAbuse)}};ThreadResponseShowView.prototype.$=function(selector){return this.$el.find(selector)};ThreadResponseShowView.prototype.initialize=function(){ThreadResponseShowView.__super__.initialize.call(this);return this.model.on("change",this.updateModelDetails)};ThreadResponseShowView.prototype.renderTemplate=function(){this.template=_.template($("#thread-response-show-template").html());return this.template(this.model.toJSON())};ThreadResponseShowView.prototype.render=function(){this.$el.html(this.renderTemplate());this.delegateEvents();this.renderVote();this.renderAttrs();this.renderFlagged();this.$el.find(".posted-details").timeago();this.convertMath();this.markAsStaff();return this};ThreadResponseShowView.prototype.convertMath=function(){var element;element=this.$(".response-body");element.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(element.text())));return MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]])};ThreadResponseShowView.prototype.markAsStaff=function(){if(DiscussionUtil.isStaff(this.model.get("user_id"))){this.$el.addClass("staff");return this.$el.prepend('<div class="staff-banner">'+gettext("staff")+"</div>")}else if(DiscussionUtil.isTA(this.model.get("user_id"))){this.$el.addClass("community-ta");return this.$el.prepend('<div class="community-ta-banner">'+gettext("Community TA")+"</div>")}};ThreadResponseShowView.prototype.edit=function(event){return this.trigger("response:edit",event)};ThreadResponseShowView.prototype._delete=function(event){return this.trigger("response:_delete",event)};ThreadResponseShowView.prototype.toggleEndorse=function(event){var $elem,data,endorsed,url;event.preventDefault();if(!this.model.can("can_endorse")){return}$elem=$(event.target);url=this.model.urlFor("endorse");endorsed=this.model.get("endorsed");data={endorsed:!endorsed};this.model.set("endorsed",!endorsed);this.trigger("comment:endorse",!endorsed);return DiscussionUtil.safeAjax({$elem:$elem,url:url,data:data,type:"POST"})};ThreadResponseShowView.prototype.renderFlagged=function(){var _ref1;if((_ref1=window.user.id,__indexOf.call(this.model.get("abuse_flaggers"),_ref1)>=0)||DiscussionUtil.isFlagModerator&&this.model.get("abuse_flaggers").length>0){this.$("[data-role=thread-flag]").addClass("flagged");
this.$("[data-role=thread-flag]").removeClass("notflagged");this.$(".discussion-flag-abuse").attr("aria-pressed","true");this.$(".discussion-flag-abuse").attr("data-tooltip",gettext("Misuse Reported, click to remove report"));return this.$(".discussion-flag-abuse .flag-label").html(interpolate(gettext("Misuse Reported%(start_sr_span)s, click to remove report%(end_span)s"),{start_sr_span:"<span class='sr'>",end_span:"</span>"},true))}else{this.$("[data-role=thread-flag]").removeClass("flagged");this.$("[data-role=thread-flag]").addClass("notflagged");this.$(".discussion-flag-abuse").attr("aria-pressed","false");return this.$(".discussion-flag-abuse .flag-label").html(gettext("Report Misuse"))}};ThreadResponseShowView.prototype.updateModelDetails=function(){this.renderVote();return this.renderFlagged()};return ThreadResponseShowView}(DiscussionContentView)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionUserProfileView=function(_super){__extends(DiscussionUserProfileView,_super);function DiscussionUserProfileView(){this.render=__bind(this.render,this);_ref=DiscussionUserProfileView.__super__.constructor.apply(this,arguments);return _ref}DiscussionUserProfileView.prototype.events={"click .discussion-paginator a":"changePage"};DiscussionUserProfileView.prototype.initialize=function(options){DiscussionUserProfileView.__super__.initialize.call(this);this.page=options.page;this.numPages=options.numPages;this.discussion=new Discussion;this.discussion.on("reset",this.render);return this.discussion.reset(this.collection,{silent:false})};DiscussionUserProfileView.prototype.render=function(){var baseUri,pageUrlFunc,paginationParams,paginationTemplate,profileTemplate;profileTemplate=$("script#_user_profile").html();this.$el.html(Mustache.render(profileTemplate,{threads:this.discussion.models}));this.discussion.map(function(thread){return new DiscussionThreadProfileView({el:this.$("article#thread_"+thread.id),model:thread}).render()});baseUri=URI(window.location).removeSearch("page");pageUrlFunc=function(page){return baseUri.clone().addSearch("page",page)};paginationParams=DiscussionUtil.getPaginationParams(this.page,this.numPages,pageUrlFunc);paginationTemplate=$("script#_pagination").html();return this.$el.find(".pagination").html(Mustache.render(paginationTemplate,paginationParams))};DiscussionUserProfileView.prototype.changePage=function(event){var url,_this=this;event.preventDefault();url=$(event.target).attr("href");return DiscussionUtil.safeAjax({$elem:this.$el,$loading:$(event.target),takeFocus:true,url:url,type:"GET",dataType:"json",success:function(response,textStatus,xhr){_this.page=response.page;_this.numPages=response.num_pages;_this.discussion.reset(response.discussion_data,{silent:false});return history.pushState({},"",url)},error:function(){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the page you requested. Please try again."))}})};return DiscussionUserProfileView}(Backbone.View)}}).call(this);(function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.NewPostInlineView=function(_super){__extends(NewPostInlineView,_super);function NewPostInlineView(){_ref=NewPostInlineView.__super__.constructor.apply(this,arguments);return _ref}NewPostInlineView.prototype.initialize=function(){this.topicId=this.$(".topic").first().data("discussion-id");this.maxNameWidth=100;return DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"new-post-body")};NewPostInlineView.prototype.events={"submit .new-post-form":"createPost"};NewPostInlineView.prototype.ignoreClick=function(event){return event.stopPropagation()};NewPostInlineView.prototype.createPost=function(event){var anonymous,anonymous_to_peers,body,follow,group,thread_type,title,url,_this=this;event.preventDefault();title=this.$(".new-post-title").val();body=this.$(".new-post-body").find(".wmd-input").val();group=this.$(".new-post-group option:selected").attr("value");anonymous=false||this.$("input.discussion-anonymous").is(":checked");anonymous_to_peers=false||this.$("input.discussion-anonymous-to-peers").is(":checked");follow=false||this.$("input.discussion-follow").is(":checked");thread_type="discussion";url=DiscussionUtil.urlFor("create_thread",this.topicId);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:true,data:{title:title,body:body,group_id:group,anonymous:anonymous,anonymous_to_peers:anonymous_to_peers,auto_subscribe:follow,thread_type:thread_type},error:DiscussionUtil.formErrorHandler(this.$(".new-post-form-errors")),success:function(response,textStatus){var thread;thread=new Thread(response["content"]);DiscussionUtil.clearFormErrors(_this.$(".new-post-form-errors"));_this.$el.hide();_this.$(".new-post-title").val("").attr("prev-text","");_this.$(".new-post-body textarea").val("").attr("prev-text","");return _this.collection.add(thread)}})};return NewPostInlineView}(Backbone.View)}}).call(this);(function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ThreadResponseEditView=function(_super){__extends(ThreadResponseEditView,_super);function ThreadResponseEditView(){_ref=ThreadResponseEditView.__super__.constructor.apply(this,arguments);return _ref}ThreadResponseEditView.prototype.events={"click .post-update":"update","click .post-cancel":"cancel_edit"};ThreadResponseEditView.prototype.$=function(selector){return this.$el.find(selector)};ThreadResponseEditView.prototype.initialize=function(){return ThreadResponseEditView.__super__.initialize.call(this)};ThreadResponseEditView.prototype.render=function(){this.template=_.template($("#thread-response-edit-template").html());this.$el.html(this.template(this.model.toJSON()));this.delegateEvents();DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-post-body");return this};ThreadResponseEditView.prototype.update=function(event){return this.trigger("response:update",event)};ThreadResponseEditView.prototype.cancel_edit=function(event){return this.trigger("response:cancel_edit",event)};return ThreadResponseEditView}(Backbone.View)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadView=function(_super){var INITIAL_RESPONSE_PAGE_SIZE,SUBSEQUENT_RESPONSE_PAGE_SIZE;__extends(DiscussionThreadView,_super);function DiscussionThreadView(){this._delete=__bind(this._delete,this);this.cancelEdit=__bind(this.cancelEdit,this);this.update=__bind(this.update,this);this.edit=__bind(this.edit,this);this.endorseThread=__bind(this.endorseThread,this);this.addComment=__bind(this.addComment,this);this.renderResponse=__bind(this.renderResponse,this);this.renderResponseCountAndPagination=__bind(this.renderResponseCountAndPagination,this);_ref=DiscussionThreadView.__super__.constructor.apply(this,arguments);return _ref}INITIAL_RESPONSE_PAGE_SIZE=25;SUBSEQUENT_RESPONSE_PAGE_SIZE=100;DiscussionThreadView.prototype.events={"click .discussion-submit-post":"submitComment","click .add-response-btn":"scrollToAddResponse"};DiscussionThreadView.prototype.$=function(selector){return this.$el.find(selector)};DiscussionThreadView.prototype.initialize=function(){DiscussionThreadView.__super__.initialize.call(this);this.createShowView();return this.responses=new Comments};DiscussionThreadView.prototype.renderTemplate=function(){this.template=_.template($("#thread-template").html());return this.template(this.model.toJSON())};DiscussionThreadView.prototype.render=function(){var _this=this;this.$el.html(this.renderTemplate());this.initLocal();this.delegateEvents();this.renderShowView();this.renderAttrs();this.$("span.timeago").timeago();this.makeWmdEditor("reply-body");this.renderAddResponseButton();this.responses.on("add",this.renderResponse);setTimeout(function(){return _this.loadInitialResponses()},100);return this};DiscussionThreadView.prototype.cleanup=function(){if(this.responsesRequest!=null){return this.responsesRequest.abort()}};DiscussionThreadView.prototype.loadResponses=function(responseLimit,elem,firstLoad){var _this=this;return this.responsesRequest=DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("retrieve_single_thread",this.model.get("commentable_id"),this.model.id),data:{resp_skip:this.responses.size(),resp_limit:responseLimit?responseLimit:void 0},$elem:elem,$loading:elem,takeFocus:true,complete:function(){return _this.responseRequest=null},success:function(data,textStatus,xhr){Content.loadContentInfos(data["annotated_content_info"]);_this.responses.add(data["content"]["children"]);_this.renderResponseCountAndPagination(data["content"]["resp_total"]);return _this.trigger("thread:responses:rendered")},error:function(xhr){if(xhr.status===404){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("The thread you selected has been deleted. Please select another thread."))}else if(firstLoad){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading responses. Please reload the page."))}else{return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more responses. Please try again."))}}})};DiscussionThreadView.prototype.loadInitialResponses=function(){return this.loadResponses(INITIAL_RESPONSE_PAGE_SIZE,this.$el.find(".responses"),true)};DiscussionThreadView.prototype.renderResponseCountAndPagination=function(responseTotal){var buttonText,loadMoreButton,responseLimit,responsePagination,responsesRemaining,showingResponsesText,_this=this;this.$el.find(".response-count").html(interpolate(ngettext("%(numResponses)s response","%(numResponses)s responses",responseTotal),{numResponses:responseTotal},true));responsePagination=this.$el.find(".response-pagination");responsePagination.empty();if(responseTotal>0){responsesRemaining=responseTotal-this.responses.size();showingResponsesText=responsesRemaining===0?gettext("Showing all responses"):interpolate(ngettext("Showing first response","Showing first %(numResponses)s responses",this.responses.size()),{numResponses:this.responses.size()},true);responsePagination.append($("<span>").addClass("response-display-count").html(_.escape(showingResponsesText)));if(responsesRemaining>0){if(responsesRemaining<SUBSEQUENT_RESPONSE_PAGE_SIZE){responseLimit=null;buttonText=gettext("Load all responses")}else{responseLimit=SUBSEQUENT_RESPONSE_PAGE_SIZE;buttonText=interpolate(gettext("Load next %(numResponses)s responses"),{numResponses:responseLimit},true)}loadMoreButton=$("<button>").addClass("load-response-button").html(_.escape(buttonText));loadMoreButton.click(function(event){return _this.loadResponses(responseLimit,loadMoreButton)});return responsePagination.append(loadMoreButton)}}};DiscussionThreadView.prototype.renderResponse=function(response){var view;response.set("thread",this.model);view=new ThreadResponseView({model:response});view.on("comment:add",this.addComment);view.on("comment:endorse",this.endorseThread);view.render();this.$el.find(".responses").append(view.el);return view.afterInsert()};DiscussionThreadView.prototype.renderAddResponseButton=function(){if(this.model.hasResponses()&&this.model.can("can_reply")){return this.$el.find("div.add-response").show()}else{return this.$el.find("div.add-response").hide()}};DiscussionThreadView.prototype.scrollToAddResponse=function(event){var form;event.preventDefault();form=$(event.target).parents("article.discussion-article").find("form.discussion-reply-new");$("html, body").scrollTop(form.offset().top);return form.find(".wmd-panel textarea").focus()};DiscussionThreadView.prototype.addComment=function(){return this.model.comment()};DiscussionThreadView.prototype.endorseThread=function(endorsed){var is_endorsed;is_endorsed=this.$el.find(".is-endorsed").length;return this.model.set("endorsed",is_endorsed)};DiscussionThreadView.prototype.submitComment=function(event){var body,comment,url,_this=this;event.preventDefault();url=this.model.urlFor("reply");body=this.getWmdContent("reply-body");if(!body.trim().length){return}this.setWmdContent("reply-body","");comment=new Comment({body:body,created_at:(new Date).toISOString(),username:window.user.get("username"),votes:{up_count:0},abuse_flaggers:[],endorsed:false,user_id:window.user.get("id")});comment.set("thread",this.model.get("thread"));this.renderResponse(comment);this.model.addComment();this.renderAddResponseButton();return DiscussionUtil.safeAjax({$elem:$(event.target),url:url,type:"POST",dataType:"json",data:{body:body},success:function(data,textStatus){comment.updateInfo(data.annotated_content_info);return comment.set(data.content)}})};DiscussionThreadView.prototype.edit=function(event){this.createEditView();return this.renderEditView()};DiscussionThreadView.prototype.update=function(event){var newBody,newTitle,url,_this=this;newTitle=this.editView.$(".edit-post-title").val();newBody=this.editView.$(".edit-post-body textarea").val();url=DiscussionUtil.urlFor("update_thread",this.model.id);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:true,data:{title:newTitle,body:newBody},error:DiscussionUtil.formErrorHandler(this.$(".edit-post-form-errors")),success:function(response,textStatus){_this.editView.$(".edit-post-title").val("").attr("prev-text","");_this.editView.$(".edit-post-body textarea").val("").attr("prev-text","");_this.editView.$(".wmd-preview p").html("");_this.model.set({title:newTitle,body:newBody});_this.createShowView();return _this.renderShowView()}})};DiscussionThreadView.prototype.createEditView=function(){if(this.showView!=null){this.showView.undelegateEvents();this.showView.$el.empty();this.showView=null}this.editView=new DiscussionThreadEditView({model:this.model});this.editView.bind("thread:update",this.update);return this.editView.bind("thread:cancel_edit",this.cancelEdit)};DiscussionThreadView.prototype.renderSubView=function(view){view.setElement(this.$(".thread-content-wrapper"));view.render();return view.delegateEvents()};DiscussionThreadView.prototype.renderEditView=function(){return this.renderSubView(this.editView)};DiscussionThreadView.prototype.getShowViewClass=function(){return DiscussionThreadShowView};DiscussionThreadView.prototype.createShowView=function(){var showViewClass;if(this.editView!=null){this.editView.undelegateEvents();this.editView.$el.empty();this.editView=null}showViewClass=this.getShowViewClass();this.showView=new showViewClass({model:this.model});this.showView.bind("thread:_delete",this._delete);return this.showView.bind("thread:edit",this.edit)};DiscussionThreadView.prototype.renderShowView=function(){return this.renderSubView(this.showView)};DiscussionThreadView.prototype.cancelEdit=function(event){event.preventDefault();this.createShowView();return this.renderShowView()};DiscussionThreadView.prototype._delete=function(event){var $elem,url,_this=this;url=this.model.urlFor("_delete");if(!this.model.can("can_delete")){return}if(!confirm(gettext("Are you sure you want to delete this post?"))){return}this.model.remove();this.showView.undelegateEvents();this.undelegateEvents();this.$el.empty();$elem=$(event.target);return DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(response,textStatus){}})};return DiscussionThreadView}(DiscussionContentView)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadInlineView=function(_super){var expanded;__extends(DiscussionThreadInlineView,_super);function DiscussionThreadInlineView(){this.expandPost=__bind(this.expandPost,this);_ref=DiscussionThreadInlineView.__super__.constructor.apply(this,arguments);return _ref}expanded=false;DiscussionThreadInlineView.prototype.events={"click .discussion-submit-post":"submitComment","click .expand-post":"expandPost","click .collapse-post":"collapsePost","click .add-response-btn":"scrollToAddResponse"};DiscussionThreadInlineView.prototype.initialize=function(){return DiscussionThreadInlineView.__super__.initialize.call(this)};DiscussionThreadInlineView.prototype.initLocal=function(){this.$local=this.$el.children(".discussion-article").children(".local");if(!this.$local.length){this.$local=this.$el}return this.$delegateElement=this.$local};DiscussionThreadInlineView.prototype.renderTemplate=function(){var params;if(this.model.has("group_id")){this.template=DiscussionUtil.getTemplate("_inline_thread_cohorted")}else{this.template=DiscussionUtil.getTemplate("_inline_thread")}if(!this.model.has("abbreviatedBody")){this.abbreviateBody()}params=this.model.toJSON();return Mustache.render(this.template,params)};DiscussionThreadInlineView.prototype.render=function(){DiscussionThreadInlineView.__super__.render.call(this);this.$el.find(".post-extended-content").hide();return this.$el.find(".collapse-post").hide()};DiscussionThreadInlineView.prototype.getShowViewClass=function(){return DiscussionThreadInlineShowView};DiscussionThreadInlineView.prototype.loadInitialResponses=function(){if(this.expanded){return DiscussionThreadInlineView.__super__.loadInitialResponses.call(this)}};DiscussionThreadInlineView.prototype.abbreviateBody=function(){var abbreviated;abbreviated=DiscussionUtil.abbreviateString(this.model.get("body"),140);return this.model.set("abbreviatedBody",abbreviated)};DiscussionThreadInlineView.prototype.expandPost=function(event){this.$el.addClass("expanded");this.$el.find(".post-body").text(this.model.get("body"));this.showView.convertMath();this.$el.find(".expand-post").css("display","none");this.$el.find(".collapse-post").css("display","block");this.$el.find(".post-extended-content").show();if(!this.expanded){this.expanded=true;return this.loadInitialResponses()}};DiscussionThreadInlineView.prototype.collapsePost=function(event){var curScroll,postTop;curScroll=$(window).scrollTop();postTop=this.$el.offset().top;if(postTop<curScroll){$("html, body").animate({scrollTop:postTop})}this.$el.removeClass("expanded");this.$el.find(".post-body").text(this.model.get("abbreviatedBody"));this.showView.convertMath();this.$el.find(".expand-post").css("display","block");this.$el.find(".collapse-post").css("display","none");return this.$el.find(".post-extended-content").hide()};DiscussionThreadInlineView.prototype.createEditView=function(){DiscussionThreadInlineView.__super__.createEditView.call(this);return this.editView.bind("thread:update",this.abbreviateBody)};return DiscussionThreadInlineView}(DiscussionThreadView)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ThreadResponseView=function(_super){__extends(ThreadResponseView,_super);function ThreadResponseView(){this.update=__bind(this.update,this);this.edit=__bind(this.edit,this);this.cancelEdit=__bind(this.cancelEdit,this);this._delete=__bind(this._delete,this);this.renderComment=__bind(this.renderComment,this);_ref=ThreadResponseView.__super__.constructor.apply(this,arguments);return _ref}ThreadResponseView.prototype.tagName="li";ThreadResponseView.prototype.events={"click .discussion-submit-comment":"submitComment","focus .wmd-input":"showEditorChrome"};ThreadResponseView.prototype.$=function(selector){return this.$el.find(selector)};ThreadResponseView.prototype.initialize=function(){return this.createShowView()};ThreadResponseView.prototype.renderTemplate=function(){var templateData,_ref1;this.template=_.template($("#thread-response-template").html());templateData=this.model.toJSON();templateData.wmdId=(_ref1=this.model.id)!=null?_ref1:(new Date).getTime();return this.template(templateData)};ThreadResponseView.prototype.render=function(){this.$el.addClass("response_"+this.model.get("id"));this.$el.html(this.renderTemplate());this.delegateEvents();this.renderShowView();this.renderAttrs();this.renderComments();return this};ThreadResponseView.prototype.afterInsert=function(){this.makeWmdEditor("comment-body");return this.hideEditorChrome()};ThreadResponseView.prototype.hideEditorChrome=function(){this.$(".wmd-button-row").hide();this.$(".wmd-preview-container").hide();this.$(".wmd-input").css({height:"35px",padding:"5px"});return this.$(".comment-post-control").hide()};ThreadResponseView.prototype.showEditorChrome=function(){this.$(".wmd-button-row").show();this.$(".wmd-preview-container").show();this.$(".comment-post-control").show();return this.$(".wmd-input").css({height:"125px",padding:"10px"})};ThreadResponseView.prototype.renderComments=function(){var collectComments,comments,_this=this;comments=new Comments;this.commentViews=[];comments.comparator=function(comment){return comment.get("created_at")};collectComments=function(comment){var children;comments.add(comment);children=new Comments(comment.get("children"));return children.each(function(child){child.parent=comment;return collectComments(child)})};this.model.get("comments").each(collectComments);return comments.each(function(comment){return _this.renderComment(comment,false,null)})};ThreadResponseView.prototype.renderComment=function(comment){var view,_this=this;comment.set("thread",this.model.get("thread"));view=new ResponseCommentView({model:comment});view.render();this.$el.find(".comments .new-comment").before(view.el);view.bind("comment:edit",function(event){if(_this.editView!=null){_this.cancelEdit(event)}_this.cancelCommentEdits();return _this.hideCommentForm()});view.bind("comment:cancel_edit",function(){return _this.showCommentForm()});this.commentViews.push(view);return view};ThreadResponseView.prototype.submitComment=function(event){var body,comment,url,view;event.preventDefault();url=this.model.urlFor("reply");body=this.getWmdContent("comment-body");if(!body.trim().length){return}this.setWmdContent("comment-body","");comment=new Comment({body:body,created_at:(new Date).toISOString(),username:window.user.get("username"),abuse_flaggers:[],user_id:window.user.get("id"),id:"unsaved"});view=this.renderComment(comment);this.hideEditorChrome();this.trigger("comment:add",comment);return DiscussionUtil.safeAjax({$elem:$(event.target),url:url,type:"POST",dataType:"json",data:{body:body},success:function(response,textStatus){comment.set(response.content);comment.updateInfo(response.annotated_content_info);return view.render()}})};ThreadResponseView.prototype._delete=function(event){var $elem,url,_this=this;event.preventDefault();if(!this.model.can("can_delete")){return}if(!confirm(gettext("Are you sure you want to delete this response?"))){return}url=this.model.urlFor("_delete");this.model.remove();this.$el.remove();$elem=$(event.target);return DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(response,textStatus){}})};ThreadResponseView.prototype.createEditView=function(){if(this.showView!=null){this.showView.undelegateEvents();this.showView.$el.empty();this.showView=null}this.editView=new ThreadResponseEditView({model:this.model});this.editView.bind("response:update",this.update);return this.editView.bind("response:cancel_edit",this.cancelEdit)};ThreadResponseView.prototype.renderSubView=function(view){view.setElement(this.$(".discussion-response"));view.render();return view.delegateEvents()};ThreadResponseView.prototype.renderEditView=function(){return this.renderSubView(this.editView)};ThreadResponseView.prototype.cancelCommentEdits=function(){return _.each(this.commentViews,function(view){return view.cancelEdit()})};ThreadResponseView.prototype.hideCommentForm=function(){return this.$(".comment-form").closest("li").hide()};ThreadResponseView.prototype.showCommentForm=function(){return this.$(".comment-form").closest("li").show()};ThreadResponseView.prototype.createShowView=function(){if(this.editView!=null){this.editView.undelegateEvents();this.editView.$el.empty();this.editView=null}this.showView=new ThreadResponseShowView({model:this.model});this.showView.bind("response:_delete",this._delete);return this.showView.bind("response:edit",this.edit)};ThreadResponseView.prototype.renderShowView=function(){return this.renderSubView(this.showView)};ThreadResponseView.prototype.cancelEdit=function(event){event.preventDefault();this.createShowView();this.renderShowView();return this.showCommentForm()};ThreadResponseView.prototype.edit=function(event){this.createEditView();this.renderEditView();this.cancelCommentEdits();return this.hideCommentForm()};ThreadResponseView.prototype.update=function(event){var newBody,url,_this=this;newBody=this.editView.$(".edit-post-body textarea").val();url=DiscussionUtil.urlFor("update_comment",this.model.id);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:true,data:{body:newBody},error:DiscussionUtil.formErrorHandler(this.$(".edit-post-form-errors")),success:function(response,textStatus){_this.editView.$(".edit-post-body textarea").val("").attr("prev-text","");_this.editView.$(".wmd-preview p").html("");_this.model.set({body:newBody});_this.createShowView();_this.renderShowView();return _this.showCommentForm()}})};return ThreadResponseView}(DiscussionContentView)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadListView=function(_super){__extends(DiscussionThreadListView,_super);function DiscussionThreadListView(){this.updateEmailNotifications=__bind(this.updateEmailNotifications,this);this.retrieveFollowed=__bind(this.retrieveFollowed,this);this.toggleTopicDrop=__bind(this.toggleTopicDrop,this);this.threadRemoved=__bind(this.threadRemoved,this);this.threadSelected=__bind(this.threadSelected,this);this.renderThreadListItem=__bind(this.renderThreadListItem,this);this.renderThread=__bind(this.renderThread,this);this.renderThreads=__bind(this.renderThreads,this);this.updateSidebar=__bind(this.updateSidebar,this);this.addAndSelectThread=__bind(this.addAndSelectThread,this);this.reloadDisplayedCollection=__bind(this.reloadDisplayedCollection,this);_ref=DiscussionThreadListView.__super__.constructor.apply(this,arguments);return _ref}DiscussionThreadListView.prototype.events={"click .search":"showSearch","click .home":"goHome","click .browse":"toggleTopicDrop","keydown .post-search-field":"performSearch","focus .post-search-field":"showSearch","click .sort-bar a":"sortThreads","click .browse-topic-drop-menu":"filterTopic","click .browse-topic-drop-search-input":"ignoreClick","click .post-list .list-item a":"threadSelected","click .post-list .more-pages a":"loadMorePages","change .cohort-options":"chooseCohort","keyup .browse-topic-drop-search-input":DiscussionFilter.filterDrop};DiscussionThreadListView.prototype.initialize=function(){var _this=this;this.displayedCollection=new Discussion(this.collection.models,{pages:this.collection.pages});this.collection.on("change",this.reloadDisplayedCollection);this.sortBy="date";this.discussionIds="";this.collection.on("reset",function(discussion){var board;board=$(".current-board").html();_this.displayedCollection.current_page=discussion.current_page;_this.displayedCollection.pages=discussion.pages;return _this.displayedCollection.reset(discussion.models)});this.collection.on("add",this.addAndSelectThread);this.sidebar_padding=10;this.sidebar_header_height=87;this.boardName;this.template=_.template($("#thread-list-template").html());this.current_search="";return this.mode="all"};DiscussionThreadListView.prototype.reloadDisplayedCollection=function(thread){var active,content,current_el,thread_id;thread_id=thread.get("id");content=this.renderThread(thread);current_el=this.$("a[data-id="+thread_id+"]");active=current_el.hasClass("active");current_el.replaceWith(content);if(active){return this.setActiveThread(thread_id)}};DiscussionThreadListView.prototype.addAndSelectThread=function(thread){var commentable,commentable_id,_this=this;commentable_id=thread.get("commentable_id");commentable=this.$(".board-name[data-discussion_id]").filter(function(){return $(this).data("discussion_id").id===commentable_id});this.setTopicHack(commentable);return this.retrieveDiscussion(commentable_id,function(){return _this.trigger("thread:created",thread.get("id"))})};DiscussionThreadListView.prototype.updateSidebar=function(){var discussionBody,discussionsBodyTop,scrollTop,sidebar,sidebarWidth;scrollTop=$(window).scrollTop();discussionBody=$(".discussion-article");discussionsBodyTop=discussionBody[0]?discussionBody.offset().top:void 0;sidebar=$(".sidebar");if(scrollTop>discussionsBodyTop-this.sidebar_padding){sidebar.css("top",scrollTop-discussionsBodyTop+this.sidebar_padding)}else{sidebar.css("top","0")}sidebarWidth=.31*$(".discussion-body").width();return sidebar.css("width",sidebarWidth+"px")};DiscussionThreadListView.prototype.ignoreClick=function(event){return event.stopPropagation()};DiscussionThreadListView.prototype.render=function(){this.timer=0;this.$el.html(this.template());$(window).bind("load",this.updateSidebar);$(window).bind("scroll",this.updateSidebar);$(window).bind("resize",this.updateSidebar);this.displayedCollection.on("reset",this.renderThreads);this.displayedCollection.on("thread:remove",this.renderThreads);this.renderThreads();return this};DiscussionThreadListView.prototype.renderThreads=function(){var content,rendered,thread,_i,_len,_ref1;this.$(".post-list").html("");rendered=$("<div></div>");_ref1=this.displayedCollection.models;for(_i=0,_len=_ref1.length;_i<_len;_i++){thread=_ref1[_i];content=this.renderThread(thread);rendered.append(content);content.wrap("<li class='list-item' data-id='\""+thread.get("id")+"\"' />")}this.$(".post-list").html(rendered.html());this.renderMorePages();this.updateSidebar();return this.trigger("threads:rendered")};DiscussionThreadListView.prototype.renderMorePages=function(){if(this.displayedCollection.hasMorePages()){return this.$(".post-list").append("<li class='more-pages'><a href='#'>"+gettext("Load more")+"</a></li>")
}};DiscussionThreadListView.prototype.loadMorePages=function(event){var error,lastThread,loadingDiv,options,_ref1,_this=this;if(event){event.preventDefault()}this.$(".more-pages").html('<div class="loading-animation" tabindex=0><span class="sr" role="alert">'+gettext("Loading more threads")+"</span></div>");this.$(".more-pages").addClass("loading");loadingDiv=this.$(".more-pages .loading-animation");DiscussionUtil.makeFocusTrap(loadingDiv);loadingDiv.focus();options={};switch(this.mode){case"search":options.search_text=this.current_search;if(this.group_id){options.group_id=this.group_id}break;case"followed":options.user_id=window.user.id;options.group_id="all";break;case"commentables":options.commentable_ids=this.discussionIds;if(this.group_id){options.group_id=this.group_id}break;case"all":if(this.group_id){options.group_id=this.group_id}}lastThread=(_ref1=this.collection.last())!=null?_ref1.get("id"):void 0;if(lastThread){this.once("threads:rendered",function(){return $(".post-list li:has(a[data-id='"+lastThread+"']) + li a").focus()})}else{this.once("threads:rendered",function(){var _ref2;return(_ref2=$(".post-list a").first())!=null?_ref2.focus():void 0})}error=function(){_this.renderThreads();return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more threads. Please try again."))};return this.collection.retrieveAnotherPage(this.mode,options,{sort_key:this.sortBy},error)};DiscussionThreadListView.prototype.renderThread=function(thread){var content,unreadCount;content=$(_.template($("#thread-list-item-template").html())(thread.toJSON()));if(thread.get("subscribed")){content.addClass("followed")}if(thread.get("endorsed")){content.addClass("resolved")}if(thread.get("read")){content.addClass("read")}unreadCount=thread.get("unread_comments_count");if(unreadCount>0){content.find(".comments-count").addClass("unread").attr("data-tooltip",interpolate(ngettext("%(unread_count)s new comment","%(unread_count)s new comments",unreadCount),{unread_count:thread.get("unread_comments_count")},true))}return this.highlight(content)};DiscussionThreadListView.prototype.highlight=function(el){return el.html(el.html().replace(/&lt;mark&gt;/g,"<mark>").replace(/&lt;\/mark&gt;/g,"</mark>"))};DiscussionThreadListView.prototype.renderThreadListItem=function(thread){var view;view=new ThreadListItemView({model:thread});view.on("thread:selected",this.threadSelected);view.on("thread:removed",this.threadRemoved);view.render();return this.$(".post-list").append(view.el)};DiscussionThreadListView.prototype.threadSelected=function(e){var thread_id;thread_id=$(e.target).closest("a").attr("data-id");this.setActiveThread(thread_id);this.trigger("thread:selected",thread_id);return false};DiscussionThreadListView.prototype.threadRemoved=function(thread_id){return this.trigger("thread:removed",thread_id)};DiscussionThreadListView.prototype.setActiveThread=function(thread_id){this.$(".post-list a[data-id!='"+thread_id+"']").removeClass("active");return this.$(".post-list a[data-id='"+thread_id+"']").addClass("active")};DiscussionThreadListView.prototype.showSearch=function(){this.$(".browse").removeClass("is-dropped");this.hideTopicDrop();this.$(".search").addClass("is-open");this.$(".browse").removeClass("is-open");if(!this.$(".post-search-field").is(":focus")){return setTimeout(function(){return this.$(".post-search-field").focus()},200)}};DiscussionThreadListView.prototype.goHome=function(){var thread_id,url,_this=this;this.template=_.template($("#discussion-home").html());$(".discussion-column").html(this.template);$(".post-list a").removeClass("active");$("input.email-setting").bind("click",this.updateEmailNotifications);url=DiscussionUtil.urlFor("notifications_status",window.user.get("id"));DiscussionUtil.safeAjax({url:url,type:"GET",success:function(response,textStatus){if(response.status){return $("input.email-setting").attr("checked","checked")}else{return $("input.email-setting").removeAttr("checked")}}});thread_id=null;this.trigger("thread:removed");return this.updateSidebar()};DiscussionThreadListView.prototype.toggleTopicDrop=function(event){event.preventDefault();event.stopPropagation();if(this.current_search!==""){this.clearSearch()}this.$(".search").removeClass("is-open");this.$(".browse").addClass("is-open");this.$(".browse").toggleClass("is-dropped");if(this.$(".browse").hasClass("is-dropped")){this.$(".browse-topic-drop-menu-wrapper").show();$(".browse-topic-drop-search-input").focus();$("body").bind("click",this.toggleTopicDrop);return $("body").bind("keydown",this.setActiveItem)}else{return this.hideTopicDrop()}};DiscussionThreadListView.prototype.hideTopicDrop=function(){this.$(".browse-topic-drop-menu-wrapper").hide();$("body").unbind("click",this.toggleTopicDrop);return $("body").unbind("keydown",this.setActiveItem)};DiscussionThreadListView.prototype.setTopicHack=function(boardNameContainer){var boardName,item;item=$(boardNameContainer).closest("a");boardName=item.find(".board-name").text();_.each(item.parents("ul").not(".browse-topic-drop-menu"),function(parent){return boardName=$(parent).siblings("a").find(".board-name").text()+" / "+boardName});return this.$(".current-board").html(this.fitName(boardName))};DiscussionThreadListView.prototype.setTopic=function(event){var boardName,item;item=$(event.target).closest("a");boardName=item.find(".board-name").text();_.each(item.parents("ul").not(".browse-topic-drop-menu"),function(parent){return boardName=$(parent).siblings("a").find(".board-name").text()+" / "+boardName});return this.$(".current-board").html(this.fitName(boardName))};DiscussionThreadListView.prototype.setSelectedTopic=function(name){return this.$(".current-board").html(this.fitName(name))};DiscussionThreadListView.prototype.getNameWidth=function(name){var test,width;test=$("<div>");test.css({"font-size":this.$(".current-board").css("font-size"),opacity:0,position:"absolute",left:-1e3,top:-1e3});$("body").append(test);test.html(name);width=test.width();test.remove();return width};DiscussionThreadListView.prototype.fitName=function(name){var partialName,path,rawName,shortPrefix,width,x;this.maxNameWidth=this.$el.width()*.8-50;width=this.getNameWidth(name);if(width<this.maxNameWidth){return name}path=function(){var _i,_len,_ref1,_results;_ref1=name.split("/");_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){x=_ref1[_i];_results.push(x.replace(/^\s+|\s+$/g,""))}return _results}();shortPrefix=path.length>1?gettext("…")+"/":"";while(path.length>1){path.shift();partialName=shortPrefix+path.join("/");if(this.getNameWidth(partialName)<this.maxNameWidth){return partialName}}rawName=path[0];name=shortPrefix+rawName;while(this.getNameWidth(name)>this.maxNameWidth){rawName=rawName.slice(0,rawName.length-1);name=shortPrefix+rawName+gettext("…")}return name};DiscussionThreadListView.prototype.filterTopic=function(event){var discussionId,discussionIds,item;if(this.current_search!==""){this.setTopic(event);return this.clearSearch(this.filterTopic,event)}else{this.setTopic(event);item=$(event.target).closest("li");discussionId=item.find("span.board-name").data("discussion_id");if(discussionId==="#all"){this.discussionIds="";this.$(".post-search-field").val("");this.$(".cohort").show();return this.retrieveAllThreads()}else if(discussionId==="#flagged"){this.discussionIds="";this.$(".post-search-field").val("");this.$(".cohort").hide();return this.retrieveFlaggedThreads()}else if(discussionId==="#following"){this.retrieveFollowed(event);return this.$(".cohort").hide()}else{discussionIds=_.map(item.find(".board-name[data-discussion_id]"),function(board){return $(board).data("discussion_id").id});if($(event.target).attr("cohorted")==="True"){return this.retrieveDiscussions(discussionIds,"function(){$('.cohort').show();}")}else{return this.retrieveDiscussions(discussionIds,"function(){$('.cohort').hide();}")}}}};DiscussionThreadListView.prototype.chooseCohort=function(event){this.group_id=this.$(".cohort-options :selected").val();this.collection.current_page=0;this.collection.reset();return this.loadMorePages(event)};DiscussionThreadListView.prototype.retrieveDiscussion=function(discussion_id,callback){var url,_this=this;if(callback==null){callback=null}url=DiscussionUtil.urlFor("retrieve_discussion",discussion_id);return DiscussionUtil.safeAjax({url:url,type:"GET",success:function(response,textStatus){_this.collection.current_page=response.page;_this.collection.pages=response.num_pages;_this.collection.reset(response.discussion_data);Content.loadContentInfos(response.annotated_content_info);_this.displayedCollection.reset(_this.collection.models);if(callback!=null){return callback()}}})};DiscussionThreadListView.prototype.retrieveDiscussions=function(discussion_ids){this.discussionIds=discussion_ids.join(",");this.mode="commentables";return this.retrieveFirstPage()};DiscussionThreadListView.prototype.retrieveAllThreads=function(){this.mode="all";return this.retrieveFirstPage()};DiscussionThreadListView.prototype.retrieveFirstPage=function(event){this.collection.current_page=0;this.collection.reset();return this.loadMorePages(event)};DiscussionThreadListView.prototype.retrieveFlaggedThreads=function(event){this.collection.current_page=0;this.collection.reset();this.mode="flagged";return this.loadMorePages(event)};DiscussionThreadListView.prototype.sortThreads=function(event){var activeSort,newSort;activeSort=this.$(".sort-bar a[class='active']");activeSort.removeClass("active");activeSort.attr("aria-checked","false");newSort=$(event.target);newSort.addClass("active");newSort.attr("aria-checked","true");this.sortBy=newSort.data("sort");this.displayedCollection.comparator=function(){switch(this.sortBy){case"date":return this.displayedCollection.sortByDateRecentFirst;case"votes":return this.displayedCollection.sortByVotes;case"comments":return this.displayedCollection.sortByComments}}.call(this);return this.retrieveFirstPage(event)};DiscussionThreadListView.prototype.performSearch=function(event){var text;if(event.which===13){event.preventDefault();text=this.$(".post-search-field").val();return this.searchFor(text)}};DiscussionThreadListView.prototype.searchFor=function(text,callback,value){var url,_this=this;this.mode="search";this.current_search=text;url=DiscussionUtil.urlFor("search");return DiscussionUtil.safeAjax({$elem:this.$(".post-search-field"),data:{text:text},url:url,type:"GET",$loading:$,loadingCallback:function(){return _this.$(".post-list").html('<li class="loading"><div class="loading-animation"><span class="sr">'+gettext("Loading thread list")+"</span></div></li>")},loadedCallback:function(){if(callback){return callback.apply(_this,[value])}},success:function(response,textStatus){if(textStatus==="success"){_this.collection.reset(response.discussion_data);Content.loadContentInfos(response.annotated_content_info);_this.collection.current_page=response.page;_this.collection.pages=response.num_pages;return _this.displayedCollection.reset(_this.collection.models)}}})};DiscussionThreadListView.prototype.clearSearch=function(callback,value){this.$(".post-search-field").val("");return this.searchFor("",callback,value)};DiscussionThreadListView.prototype.setActiveItem=function(event){var index,itemFromTop,itemTop,items,scrollTarget,scrollTop;if(event.which===13){$(".browse-topic-drop-menu-wrapper .focused").click();return}if(event.which!==40&&event.which!==38){return}event.preventDefault();items=$.makeArray($(".browse-topic-drop-menu-wrapper a").not(".hidden"));index=items.indexOf($(".browse-topic-drop-menu-wrapper .focused")[0]);if(event.which===40){index=Math.min(index+1,items.length-1)}if(event.which===38){index=Math.max(index-1,0)}$(".browse-topic-drop-menu-wrapper .focused").removeClass("focused");$(items[index]).addClass("focused");itemTop=$(items[index]).parent().offset().top;scrollTop=$(".browse-topic-drop-menu").scrollTop();itemFromTop=$(".browse-topic-drop-menu").offset().top-itemTop;scrollTarget=Math.min(scrollTop-itemFromTop,scrollTop);scrollTarget=Math.max(scrollTop-itemFromTop-$(".browse-topic-drop-menu").height()+$(items[index]).height(),scrollTarget);return $(".browse-topic-drop-menu").scrollTop(scrollTarget)};DiscussionThreadListView.prototype.retrieveFollowed=function(event){this.mode="followed";return this.retrieveFirstPage(event)};DiscussionThreadListView.prototype.updateEmailNotifications=function(){var _this=this;if($("input.email-setting").is(":checked")){return DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("enable_notifications"),type:"POST",error:function(){return $("input.email-setting").removeAttr("checked")}})}else{return DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("disable_notifications"),type:"POST",error:function(){return $("input.email-setting").attr("checked","checked")}})}};return DiscussionThreadListView}(Backbone.View)}}).call(this);(function(){var _ref,_ref1,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadShowView=function(_super){__extends(DiscussionThreadShowView,_super);function DiscussionThreadShowView(){this.unPin=__bind(this.unPin,this);this.pin=__bind(this.pin,this);this.togglePin=__bind(this.togglePin,this);this.updateModelDetails=__bind(this.updateModelDetails,this);this.renderPinned=__bind(this.renderPinned,this);this.renderFlagged=__bind(this.renderFlagged,this);_ref=DiscussionThreadShowView.__super__.constructor.apply(this,arguments);return _ref}DiscussionThreadShowView.prototype.events={"click .vote-btn":function(event){return this.toggleVote(event)},"keydown .vote-btn":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleVote)},"click .discussion-flag-abuse":"toggleFlagAbuse","keydown .discussion-flag-abuse":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleFlagAbuse)},"click .admin-pin":function(event){return this.togglePin(event)},"keydown .admin-pin":function(event){return DiscussionUtil.activateOnSpace(event,this.togglePin)},"click .action-follow":"toggleFollowing","keydown .action-follow":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleFollowing)},"click .action-edit":"edit","click .action-delete":"_delete","click .action-openclose":"toggleClosed"};DiscussionThreadShowView.prototype.$=function(selector){return this.$el.find(selector)};DiscussionThreadShowView.prototype.initialize=function(){DiscussionThreadShowView.__super__.initialize.call(this);return this.model.on("change",this.updateModelDetails)};DiscussionThreadShowView.prototype.renderTemplate=function(){this.template=_.template($("#thread-show-template").html());return this.template(this.model.toJSON())};DiscussionThreadShowView.prototype.render=function(){this.$el.html(this.renderTemplate());this.delegateEvents();this.renderVote();this.renderFlagged();this.renderPinned();this.renderAttrs();this.$("span.timeago").timeago();this.convertMath();this.highlight(this.$(".post-body"));this.highlight(this.$("h1,h3"));return this};DiscussionThreadShowView.prototype.renderFlagged=function(){var _ref1;if((_ref1=window.user.id,__indexOf.call(this.model.get("abuse_flaggers"),_ref1)>=0)||DiscussionUtil.isFlagModerator&&this.model.get("abuse_flaggers").length>0){this.$("[data-role=thread-flag]").addClass("flagged");this.$("[data-role=thread-flag]").removeClass("notflagged");this.$(".discussion-flag-abuse").attr("aria-pressed","true");this.$(".discussion-flag-abuse").attr("data-tooltip",gettext("Click to remove report"));return this.$(".discussion-flag-abuse .flag-label").html(interpolate(gettext("Misuse Reported%(start_sr_span)s, click to remove report%(end_span)s"),{start_sr_span:"<span class='sr'>",end_span:"</span>"},true))}else{this.$("[data-role=thread-flag]").removeClass("flagged");this.$("[data-role=thread-flag]").addClass("notflagged");this.$(".discussion-flag-abuse").attr("aria-pressed","false");return this.$(".discussion-flag-abuse .flag-label").html(gettext("Report Misuse"))}};DiscussionThreadShowView.prototype.renderPinned=function(){var pinElem,pinLabelElem;pinElem=this.$(".discussion-pin");pinLabelElem=pinElem.find(".pin-label");if(this.model.get("pinned")){pinElem.addClass("pinned");pinElem.removeClass("notpinned");if(this.model.can("can_openclose")){pinLabelElem.html(interpolate(gettext("Pinned%(start_sr_span)s, click to unpin%(end_span)s"),{start_sr_span:"<span class='sr'>",end_span:"</span>"},true));pinElem.attr("data-tooltip",gettext("Click to unpin"));return pinElem.attr("aria-pressed","true")}else{pinLabelElem.html(gettext("Pinned"));pinElem.removeAttr("data-tooltip");return pinElem.removeAttr("aria-pressed")}}else{pinElem.removeClass("pinned");pinElem.addClass("notpinned");pinLabelElem.html(gettext("Pin Thread"));pinElem.removeAttr("data-tooltip");return pinElem.attr("aria-pressed","false")}};DiscussionThreadShowView.prototype.updateModelDetails=function(){this.renderVote();this.renderFlagged();return this.renderPinned()};DiscussionThreadShowView.prototype.convertMath=function(){var element;element=this.$(".post-body");element.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(element.text())));return MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]])};DiscussionThreadShowView.prototype.edit=function(event){return this.trigger("thread:edit",event)};DiscussionThreadShowView.prototype._delete=function(event){return this.trigger("thread:_delete",event)};DiscussionThreadShowView.prototype.togglePin=function(event){event.preventDefault();if(this.model.get("pinned")){return this.unPin()}else{return this.pin()}};DiscussionThreadShowView.prototype.pin=function(){var url,_this=this;url=this.model.urlFor("pinThread");return DiscussionUtil.safeAjax({$elem:this.$(".discussion-pin"),url:url,type:"POST",success:function(response,textStatus){if(textStatus==="success"){return _this.model.set("pinned",true)}},error:function(){return DiscussionUtil.discussionAlert("Sorry","We had some trouble pinning this thread. Please try again.")}})};DiscussionThreadShowView.prototype.unPin=function(){var url,_this=this;url=this.model.urlFor("unPinThread");return DiscussionUtil.safeAjax({$elem:this.$(".discussion-pin"),url:url,type:"POST",success:function(response,textStatus){if(textStatus==="success"){return _this.model.set("pinned",false)}},error:function(){return DiscussionUtil.discussionAlert("Sorry","We had some trouble unpinning this thread. Please try again.")}})};DiscussionThreadShowView.prototype.toggleClosed=function(event){var $elem,closed,data,url,_this=this;$elem=$(event.target);url=this.model.urlFor("close");closed=this.model.get("closed");data={closed:!closed};return DiscussionUtil.safeAjax({$elem:$elem,url:url,data:data,type:"POST",success:function(response,textStatus){_this.model.set("closed",!closed);return _this.model.set("ability",response.ability)}})};DiscussionThreadShowView.prototype.toggleEndorse=function(event){var $elem,data,endorsed,url,_this=this;$elem=$(event.target);url=this.model.urlFor("endorse");endorsed=this.model.get("endorsed");data={endorsed:!endorsed};return DiscussionUtil.safeAjax({$elem:$elem,url:url,data:data,type:"POST",success:function(response,textStatus){return _this.model.set("endorsed",!endorsed)}})};DiscussionThreadShowView.prototype.highlight=function(el){if(el.html()){return el.html(el.html().replace(/&lt;mark&gt;/g,"<mark>").replace(/&lt;\/mark&gt;/g,"</mark>"))}};return DiscussionThreadShowView}(DiscussionContentView);this.DiscussionThreadInlineShowView=function(_super){__extends(DiscussionThreadInlineShowView,_super);function DiscussionThreadInlineShowView(){_ref1=DiscussionThreadInlineShowView.__super__.constructor.apply(this,arguments);return _ref1}DiscussionThreadInlineShowView.prototype.renderTemplate=function(){var params;this.template=DiscussionUtil.getTemplate("_inline_thread_show");params=this.model.toJSON();if(this.model.get("username")!=null){params=$.extend(params,{user:{username:this.model.username,user_url:this.model.user_url}})}return Mustache.render(this.template,params)};return DiscussionThreadInlineShowView}(DiscussionThreadShowView)}}).call(this);(function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadEditView=function(_super){__extends(DiscussionThreadEditView,_super);function DiscussionThreadEditView(){_ref=DiscussionThreadEditView.__super__.constructor.apply(this,arguments);return _ref}DiscussionThreadEditView.prototype.events={"click .post-update":"update","click .post-cancel":"cancel_edit"};DiscussionThreadEditView.prototype.$=function(selector){return this.$el.find(selector)};DiscussionThreadEditView.prototype.initialize=function(){return DiscussionThreadEditView.__super__.initialize.call(this)};DiscussionThreadEditView.prototype.render=function(){this.template=_.template($("#thread-edit-template").html());this.$el.html(this.template(this.model.toJSON()));this.delegateEvents();DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-post-body");return this};DiscussionThreadEditView.prototype.update=function(event){return this.trigger("thread:update",event)};DiscussionThreadEditView.prototype.cancel_edit=function(event){return this.trigger("thread:cancel_edit",event)};return DiscussionThreadEditView}(Backbone.View)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ResponseCommentShowView=function(_super){__extends(ResponseCommentShowView,_super);function ResponseCommentShowView(){this.edit=__bind(this.edit,this);this.updateModelDetails=__bind(this.updateModelDetails,this);this.renderFlagged=__bind(this.renderFlagged,this);this._delete=__bind(this._delete,this);_ref=ResponseCommentShowView.__super__.constructor.apply(this,arguments);return _ref}ResponseCommentShowView.prototype.events={"click .action-delete":function(event){return this._delete(event)},"keydown .action-delete":function(event){return DiscussionUtil.activateOnSpace(event,this._delete)},"click .action-edit":function(event){return this.edit(event)},"keydown .action-edit":function(event){return DiscussionUtil.activateOnSpace(event,this.edit)}};ResponseCommentShowView.prototype.tagName="li";ResponseCommentShowView.prototype.initialize=function(){ResponseCommentShowView.__super__.initialize.call(this);return this.model.on("change",this.updateModelDetails)};ResponseCommentShowView.prototype.abilityRenderer={can_delete:{enable:function(){return this.$(".action-delete").show()},disable:function(){return this.$(".action-delete").hide()}},editable:{enable:function(){return this.$(".action-edit").show()},disable:function(){return this.$(".action-edit").hide()}}};ResponseCommentShowView.prototype.render=function(){var params;this.template=_.template($("#response-comment-show-template").html());params=this.model.toJSON();this.$el.html(this.template(params));this.initLocal();this.delegateEvents();this.renderAttrs();this.renderFlagged();this.markAsStaff();this.$el.find(".timeago").timeago();this.convertMath();this.addReplyLink();return this};ResponseCommentShowView.prototype.addReplyLink=function(){var html,name,p,_ref1;if(this.model.hasOwnProperty("parent")){name=(_ref1=this.model.parent.get("username"))!=null?_ref1:gettext("anonymous");html="<a href='#comment_"+this.model.parent.id+"'>@"+name+"</a>:  ";p=this.$(".response-body p:first");return p.prepend(html)}};ResponseCommentShowView.prototype.convertMath=function(){var body;body=this.$el.find(".response-body");body.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(body.text())));return MathJax.Hub.Queue(["Typeset",MathJax.Hub,body[0]])};ResponseCommentShowView.prototype.markAsStaff=function(){if(DiscussionUtil.isStaff(this.model.get("user_id"))){return this.$el.find("a.profile-link").after('<span class="staff-label">'+gettext("staff")+"</span>")}else if(DiscussionUtil.isTA(this.model.get("user_id"))){return this.$el.find("a.profile-link").after('<span class="community-ta-label">'+gettext("Community TA")+"</span>")}};ResponseCommentShowView.prototype._delete=function(event){return this.trigger("comment:_delete",event)};ResponseCommentShowView.prototype.renderFlagged=function(){var _ref1;if((_ref1=window.user.id,__indexOf.call(this.model.get("abuse_flaggers"),_ref1)>=0)||DiscussionUtil.isFlagModerator&&this.model.get("abuse_flaggers").length>0){this.$("[data-role=thread-flag]").addClass("flagged");this.$("[data-role=thread-flag]").removeClass("notflagged");this.$(".discussion-flag-abuse").attr("aria-pressed","true");this.$(".discussion-flag-abuse").attr("data-tooltip",gettext("Misuse Reported, click to remove report"));return this.$(".discussion-flag-abuse .flag-label").html(gettext("Misuse Reported, click to remove report"))}else{this.$("[data-role=thread-flag]").removeClass("flagged");this.$("[data-role=thread-flag]").addClass("notflagged");this.$(".discussion-flag-abuse").attr("aria-pressed","false");this.$(".discussion-flag-abuse").attr("data-tooltip",gettext("Report Misuse"));return this.$(".discussion-flag-abuse .flag-label").html(gettext("Report Misuse"))}};ResponseCommentShowView.prototype.updateModelDetails=function(){return this.renderFlagged()};ResponseCommentShowView.prototype.edit=function(event){return this.trigger("comment:edit",event)};return ResponseCommentShowView}(DiscussionContentView)}}).call(this);(function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionThreadProfileView=function(_super){__extends(DiscussionThreadProfileView,_super);function DiscussionThreadProfileView(){_ref=DiscussionThreadProfileView.__super__.constructor.apply(this,arguments);return _ref}DiscussionThreadProfileView.prototype.render=function(){var params;this.template=DiscussionUtil.getTemplate("_profile_thread");if(!this.model.has("abbreviatedBody")){this.abbreviateBody()}params=$.extend(this.model.toJSON(),{permalink:this.model.urlFor("retrieve")});if(!this.model.get("anonymous")){params=$.extend(params,{user:{username:this.model.username,user_url:this.model.user_url}})}this.$el.html(Mustache.render(this.template,params));this.$("span.timeago").timeago();this.convertMath();return this};DiscussionThreadProfileView.prototype.convertMath=function(){var element;element=this.$(".post-body");element.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(element.text())));return MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]])};DiscussionThreadProfileView.prototype.abbreviateBody=function(){var abbreviated;abbreviated=DiscussionUtil.abbreviateString(this.model.get("body"),140);return this.model.set("abbreviatedBody",abbreviated)};return DiscussionThreadProfileView}(Backbone.View)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.NewPostView=function(_super){__extends(NewPostView,_super);function NewPostView(){this.hideTopicDropdown=__bind(this.hideTopicDropdown,this);_ref=NewPostView.__super__.constructor.apply(this,arguments);return _ref}NewPostView.prototype.initialize=function(){this.dropdownButton=this.$(".topic_dropdown_button");this.topicMenu=this.$(".topic_menu_wrapper");this.menuOpen=this.dropdownButton.hasClass("dropped");this.topicId=this.$(".topic").first().data("discussion_id");this.topicText=this.getFullTopicName(this.$(".topic").first());this.maxNameWidth=100;this.setSelectedTopic();DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"new-post-body");if(this.$($(".topic_menu li a")[0]).attr("cohorted")!=="True"){return $(".choose-cohort").hide()}};NewPostView.prototype.events={"submit .new-post-form":"createPost","click  .topic_dropdown_button":"toggleTopicDropdown","click  .topic_menu_wrapper":"setTopic","click  .topic_menu_search":"ignoreClick","keyup .form-topic-drop-search-input":DiscussionFilter.filterDrop};NewPostView.prototype.ignoreClick=function(event){return event.stopPropagation()};NewPostView.prototype.toggleTopicDropdown=function(event){event.stopPropagation();if(this.menuOpen){return this.hideTopicDropdown()}else{return this.showTopicDropdown()}};NewPostView.prototype.showTopicDropdown=function(){this.menuOpen=true;this.dropdownButton.addClass("dropped");this.topicMenu.show();$(".form-topic-drop-search-input").focus();$("body").bind("keydown",this.setActiveItem);$("body").bind("click",this.hideTopicDropdown);return this.maxNameWidth=this.dropdownButton.width()*.9};NewPostView.prototype.hideTopicDropdown=function(){this.menuOpen=false;this.dropdownButton.removeClass("dropped");this.topicMenu.hide();$("body").unbind("keydown",this.setActiveItem);return $("body").unbind("click",this.hideTopicDropdown)};NewPostView.prototype.setTopic=function(event){var $target;$target=$(event.target);if($target.data("discussion_id")){this.topicText=$target.html();this.topicText=this.getFullTopicName($target);this.topicId=$target.data("discussion_id");this.setSelectedTopic();if($target.attr("cohorted")==="True"){return $(".choose-cohort").show()}else{return $(".choose-cohort").hide()}}};NewPostView.prototype.setSelectedTopic=function(){return this.dropdownButton.html(this.fitName(this.topicText)+' <span class="drop-arrow">▾</span>')};NewPostView.prototype.getFullTopicName=function(topicElement){var name;name=topicElement.html();topicElement.parents("ul").not(".topic_menu").each(function(){return name=$(this).siblings("a").html()+" / "+name});return name};NewPostView.prototype.getNameWidth=function(name){var test,width;test=$("<div>");test.css({"font-size":this.dropdownButton.css("font-size"),opacity:0,position:"absolute",left:-1e3,top:-1e3});$("body").append(test);test.html(name);width=test.width();test.remove();return width};NewPostView.prototype.fitName=function(name){var partialName,path,rawName,width,x;width=this.getNameWidth(name);if(width<this.maxNameWidth){return name}path=function(){var _i,_len,_ref1,_results;_ref1=name.split("/");_results=[];for(_i=0,_len=_ref1.length;_i<_len;_i++){x=_ref1[_i];_results.push(x.replace(/^\s+|\s+$/g,""))}return _results}();while(path.length>1){path.shift();partialName=gettext("…")+" / "+path.join(" / ");if(this.getNameWidth(partialName)<this.maxNameWidth){return partialName}}rawName=path[0];name=gettext("…")+" / "+rawName;while(this.getNameWidth(name)>this.maxNameWidth){rawName=rawName.slice(0,rawName.length-1);
name=gettext("…")+" / "+rawName+" "+gettext("…")}return name};NewPostView.prototype.createPost=function(event){var anonymous,anonymous_to_peers,body,follow,group,thread_type,title,url,_this=this;event.preventDefault();title=this.$(".new-post-title").val();body=this.$(".new-post-body").find(".wmd-input").val();group=this.$(".new-post-group option:selected").attr("value");anonymous=false||this.$("input.discussion-anonymous").is(":checked");anonymous_to_peers=false||this.$("input.discussion-anonymous-to-peers").is(":checked");follow=false||this.$("input.discussion-follow").is(":checked");thread_type="discussion";url=DiscussionUtil.urlFor("create_thread",this.topicId);return DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:true,data:{title:title,body:body,anonymous:anonymous,anonymous_to_peers:anonymous_to_peers,auto_subscribe:follow,group_id:group,thread_type:thread_type},error:DiscussionUtil.formErrorHandler(this.$(".new-post-form-errors")),success:function(response,textStatus){var thread;thread=new Thread(response["content"]);DiscussionUtil.clearFormErrors(_this.$(".new-post-form-errors"));_this.$el.hide();_this.$(".new-post-title").val("").attr("prev-text","");_this.$(".new-post-body textarea").val("").attr("prev-text","");_this.$(".wmd-preview p").html("");return _this.collection.add(thread)}})};NewPostView.prototype.setActiveItem=function(event){var index,itemFromTop,itemTop,items,scrollTarget,scrollTop;if(event.which===13){$(".topic_menu_wrapper .focused").click();return}if(event.which!==40&&event.which!==38){return}event.preventDefault();items=$.makeArray($(".topic_menu_wrapper a").not(".hidden"));index=items.indexOf($(".topic_menu_wrapper .focused")[0]);if(event.which===40){index=Math.min(index+1,items.length-1)}if(event.which===38){index=Math.max(index-1,0)}$(".topic_menu_wrapper .focused").removeClass("focused");$(items[index]).addClass("focused");itemTop=$(items[index]).parent().offset().top;scrollTop=$(".topic_menu").scrollTop();itemFromTop=$(".topic_menu").offset().top-itemTop;scrollTarget=Math.min(scrollTop-itemFromTop,scrollTop);scrollTarget=Math.max(scrollTop-itemFromTop-$(".topic_menu").height()+$(items[index]).height()+20,scrollTarget);return $(".topic_menu").scrollTop(scrollTarget)};return NewPostView}(Backbone.View)}}).call(this);(function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.ResponseCommentEditView=function(_super){__extends(ResponseCommentEditView,_super);function ResponseCommentEditView(){_ref=ResponseCommentEditView.__super__.constructor.apply(this,arguments);return _ref}ResponseCommentEditView.prototype.events={"click .post-update":"update","click .post-cancel":"cancel_edit"};ResponseCommentEditView.prototype.$=function(selector){return this.$el.find(selector)};ResponseCommentEditView.prototype.initialize=function(){return ResponseCommentEditView.__super__.initialize.call(this)};ResponseCommentEditView.prototype.render=function(){this.template=_.template($("#response-comment-edit-template").html());this.$el.html(this.template(this.model.toJSON()));this.delegateEvents();DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-comment-body");return this};ResponseCommentEditView.prototype.update=function(event){return this.trigger("comment:update",event)};ResponseCommentEditView.prototype.cancel_edit=function(event){return this.trigger("comment:cancel_edit",event)};return ResponseCommentEditView}(Backbone.View)}}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionRouter=function(_super){__extends(DiscussionRouter,_super);function DiscussionRouter(){this.hideNewPost=__bind(this.hideNewPost,this);this.showNewPost=__bind(this.showNewPost,this);this.navigateToAllThreads=__bind(this.navigateToAllThreads,this);this.navigateToThread=__bind(this.navigateToThread,this);this.setActiveThread=__bind(this.setActiveThread,this);_ref=DiscussionRouter.__super__.constructor.apply(this,arguments);return _ref}DiscussionRouter.prototype.routes={"":"allThreads",":forum_name/threads/:thread_id":"showThread"};DiscussionRouter.prototype.initialize=function(options){var _this=this;this.discussion=options["discussion"];this.nav=new DiscussionThreadListView({collection:this.discussion,el:$(".sidebar")});this.nav.on("thread:selected",this.navigateToThread);this.nav.on("thread:removed",this.navigateToAllThreads);this.nav.on("threads:rendered",this.setActiveThread);this.nav.render();this.newPostView=new NewPostView({el:$(".new-post-article"),collection:this.discussion});this.nav.on("thread:created",this.navigateToThread);this.newPost=$(".new-post-article");$(".new-post-btn").bind("click",this.showNewPost);$(".new-post-btn").bind("keydown",function(event){return DiscussionUtil.activateOnSpace(event,_this.showNewPost)});return $(".new-post-cancel").bind("click",this.hideNewPost)};DiscussionRouter.prototype.allThreads=function(){this.nav.updateSidebar();return this.nav.goHome()};DiscussionRouter.prototype.setActiveThread=function(){if(this.thread){return this.nav.setActiveThread(this.thread.get("id"))}else{return this.nav.goHome}};DiscussionRouter.prototype.showThread=function(forum_name,thread_id){var callback,_this=this;this.thread=this.discussion.get(thread_id);if(!this.thread){callback=function(thread){_this.thread=thread;_this.discussion.reset(_this.discussion.models.concat(thread));return _this.renderThreadView()};return this.retrieveSingleThread(forum_name,thread_id,callback)}else{return this.renderThreadView()}};DiscussionRouter.prototype.renderThreadView=function(){var _this=this;this.thread.set("unread_comments_count",0);this.thread.set("read",true);this.setActiveThread();if(this.main){this.main.cleanup();this.main.undelegateEvents()}this.main=new DiscussionThreadView({el:$(".discussion-column"),model:this.thread});this.main.render();return this.main.on("thread:responses:rendered",function(){return _this.nav.updateSidebar()})};DiscussionRouter.prototype.navigateToThread=function(thread_id){var thread;thread=this.discussion.get(thread_id);return this.navigate(""+thread.get("commentable_id")+"/threads/"+thread_id,{trigger:true})};DiscussionRouter.prototype.navigateToAllThreads=function(){return this.navigate("",{trigger:true})};DiscussionRouter.prototype.showNewPost=function(event){this.newPost.slideDown(300);return $(".new-post-title").focus()};DiscussionRouter.prototype.hideNewPost=function(event){return this.newPost.slideUp(300)};DiscussionRouter.prototype.retrieveSingleThread=function(forum_name,thread_id,callback){var _this=this;return DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("retrieve_single_thread",forum_name,thread_id),success:function(data,textStatus,xhr){return callback(new Thread(data["content"]))},error:function(xhr){if(xhr.status===404){DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("The thread you selected has been deleted. Please select another thread."))}else{DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more responses. Please try again."))}return _this.allThreads()}})};return DiscussionRouter}(Backbone.Router)}}).call(this);(function(){$(function(){if(!window.$$contents){window.$$contents={}}return $.fn.extend({loading:function(takeFocus){this.$_loading=$("<div class='loading-animation' tabindex='0'><span class='sr'>"+gettext("Loading content")+"</span></div>");$(this).after(this.$_loading);if(takeFocus){DiscussionUtil.makeFocusTrap(this.$_loading);return this.$_loading.focus()}},loaded:function(){return this.$_loading.remove()}})});this.DiscussionUtil=function(){function DiscussionUtil(){}DiscussionUtil.baseUrl="";DiscussionUtil.wmdEditors={};DiscussionUtil.setBaseUrl=function(baseUrl){return this.baseUrl=baseUrl};DiscussionUtil.getTemplate=function(id){return $("script#"+id).html()};DiscussionUtil.loadRoles=function(roles){return this.roleIds=roles};DiscussionUtil.loadFlagModerator=function(what){return this.isFlagModerator=what==="True"||what===1};DiscussionUtil.loadRolesFromContainer=function(){this.loadRoles($("#discussion-container").data("roles"));return this.loadFlagModerator($("#discussion-container").data("flag-moderator"))};DiscussionUtil.isStaff=function(user_id){var staff;staff=_.union(this.roleIds["Moderator"],this.roleIds["Administrator"]);return _.include(staff,parseInt(user_id))};DiscussionUtil.isTA=function(user_id){var ta;ta=_.union(this.roleIds["Community TA"]);return _.include(ta,parseInt(user_id))};DiscussionUtil.bulkUpdateContentInfo=function(infos){var id,info,_results;_results=[];for(id in infos){info=infos[id];_results.push(Content.getContent(id).updateInfo(info))}return _results};DiscussionUtil.generateDiscussionLink=function(cls,txt,handler){return $("<a>").addClass("discussion-link").attr("href","javascript:void(0)").addClass(cls).html(txt).click(function(){return handler(this)})};DiscussionUtil.urlFor=function(name,param,param1,param2){var urls;urls={follow_discussion:"/courses/"+$$course_id+"/discussion/"+param+"/follow",unfollow_discussion:"/courses/"+$$course_id+"/discussion/"+param+"/unfollow",create_thread:"/courses/"+$$course_id+"/discussion/"+param+"/threads/create",update_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/update",create_comment:"/courses/"+$$course_id+"/discussion/threads/"+param+"/reply",delete_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/delete",flagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/flagAbuse",unFlagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unFlagAbuse",flagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/flagAbuse",unFlagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/unFlagAbuse",upvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/upvote",downvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/downvote",pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/pin",un_pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unpin",undo_vote_for_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unvote",follow_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/follow",unfollow_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unfollow",update_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/update",endorse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/endorse",create_sub_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/reply",delete_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/delete",upvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/upvote",downvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/downvote",undo_vote_for_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/unvote",upload:"/courses/"+$$course_id+"/discussion/upload",search:"/courses/"+$$course_id+"/discussion/forum/search",retrieve_discussion:"/courses/"+$$course_id+"/discussion/forum/"+param+"/inline",retrieve_single_thread:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1,openclose_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/close",permanent_link_thread:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1,permanent_link_comment:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1+"#"+param2,user_profile:"/courses/"+$$course_id+"/discussion/forum/users/"+param,followed_threads:"/courses/"+$$course_id+"/discussion/forum/users/"+param+"/followed",threads:"/courses/"+$$course_id+"/discussion/forum",enable_notifications:"/notification_prefs/enable/",disable_notifications:"/notification_prefs/disable/",notifications_status:"/notification_prefs/status/"};return this.baseUrl+urls[name]};DiscussionUtil.activateOnSpace=function(event,func){if(event.which===32){event.preventDefault();return func(event)}};DiscussionUtil.makeFocusTrap=function(elem){return elem.keydown(function(event){if(event.which===9){return event.preventDefault()}})};DiscussionUtil.discussionAlert=function(header,body){var alertDiv,alertTrigger;if($("#discussion-alert").length===0){alertDiv=$("<div class='modal' role='alertdialog' id='discussion-alert' aria-describedby='discussion-alert-message'/>").css("display","none");alertDiv.html("<div class='inner-wrapper discussion-alert-wrapper'>"+"  <button class='close-modal dismiss' aria-hidden='true'><i class='icon-remove'></i></button>"+"  <header><h2/><hr/></header>"+"  <p id='discussion-alert-message'/>"+"  <hr/>"+"  <button class='dismiss'>"+gettext("OK")+"</button>"+"</div>");this.makeFocusTrap(alertDiv.find("button"));alertTrigger=$("<a href='#discussion-alert' id='discussion-alert-trigger'/>").css("display","none");alertTrigger.leanModal({closeButton:"#discussion-alert .dismiss",overlay:1,top:200});$("body").append(alertDiv).append(alertTrigger)}$("#discussion-alert header h2").html(header);$("#discussion-alert p").html(body);$("#discussion-alert-trigger").click();return $("#discussion-alert button").focus()};DiscussionUtil.safeAjax=function(params){var $elem,beforeSend,errorCallback,request,_this=this;$elem=params.$elem;if($elem&&$elem.attr("disabled")){return}params["url"]=URI(params["url"]).addSearch({ajax:1});beforeSend=function(){if($elem){$elem.attr("disabled","disabled")}if(params["$loading"]){if(params["loadingCallback"]!=null){return params["loadingCallback"].apply(params["$loading"])}else{return params["$loading"].loading(params["takeFocus"])}}};errorCallback=params["error"]?params["error"]:function(){return _this.discussionAlert(gettext("Sorry"),gettext("We had some trouble processing your request. Please ensure you have copied any unsaved work and then reload the page."))};params["error"]=function(xhr,textStatus,errorThrown){if(textStatus!=="abort"){return errorCallback(xhr,textStatus,errorThrown)}};beforeSend();request=$.ajax(params).always(function(){if($elem){$elem.removeAttr("disabled")}if(params["$loading"]){if(params["loadedCallback"]!=null){return params["loadedCallback"].apply(params["$loading"])}else{return params["$loading"].loaded()}}});return request};DiscussionUtil.bindLocalEvents=function($local,eventsHandler){var event,eventSelector,handler,selector,_ref,_results;_results=[];for(eventSelector in eventsHandler){handler=eventsHandler[eventSelector];_ref=eventSelector.split(" "),event=_ref[0],selector=_ref[1];_results.push($local(selector).unbind(event)[event](handler))}return _results};DiscussionUtil.formErrorHandler=function(errorsField){return function(xhr,textStatus,error){var makeErrorElem,response,_i,_len,_ref,_results;makeErrorElem=function(message){return $("<li>").addClass("new-post-form-error").html(message)};errorsField.empty().show();if(xhr.status===400){response=JSON.parse(xhr.responseText);if(response.errors!=null&&response.errors.length>0){_ref=response.errors;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){error=_ref[_i];_results.push(errorsField.append(makeErrorElem(error)))}return _results}}else{return errorsField.append(makeErrorElem(gettext("We had some trouble processing your request. Please try again.")))}}};DiscussionUtil.clearFormErrors=function(errorsField){return errorsField.empty()};DiscussionUtil.postMathJaxProcessor=function(text){var RE_DISPLAYMATH,RE_INLINEMATH;RE_INLINEMATH=/^\$([^\$]*)\$/g;RE_DISPLAYMATH=/^\$\$([^\$]*)\$\$/g;return this.processEachMathAndCode(text,function(s,type){if(type==="display"){return s.replace(RE_DISPLAYMATH,function($0,$1){return"\\["+$1+"\\]"})}else if(type==="inline"){return s.replace(RE_INLINEMATH,function($0,$1){return"\\("+$1+"\\)"})}else{return s}})};DiscussionUtil.makeWmdEditor=function($content,$local,cls_identifier){var appended_id,editor,elem,id,imageUploadUrl,placeholder,_processor;elem=$local("."+cls_identifier);placeholder=elem.data("placeholder");id=elem.attr("data-id");appended_id="-"+cls_identifier+"-"+id;imageUploadUrl=this.urlFor("upload");_processor=function(_this){return function(text){return _this.postMathJaxProcessor(text)}};editor=Markdown.makeWmdEditor(elem,appended_id,imageUploadUrl,_processor(this));this.wmdEditors[""+cls_identifier+"-"+id]=editor;if(placeholder!=null){elem.find("#wmd-input"+appended_id).attr("placeholder",placeholder)}return editor};DiscussionUtil.getWmdEditor=function($content,$local,cls_identifier){var elem,id;elem=$local("."+cls_identifier);id=elem.attr("data-id");return this.wmdEditors[""+cls_identifier+"-"+id]};DiscussionUtil.getWmdInput=function($content,$local,cls_identifier){var elem,id;elem=$local("."+cls_identifier);id=elem.attr("data-id");return $local("#wmd-input-"+cls_identifier+"-"+id)};DiscussionUtil.getWmdContent=function($content,$local,cls_identifier){return this.getWmdInput($content,$local,cls_identifier).val()};DiscussionUtil.setWmdContent=function($content,$local,cls_identifier,text){this.getWmdInput($content,$local,cls_identifier).val(text);return this.getWmdEditor($content,$local,cls_identifier).refreshPreview()};DiscussionUtil.processEachMathAndCode=function(text,processor){var $div,ESCAPED_BACKSLASH,ESCAPED_DOLLAR,RE_DISPLAYMATH,RE_INLINEMATH,cnt,codeArchive,processedText;codeArchive=[];RE_DISPLAYMATH=/^([^\$]*?)\$\$([^\$]*?)\$\$(.*)$/m;RE_INLINEMATH=/^([^\$]*?)\$([^\$]+?)\$(.*)$/m;ESCAPED_DOLLAR="@@ESCAPED_D@@";ESCAPED_BACKSLASH="@@ESCAPED_B@@";processedText="";$div=$("<div>").html(text);$div.find("code").each(function(index,code){codeArchive.push($(code).html());return $(code).html(codeArchive.length-1)});text=$div.html();text=text.replace(/\\\$/g,ESCAPED_DOLLAR);while(true){if(RE_INLINEMATH.test(text)){text=text.replace(RE_INLINEMATH,function($0,$1,$2,$3){processedText+=$1+processor("$"+$2+"$","inline");return $3})}else if(RE_DISPLAYMATH.test(text)){text=text.replace(RE_DISPLAYMATH,function($0,$1,$2,$3){processedText=processor("$$"+$2+"$$","display")+processedText;processedText=$1+processedText;return $3})}else{processedText+=text;break}}text=processedText;text=text.replace(new RegExp(ESCAPED_DOLLAR,"g"),"\\$");text=text.replace(/\\\\\\\\/g,ESCAPED_BACKSLASH);text=text.replace(/\\begin\{([a-z]*\*?)\}([\s\S]*?)\\end\{\1\}/gim,function($0,$1,$2){return processor("\\begin{"+$1+"}"+$2+("\\end{"+$1+"}"))});text=text.replace(new RegExp(ESCAPED_BACKSLASH,"g"),"\\\\\\\\");$div=$("<div>").html(text);cnt=0;$div.find("code").each(function(index,code){$(code).html(processor(codeArchive[cnt],"code"));return cnt+=1});text=$div.html();return text};DiscussionUtil.unescapeHighlightTag=function(text){return text.replace(/\&lt\;highlight\&gt\;/g,"<span class='search-highlight'>").replace(/\&lt\;\/highlight\&gt\;/g,"</span>")};DiscussionUtil.stripHighlight=function(text){return text.replace(/\&(amp\;)?lt\;highlight\&(amp\;)?gt\;/g,"").replace(/\&(amp\;)?lt\;\/highlight\&(amp\;)?gt\;/g,"")};DiscussionUtil.stripLatexHighlight=function(text){return this.processEachMathAndCode(text,this.stripHighlight)};DiscussionUtil.markdownWithHighlight=function(text){var converter;text=text.replace(/^\&gt\;/gm,">");converter=Markdown.getMathCompatibleConverter();text=this.unescapeHighlightTag(this.stripLatexHighlight(converter.makeHtml(text)));return text.replace(/^>/gm,"&gt;")};DiscussionUtil.abbreviateString=function(text,minLength){if(text.length<minLength){return text}else{while(minLength<text.length&&text[minLength]!==" "){minLength++}return text.substr(0,minLength)+gettext("…")}};DiscussionUtil.getPaginationParams=function(curPage,numPages,pageUrlFunc){var delta,maxPage,minPage,pageInfo,params;delta=2;minPage=Math.max(curPage-delta,1);maxPage=Math.min(curPage+delta,numPages);pageInfo=function(pageNum){return{number:pageNum,url:pageUrlFunc(pageNum)}};return params={page:curPage,lowPages:_.range(minPage,curPage).map(pageInfo),highPages:_.range(curPage+1,maxPage+1).map(pageInfo),previous:curPage>1?pageInfo(curPage-1):null,next:curPage<numPages?pageInfo(curPage+1):null,leftdots:minPage>2,rightdots:maxPage<numPages-1,first:minPage>1?pageInfo(1):null,last:maxPage<numPages?pageInfo(numPages):null}};return DiscussionUtil}.call(this)}).call(this);(function(){}).call(this);(function(){var _ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};if(typeof Backbone!=="undefined"&&Backbone!==null){this.DiscussionModuleView=function(_super){__extends(DiscussionModuleView,_super);function DiscussionModuleView(){this.navigateToPage=__bind(this.navigateToPage,this);this.renderPagination=__bind(this.renderPagination,this);this.addThread=__bind(this.addThread,this);this.renderDiscussion=__bind(this.renderDiscussion,this);this.loadPage=__bind(this.loadPage,this);this.toggleDiscussion=__bind(this.toggleDiscussion,this);this.hideDiscussion=__bind(this.hideDiscussion,this);this.toggleNewPost=__bind(this.toggleNewPost,this);_ref=DiscussionModuleView.__super__.constructor.apply(this,arguments);return _ref}DiscussionModuleView.prototype.events={"click .discussion-show":"toggleDiscussion","keydown .discussion-show":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleDiscussion)},"click .new-post-btn":"toggleNewPost","keydown .new-post-btn":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleNewPost)},"click .new-post-cancel":"hideNewPost","click .discussion-paginator a":"navigateToPage"};DiscussionModuleView.prototype.paginationTemplate=function(){return DiscussionUtil.getTemplate("_pagination")};DiscussionModuleView.prototype.page_re=/\?discussion_page=(\d+)/;DiscussionModuleView.prototype.initialize=function(){var match;this.toggleDiscussionBtn=this.$(".discussion-show");match=this.page_re.exec(window.location.href);if(match){return this.page=parseInt(match[1])}else{return this.page=1}};DiscussionModuleView.prototype.toggleNewPost=function(event){event.preventDefault();if(!this.newPostForm){this.toggleDiscussion();this.isWaitingOnNewPost=true;return}if(this.showed){this.newPostForm.slideDown(300)}else{this.newPostForm.show()}this.toggleDiscussionBtn.addClass("shown");this.toggleDiscussionBtn.find(".button-text").html(gettext("Hide Discussion"));this.$("section.discussion").slideDown();return this.showed=true};DiscussionModuleView.prototype.hideNewPost=function(event){event.preventDefault();return this.newPostForm.slideUp(300)};DiscussionModuleView.prototype.hideDiscussion=function(){this.$("section.discussion").slideUp();this.toggleDiscussionBtn.removeClass("shown");this.toggleDiscussionBtn.find(".button-text").html(gettext("Show Discussion"));return this.showed=false};DiscussionModuleView.prototype.toggleDiscussion=function(event){var $elem,_this=this;if(this.showed){return this.hideDiscussion()}else{this.toggleDiscussionBtn.addClass("shown");this.toggleDiscussionBtn.find(".button-text").html(gettext("Hide Discussion"));if(this.retrieved){this.$("section.discussion").slideDown();return this.showed=true}else{$elem=this.toggleDiscussionBtn;return this.loadPage($elem,function(){_this.hideDiscussion();return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the discussion. Please try again."))})}}};DiscussionModuleView.prototype.loadPage=function($elem,error){var discussionId,url,_this=this;discussionId=this.$el.data("discussion-id");url=DiscussionUtil.urlFor("retrieve_discussion",discussionId)+("?page="+this.page);return DiscussionUtil.safeAjax({$elem:$elem,$loading:$elem,takeFocus:true,url:url,type:"GET",dataType:"json",success:function(response,textStatus,jqXHR){return _this.renderDiscussion($elem,response,textStatus,discussionId)},error:error})};DiscussionModuleView.prototype.renderDiscussion=function($elem,response,textStatus,discussionId){var $discussion,allow_anonymous,allow_anonymous_to_peers,cohorts,source;$elem.focus();window.user=new DiscussionUser(response.user_info);Content.loadContentInfos(response.annotated_content_info);DiscussionUtil.loadRoles(response.roles);allow_anonymous=response.allow_anonymous;allow_anonymous_to_peers=response.allow_anonymous_to_peers;cohorts=response.cohorts;this.discussion=new Discussion;this.discussion.reset(response.discussion_data,{silent:false});if(response.is_cohorted){source="script#_inline_discussion_cohorted"}else{source="script#_inline_discussion"}$discussion=$(Mustache.render($(source).html(),{threads:response.discussion_data,discussionId:discussionId,allow_anonymous_to_peers:allow_anonymous_to_peers,allow_anonymous:allow_anonymous,cohorts:cohorts}));if(this.$("section.discussion").length){this.$("section.discussion").replaceWith($discussion)}else{this.$el.append($discussion)}this.newPostForm=$(".new-post-article");this.threadviews=this.discussion.map(function(thread){return new DiscussionThreadInlineView({el:this.$("article#thread_"+thread.id),model:thread})});_.each(this.threadviews,function(dtv){return dtv.render()});DiscussionUtil.bulkUpdateContentInfo(window.$$annotated_content_info);this.newPostView=new NewPostInlineView({el:this.$(".new-post-article"),collection:this.discussion});this.discussion.on("add",this.addThread);this.retrieved=true;this.showed=true;this.renderPagination(response.num_pages);if(this.isWaitingOnNewPost){return this.newPostForm.show()}};DiscussionModuleView.prototype.addThread=function(thread,collection,options){var article,threadView;article=$("<article class='discussion-thread' id='thread_"+thread.id+"'></article>");this.$("section.discussion > .threads").prepend(article);threadView=new DiscussionThreadInlineView({el:article,model:thread});threadView.render();return this.threadviews.unshift(threadView)};DiscussionModuleView.prototype.renderPagination=function(numPages){var pageUrl,params,thing;pageUrl=function(number){return"?discussion_page="+number};params=DiscussionUtil.getPaginationParams(this.page,numPages,pageUrl);thing=Mustache.render(this.paginationTemplate(),params);return this.$("section.pagination").html(thing)};DiscussionModuleView.prototype.navigateToPage=function(event){var currPage,_this=this;event.preventDefault();window.history.pushState({},window.document.title,event.target.href);currPage=this.page;this.page=$(event.target).data("page-number");return this.loadPage($(event.target),function(){_this.page=currPage;return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the threads you requested. Please try again."))})};return DiscussionModuleView}(Backbone.View)}}).call(this);
//# sourceMappingURL=/static/discussion-xblock.e39af9e3105d.min.map